
<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lulla - Medical Admin Templates & Dashboards</title>

    <!-- Meta -->
    <meta name="description" content="Marketplace for Bootstrap Admin Dashboards">
    <meta property="og:title" content="Admin Templates - Dashboard Templates">
    <meta property="og:description" content="Marketplace for Bootstrap Admin Dashboards">
    <meta property="og:type" content="Website">
    <link rel="shortcut icon" href="assets/images/favicon.svg">

    <!-- *************
		************ CSS Files *************
	************* -->
    <link rel="stylesheet" href="assets/css/remixicon.css">
    <link rel="stylesheet" href="assets/css/main.min.css">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <!-- Air Datepicker CSS -->
    <link href="https://cdn.jsdelivr.net/npm/air-datepicker@3.4.0/air-datepicker.css" rel="stylesheet" />
    

    
    <!-- Theme Color Override -->
    <style>
      :root {
        --logo-flow: #15696B;
        --bs-primary: var(--logo-flow);
        --bs-primary-rgb: 21, 105, 107;
        --bs-link-color: var(--logo-flow);
        --bs-link-hover-color: #0F4449;
      }
      
      .app-header {
         background-color: white !important;
       }
      
      /* Export Icons Styling */
      .export-icons-container {
        display: flex;
        gap: 8px;
        justify-content: center;
        align-items: center;
        height: 38px;
      }
      
      .export-icon-btn {
        background: none;
        border: 1px solid #ccc;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.3em;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 38px;
        height: 38px;
      }
      
      .export-excel-btn i {
        color: #00a651;
      }
      
      .export-pdf-btn i {
        color: #d32f2f;
      }
      
      .export-icon-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      
      .export-excel-btn:hover {
        border-color: #00a651;
        background-color: rgba(0, 166, 81, 0.05);
      }
      
      .export-pdf-btn:hover {
        border-color: #d32f2f;
        background-color: rgba(211, 47, 47, 0.05);
      }
      
      /* Select2 Custom Styling */
      .select2-container--default .select2-dropdown {
        border-color: #ced4da;
        border-radius: 0.25rem;
      }
      
      .select2-container--default .select2-results > .select2-results__options {
        max-height: 250px;
      }
      
      .select2-container--default .select2-results__option {
        padding: 10px;
        text-align: left !important;
      }
      
      .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #15696B;
      }
      
      .select2-container--default.select2-container--open .select2-selection--single {
        border-color: #15696B;
      }
      
      .select2-container--default .select2-selection--single {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        height: 38px;
        padding: 0 !important;
      }
      
      .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #495057;
        line-height: 36px;
        text-align: left !important;
        padding-left: 12px !important;
      }
      
      .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
        right: 0 !important;
        width: 32px;
      }
      
      .select2-container--default .select2-selection--single .select2-selection__arrow b {
        margin-top: -6px !important;
      }
      
      /* Wrapper alignment */
      .select2-container {
        width: 100% !important;
      }
      
      .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #15696B;
        box-shadow: 0 0 0 0.2rem rgba(21, 105, 107, 0.25);
      }
      
      /* SweetAlert2 modal adjustments for Select2 */
      .swal2-html-container {
        overflow: visible !important;
      }
      
      .swal2-popup {
        overflow: visible !important;
        z-index: 1055 !important;
      }
      
      .swal2-container {
        z-index: 1050 !important;
      }
      
      /* Ensure action buttons appear below dropdown */
      .swal2-actions {
        z-index: auto !important;
        position: relative;
      }
      
      /* Select2 dropdown styling */
      .select2-dropdown {
        z-index: 10000 !important;
        margin-top: 5px;
        position: absolute !important;
      }
      
      .select2-dropdown--above {
        margin-top: 0;
        margin-bottom: 5px;
      }
      
      .select2-dropdown--below {
        margin-top: 5px;
      }
      
      .select2-results {
        max-height: 250px !important;
        overflow-y: auto !important;
      }
      
      .select2-container--open {
        z-index: 999999 !important;
      }
      
      .swal2-html-container select.form-control {
        margin-bottom: 0;
      }
      
      /* Air Datepicker styling */
      .air-datepicker {
        z-index: 10000 !important;
      }
      
      .air-datepicker-input {
        width: 100%;
      }
      
      /* Wizard Form Button Styling */
      .wizard-btn {
        padding: 10px 24px;
        font-weight: 500;
        font-size: 14px;
        border-radius: 0.35rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 100px;
      }
      
      .wizard-btn-primary {
        background-color: #15696B;
        color: white;
        border: 1px solid #15696B;
      }
      
      .wizard-btn-primary:hover {
        background-color: #0F4449;
        border-color: #0F4449;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(21, 105, 107, 0.3);
      }
      
      .wizard-btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(21, 105, 107, 0.2);
      }
      
      .wizard-btn-success {
        background-color: #28a745;
        color: white;
        border: 1px solid #28a745;
      }
      
      .wizard-btn-success:hover {
        background-color: #218838;
        border-color: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
      }
      
      .wizard-btn-success:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2);
      }
      
      .wizard-btn-secondary {
        background-color: #6c757d;
        color: white;
        border: 1px solid #6c757d;
      }
      
      .wizard-btn-secondary:hover {
        background-color: #5a6268;
        border-color: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
      }
      
      .wizard-btn-secondary:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(108, 117, 125, 0.2);
      }
      
      .wizard-btn-outline {
        background-color: transparent;
        color: #15696B;
        border: 1.5px solid #15696B;
      }
      
      .wizard-btn-outline:hover {
        background-color: #f0f5f5;
        border-color: #0F4449;
        color: #0F4449;
        transform: translateY(-2px);
      }
      
      .wizard-btn-outline:active {
        transform: translateY(0);
      }
      
      .wizard-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .wizard-btn:disabled:hover {
        background-color: inherit;
        border-color: inherit;
        transform: none;
        box-shadow: none;
      }
      </style>

    <!-- *************
		************ Vendor Css Files *************
	************ -->

    <!-- Scrollbar CSS -->
    <link rel="stylesheet" href="assets/css/OverlayScrollbars.min.css">
  </head>

  <body>

    <!-- Loading starts -->
    <div id="loading-wrapper">
      <div class='spin-wrapper'>
        <div class='spin'>
          <div class='inner'></div>
        </div>
        <div class='spin'>
          <div class='inner'></div>
        </div>
        <div class='spin'>
          <div class='inner'></div>
        </div>
        <div class='spin'>
          <div class='inner'></div>
        </div>
        <div class='spin'>
          <div class='inner'></div>
        </div>
        <div class='spin'>
          <div class='inner'></div>
        </div>
      </div>
    </div>
    <!-- Loading ends -->

    <!-- Page wrapper starts -->
    <div class="page-wrapper">

      <!-- App header starts -->
      <div class="app-header d-flex align-items-center">

        <!-- Toggle buttons starts -->
        <div class="d-flex">
          <button class="toggle-sidebar">
            <i class="ri-menu-line"></i>
          </button>
          <button class="pin-sidebar">
            <i class="ri-menu-line"></i>
          </button>
        </div>
        <!-- Toggle buttons ends -->

        <!-- App brand starts -->
        <div class="app-brand ms-3">
          <a href="index.html" class="d-lg-block d-none">
            <img src="logo/logo.svg" class="logo" alt="HealthFlow Admin Template">
          </a>
          <a href="index.html" class="d-lg-none d-md-block">
            <img src="logo/logo.svg" class="logo" alt="HealthFlow Admin Template">
          </a>
        </div>
        <!-- App brand ends -->

        <!-- App header actions starts -->
        <div class="header-actions">

          <!-- Search container starts -->
          <div class="search-container d-lg-block d-none mx-3">
            <input type="text" class="form-control" id="searchId" placeholder="Search">
            <i class="ri-search-line"></i>
          </div>
          <!-- Search container ends -->

          <!-- Header actions starts -->
          <div class="d-lg-flex d-none gap-2">

            <!-- Select country dropdown starts -->
            <div class="dropdown">
              <a class="dropdown-toggle header-icon" href="#!" role="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                <img src="assets/images/flags/1x1/fr.svg" class="header-country-flag" alt="Bootstrap Dashboards">
              </a>
              <div class="dropdown-menu dropdown-menu-end dropdown-mini">
                <div class="country-container">
                  <a href="index.html" class="py-2">
                    <img src="assets/images/flags/1x1/us.svg" alt="Admin Panel">
                  </a>
                  <a href="index.html" class="py-2">
                    <img src="assets/images/flags/1x1/in.svg" alt="Admin Panels">
                  </a>
                  <a href="index.html" class="py-2">
                    <img src="assets/images/flags/1x1/br.svg" alt="Admin Dashboards">
                  </a>
                  <a href="index.html" class="py-2">
                    <img src="assets/images/flags/1x1/tr.svg" alt="Admin Templatess">
                  </a>
                  <a href="index.html" class="py-2">
                    <img src="assets/images/flags/1x1/gb.svg" alt="Google Admin">
                  </a>
                </div>
              </div>
            </div>
            <!-- Select country dropdown ends -->

            <!-- Notifications dropdown starts -->
            <div class="dropdown">
              <a class="dropdown-toggle header-icon" href="#!" role="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="ri-list-check-3"></i>
                <span class="count-label warning"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-end dropdown-300">
                <h5 class="fw-semibold px-3 py-2 text-primary">Activity</h5>

                <!-- Scroll starts -->
                <div class="scroll300">

                  <!-- Activity List Starts -->
                  <div class="p-3">
                    <ul class="p-0 activity-list2">
                      <li class="activity-item pb-3 mb-3">
                        <a href="#!">
                          <h5 class="fw-regular">
                            <i class="ri-circle-fill text-danger me-1"></i>
                            Invoices.
                          </h5>
                          <div class="ps-3 ms-2 border-start">
                            <div class="d-flex align-items-center mb-2">
                              <div class="flex-shrink-0">
                                <img src="assets/images/products/1.jpg" class="img-shadow img-3x rounded-1"
                                  alt="Hospital Admin Templates">
                              </div>
                              <div class="flex-grow-1 ms-3">
                                23 invoices have been paid to the MediCare Labs.
                              </div>
                            </div>
                            <p class="m-0 small">10:20AM Today</p>
                          </div>
                        </a>
                      </li>
                      <li class="activity-item pb-3 mb-3">
                        <a href="#!">
                          <h5 class="fw-regular">
                            <i class="ri-circle-fill text-info me-1"></i>
                            Purchased.
                          </h5>
                          <div class="ps-3 ms-2 border-start">
                            <div class="d-flex align-items-center mb-2">
                              <div class="flex-shrink-0">
                                <img src="assets/images/products/2.jpg" class="img-shadow img-3x rounded-1"
                                  alt="Hospital Admin Templates">
                              </div>
                              <div class="flex-grow-1 ms-3">
                                28 new surgical equipments have been purchased.
                              </div>
                            </div>
                            <p class="m-0 small">04:30PM Today</p>
                          </div>
                        </a>
                      </li>
                      <li class="activity-item pb-3 mb-3">
                        <a href="#!">
                          <h5 class="fw-regular">
                            <i class="ri-circle-fill text-success me-1"></i>
                            Appointed.
                          </h5>
                          <div class="ps-3 ms-2 border-start">
                            <div class="d-flex align-items-center mb-2">
                              <div class="flex-shrink-0">
                                <img src="assets/images/products/8.jpg" class="img-shadow img-3x rounded-1"
                                  alt="Hospital Admin Templates">
                              </div>
                              <div class="flex-grow-1 ms-3">
                                36 new doctors and 28 staff members appointed.
                              </div>
                            </div>
                            <p class="m-0 small">06:50PM Today</p>
                          </div>
                        </a>
                      </li>
                      <li class="activity-item">
                        <a href="#!">
                          <h5 class="fw-regular">
                            <i class="ri-circle-fill text-warning me-1"></i>
                            Requested
                          </h5>
                          <div class="ps-3 ms-2 border-start">
                            <div class="d-flex align-items-center mb-2">
                              <div class="flex-shrink-0">
                                <img src="assets/images/products/9.jpg" class="img-shadow img-3x rounded-1"
                                  alt="Hospital Admin Templates">
                              </div>
                              <div class="flex-grow-1 ms-3">
                                Requested for 6 new vehicles for medical emergency. .
                              </div>
                            </div>
                            <p class="m-0 small">08:30PM Today</p>
                          </div>
                        </a>
                      </li>
                    </ul>
                  </div>
                  <!-- Activity List Ends -->

                </div>
                <!-- Scroll ends -->

                <!-- View all button starts -->
                <div class="d-grid m-3">
                  <a href="javascript:void(0)" class="btn btn-primary">View all</a>
                </div>
                <!-- View all button ends -->

              </div>
            </div>
            <!-- Notifications dropdown ends -->

            <!-- Notifications dropdown starts -->
            <div class="dropdown">
              <a class="dropdown-toggle header-icon" href="#!" role="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="ri-alarm-warning-line"></i>
                <span class="count-label success"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-end dropdown-300">
                <h5 class="fw-semibold px-3 py-2 text-primary">Alerts</h5>

                <!-- Scroll starts -->
                <div class="scroll300">

                  <!-- Alert list starts -->
                  <div class="p-3">
                    <div class="d-flex py-2">
                      <div class="icon-box md bg-info rounded-circle me-3">
                        <span class="fw-bold fs-6 text-white">DS</span>
                      </div>
                      <div class="m-0">
                        <h6 class="mb-1 fw-semibold">Douglass Shaw</h6>
                        <p class="mb-1">
                          Appointed as a new President 2014-2025
                        </p>
                        <p class="small m-0 opacity-50">Today, 07:30pm</p>
                      </div>
                    </div>
                    <div class="d-flex py-2">
                      <div class="icon-box md bg-danger rounded-circle me-3">
                        <span class="fw-bold fs-6 text-white">WG</span>
                      </div>
                      <div class="m-0">
                        <h6 class="mb-1 fw-semibold">Willie Garrison</h6>
                        <p class="mb-1">
                          Congratulate, James for new job.
                        </p>
                        <p class="small m-0 opacity-50">Today, 08:00pm</p>
                      </div>
                    </div>
                    <div class="d-flex py-2">
                      <div class="icon-box md bg-warning rounded-circle me-3">
                        <span class="fw-bold fs-6 text-white">TJ</span>
                      </div>
                      <div class="m-0">
                        <h6 class="mb-1 fw-semibold">Terry Jenkins</h6>
                        <p class="mb-1">
                          Lewis added new doctors training schedule.
                        </p>
                        <p class="small m-0 opacity-50">Today, 09:30pm</p>
                      </div>
                    </div>
                  </div>
                  <!-- Alert list ends -->

                </div>
                <!-- Scroll ends -->

                <!-- View all button starts -->
                <div class="d-grid m-3">
                  <a href="javascript:void(0)" class="btn btn-primary">View all</a>
                </div>
                <!-- View all button ends -->

              </div>
            </div>
            <!-- Notifications dropdown ends -->

            <!-- Messages dropdown starts -->
            <div class="dropdown">
              <a class="dropdown-toggle header-icon" href="#!" role="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="ri-message-3-line"></i>
                <span class="count-label"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-end dropdown-300">
                <h5 class="fw-semibold px-3 py-2 text-primary">Messages</h5>

                <!-- Scroll starts -->
                <div class="scroll300">

                  <!-- Messages list starts -->
                  <div class="p-3">
                    <div class="d-flex py-2">
                      <img src="assets/images/user3.png" class="img-shadow img-3x me-3 rounded-5"
                        alt="Hospital Admin Templates">
                      <div class="m-0">
                        <h6 class="mb-1 fw-semibold">LOHDA BABBU</h6>
                        <p class="mb-1">
                          Appointed as a new President 2014-2025
                        </p>
                        <p class="small m-0 opacity-50">Today, 07:30pm</p>
                      </div>
                    </div>
                    <div class="d-flex py-2">
                      <img src="assets/images/user1.png" class="img-shadow img-3x me-3 rounded-5"
                        alt="Hospital Admin Templates">
                      <div class="m-0">
                        <h6 class="mb-1 fw-semibold">Clyde Fowler</h6>
                        <p class="mb-1">
                          Congratulate, James for new job.
                        </p>
                        <p class="small m-0 opacity-50">Today, 08:00pm</p>
                      </div>
                    </div>
                    <div class="d-flex py-2">
                      <img src="assets/images/user4.png" class="img-shadow img-3x me-3 rounded-5"
                        alt="Hospital Admin Templates">
                      <div class="m-0">
                        <h6 class="mb-1 fw-semibold">Sophie Michiels</h6>
                        <p class="mb-1">
                          Lewis added new doctors training schedule.
                        </p>
                        <p class="small m-0 opacity-50">Today, 09:30pm</p>
                      </div>
                    </div>
                  </div>
                  <!-- Messages list ends -->

                </div>
                <!-- Scroll ends -->

                <!-- View all button starts -->
                <div class="d-grid m-3">
                  <a href="javascript:void(0)" class="btn btn-primary">View all</a>
                </div>
                <!-- View all button ends -->

              </div>
            </div>
          </div>
          <!-- Header actions ends -->

          <!-- Header user settings starts -->
          <div class="dropdown ms-2">
            <a id="userSettings" class="dropdown-toggle d-flex align-items-center" href="#!" role="button"
              data-bs-toggle="dropdown" aria-expanded="false">
              <div class="avatar-box"><span id="userInitials">--</span><span class="status busy"></span></div>
            </a>
            <div class="dropdown-menu dropdown-menu-end shadow-lg">
              <div class="px-3 py-2">
                <span class="small" id="userRole">User</span>
                <h6 class="m-0" id="userName">Loading...</h6>
              </div>
              <div class="mx-3 my-2 d-grid">
                <button id="logoutBtn" class="btn btn-danger">Logout</button>
              </div>
            </div>
          </div>
          <!-- Header user settings ends -->

        </div>
        <!-- App header actions ends -->

      </div>
      <!-- App header ends -->
      <!-- Main container starts -->
      <div class="main-container">
        <!-- Sidebar wrapper starts -->
        <nav id="sidebar" class="sidebar-wrapper">
          <!-- Sidebar profile starts -->
          <div class="sidebar-profile">
            <img src="assets/images/user6.png" class="img-shadow img-3x me-3 rounded-5" alt="Hospital Admin Templates">
            <div class="m-0">
              <h5 class="mb-1 profile-name text-nowrap text-truncate" id="sidebarUserName">Loading...</h5>
              <p class="m-0 small profile-name text-nowrap text-truncate" id="sidebarUserRole">User</p>
            </div>
          </div>
          <!-- Sidebar profile ends -->

          <!-- Sidebar menu starts -->
          <div class="sidebarMenuScroll">
            <ul class="sidebar-menu">
              <li class="active current-page">
                <a href="index.html">
                  <i class="ri-home-6-line"></i>
                  <span class="menu-text">Hospital Dashboard</span>
                </a>
              </li>
              
            

              <li class="treeview">
                <a href="#!">
                  <i class="ri-heart-pulse-line"></i>
                  <span class="menu-text">Patients</span>
                </a>
                <ul class="treeview-menu">
                  <li>
                    <a href="#">Patients Dashboard</a>
                  </li>
                  <li>
                    <a href="#">Patients List</a>
                  </li>
                  <li>
                    <a href="#">Add Patient</a>
                  </li>
                  <li>
                    <a href="#">Edit Patient Details</a>
                  </li>
                </ul>
              </li>
              <li class="treeview">
                <a href="#!">
                  <i class="ri-nurse-line"></i>
                  <span class="menu-text">Staff</span>
                </a>
                <ul class="treeview-menu">
                  <li>
                    <a href="#">Staff List</a>
                  </li>
                  <li>
                    <a href="#">Add Staff</a>
                  </li>
                  <li>
                    <a href="#">Edit Staff Details</a>
                  </li>
                </ul>
              </li>
              <li class="treeview">
                <a href="#!">
                  <i class="ri-dossier-line"></i>
                  <span class="menu-text">Appointments</span>
                </a>
                <ul class="treeview-menu">
                  <li>
                    <a href="#">Appointments</a>
                  </li>
                  <li>
                    <a href="#">Appointments List</a>
                  </li>
                  <li>
                    <a href="#">Book Appointment</a>
                  </li>
                  <li>
                    <a href="#">Edit Appointment</a>
                  </li>
                </ul>
              </li>

              <li class="treeview">
                <a href="#!">
                  <i class="ri-secure-payment-line"></i>
                  <span class="menu-text">Accounts</span>
                </a>
                <ul class="treeview-menu">
                  <li>
                    <a href="#">Income</a>
                  </li>
                  <li>
                    <a href="#">Payments</a>
                  </li>
                  
                </ul>
              </li>



             




              <li class="treeview">
                <a href="#!">
                  <i class="ri-login-circle-line"></i>
                  <span class="menu-text">Login/Signup</span>
                </a>
                <ul class="treeview-menu">
                  <li>
                    <a href="#">Login</a>
                  </li>
                  <li>
                    <a href="#">Signup</a>
                  </li>
                  <li>
                    <a href="#">Forgot Password</a>
                  </li>
                  <li>
                    <a href="#">Reset Password</a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="#">
                  <i class="ri-alert-line"></i>
                  <span class="menu-text">Page Not Found</span>
                </a>
              </li>



            </ul>
          </div>
          <!-- Sidebar menu ends -->

          <!-- Sidebar contact starts -->
          <div class="sidebar-contact">
            <p class="fw-light mb-1 text-nowrap text-truncate">Emergency Contact</p>
            <h5 class="m-0 lh-1 text-nowrap text-truncate">0987654321</h5>
            <i class="ri-phone-line"></i>
          </div>
          <!-- Sidebar contact ends -->

        </nav>
        <!-- Sidebar wrapper ends -->

        <!-- App container starts -->
        <div class="app-container">

          <!-- App hero header starts -->
          <div class="app-hero-header d-flex align-items-center">

            <!-- Breadcrumb starts -->
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <i class="ri-home-8-line lh-1 pe-3 me-3 border-end"></i>
                <a href="index.html">Home</a>
              </li>
              <li class="breadcrumb-item text-primary" aria-current="page">
                Dashboard
              </li>
            </ol>
            <!-- Breadcrumb ends -->

            <!-- Sales stats starts -->
            <div class="ms-auto d-lg-flex d-none flex-row">
              <div class="d-flex flex-row gap-1 day-sorting">
                <button class="btn btn-sm btn-primary">Today</button>
                <button class="btn btn-sm">7d</button>
                <button class="btn btn-sm">2w</button>
                <button class="btn btn-sm">1m</button>
                <button class="btn btn-sm">3m</button>
                <button class="btn btn-sm">6m</button>
                <button class="btn btn-sm">1y</button>
              </div>
            </div>
            <!-- Sales stats ends -->

          </div>
          <!-- App Hero header ends -->

          <!-- App body starts -->
          <div class="app-body">

            <!-- Row starts -->
            <div class="row gx-3">
              <div class="col-xxl-12 col-sm-12">
                <div class="card mb-3 bg-2">
                  <div class="card-body">
                    <div class="py-4 px-3 text-white">
                      <h6 id="greetingTime">Good Morning,</h6>
                      <h2 id="greetingUserName">Loading...</h2>
                      <h5>Your schedule today.</h5>
                      <div class="mt-4 d-flex gap-3">
                        <div class="d-flex align-items-center">
                          <div class="icon-box lg bg-arctic rounded-3 me-3">
                            <i class="ri-surgical-mask-line fs-4"></i>
                          </div>
                          <div class="d-flex flex-column">
                            <h2 class="m-0 lh-1" id="patientsCount">0</h2>
                            <p class="m-0">Patients</p>
                          </div>
                        </div>
                        <div class="d-flex align-items-center">
                          <div class="icon-box lg bg-lime rounded-3 me-3">
                            <i class="ri-calendar-todo-line fs-4"></i>
                          </div>
                          <div class="d-flex flex-column">
                            <h2 class="m-0 lh-1" id="appointmentsCount">0</h2>
                            <p class="m-0">Appointments</p>
                          </div>
                        </div>
                        <div class="d-flex align-items-center">
                          <div class="icon-box lg bg-peach rounded-3 me-3">
                            <i class="ri-alert-line fs-4"></i>
                          </div>
                          <div class="d-flex flex-column">
                            <h2 class="m-0 lh-1" id="criticalPatientsCount">0</h2>
                            <p class="m-0">Critical Patients</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Row ends -->

            <!-- Row starts -->
            <div class="row gx-3">
              <div class="col-xl-3 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="p-2 border border-success rounded-circle me-3">
                        <div class="icon-box md bg-success-subtle rounded-5">
                          <i class="ri-surgical-mask-line fs-4 text-success"></i>
                        </div>
                      </div>
                      <div class="d-flex flex-column">
                        <h2 class="lh-1" id="newPatientCount">0</h2>
                        <p class="m-0">New Patients</p>
                      </div>
                    </div>
                    <div class="d-flex align-items-end justify-content-between mt-1">
                      <a class="text-success" href="javascript:void(0);">
                        <span>View All</span>
                        <i class="ri-arrow-right-line text-success ms-1"></i>
                      </a>
                      <div class="text-end">
                        <p class="mb-0 text-success">+40%</p>
                        <span class="badge bg-success-subtle text-success small">this month</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="p-2 border border-info rounded-circle me-3">
                        <div class="icon-box md bg-info-subtle rounded-5">
                          <i class="ri-user-follow-line fs-4 text-info"></i>
                        </div>
                      </div>
                      <div class="d-flex flex-column">
                        <h2 class="lh-1" id="returnPatientCount">0</h2>
                        <p class="m-0">Return Patients</p>
                      </div>
                    </div>
                    <div class="d-flex align-items-end justify-content-between mt-1">
                      <a class="text-info" href="javascript:void(0);">
                        <span>View All</span>
                        <i class="ri-arrow-right-line text-info ms-1"></i>
                      </a>
                      <div class="text-end">
                        <p class="mb-0 text-info">+25%</p>
                        <span class="badge bg-info-subtle text-info small">this month</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="p-2 border border-primary rounded-circle me-3">
                        <div class="icon-box md bg-primary-subtle rounded-5">
                          <i class="ri-lungs-line fs-4 text-primary"></i>
                        </div>
                      </div>
                      <div class="d-flex flex-column">
                        <h2 class="lh-1">360</h2>
                        <p class="m-0">OPD Patients</p>
                      </div>
                    </div>
                    <div class="d-flex align-items-end justify-content-between mt-1">
                      <a class="text-primary" href="javascript:void(0);">
                        <span>View All</span>
                        <i class="ri-arrow-right-line ms-1"></i>
                      </a>
                      <div class="text-end">
                        <p class="mb-0 text-primary">+30%</p>
                        <span class="badge bg-primary-subtle text-primary small">this month</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="p-2 border border-danger rounded-circle me-3">
                        <div class="icon-box md bg-danger-subtle rounded-5">
                          <i class="ri-microscope-line fs-4 text-danger"></i>
                        </div>
                      </div>
                      <div class="d-flex flex-column">
                        <h2 class="lh-1">980</h2>
                        <p class="m-0">Lab tests</p>
                      </div>
                    </div>
                    <div class="d-flex align-items-end justify-content-between mt-1">
                      <a class="text-danger" href="javascript:void(0);">
                        <span>View All</span>
                        <i class="ri-arrow-right-line ms-1"></i>
                      </a>
                      <div class="text-end">
                        <p class="mb-0 text-danger">+60%</p>
                        <span class="badge bg-danger-subtle text-danger small">this month</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
            <!-- Row ends -->

            <!-- Row starts -->
            <div class="row gx-3">
              <div class="col-xl-2 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex flex-column align-items-center">
                      <div class="icon-box md rounded-5 bg-primary mb-3">
                        <i class="ri-verified-badge-line fs-4 lh-1"></i>
                      </div>
                      <h6>Appointments</h6>
                      <h2 class="text-primary m-0" id="totalAppointmentsCount">0</h2>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-2 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex flex-column align-items-center">
                      <div class="icon-box md rounded-5 bg-primary mb-3">
                        <i class="ri-stethoscope-line fs-4 lh-1"></i>
                      </div>
                      <h6>Doctors</h6>
                      <h2 class="text-primary m-0">83</h2>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-2 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex flex-column align-items-center">
                      <div class="icon-box md rounded-5 bg-primary mb-3">
                        <i class="ri-psychotherapy-line fs-4 lh-1"></i>
                      </div>
                      <h6>Staff</h6>
                      <h2 class="text-primary m-0">296</h2>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-2 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex flex-column align-items-center">
                      <div class="icon-box md rounded-5 bg-primary mb-3">
                        <i class="ri-lungs-line fs-4 lh-1"></i>
                      </div>
                      <h6>Operations</h6>
                      <h2 class="text-primary m-0">49</h2>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-2 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex flex-column align-items-center">
                      <div class="icon-box md rounded-5 bg-primary mb-3">
                        <i class="ri-hotel-bed-line fs-4 lh-1"></i>
                      </div>
                      <h6>Admitted</h6>
                      <h2 class="text-primary m-0">372</h2>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-2 col-sm-6 col-12">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex flex-column align-items-center">
                      <div class="icon-box md rounded-5 bg-primary mb-3">
                        <i class="ri-walk-line fs-4 lh-1"></i>
                      </div>
                      <h6>Discharged</h6>
                      <h2 class="text-primary m-0">253</h2>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Row ends -->

            <!-- Row starts -->
            <div class="row gx-3">
              <div class="col-xxl-12 col-sm-12">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">All Patients</h5>
                  </div>
                  <div class="card-body">
                    <!-- Search, Filter, Export Controls -->
                    <div class="row mb-3 g-2">
                      <div class="col-12 col-sm-6 col-md-4">
                        <input type="text" class="form-control form-control-sm" id="patientSearchInput" placeholder="Search patients...">
                      </div>
                      <div class="col-12 col-sm-6 col-md-3">
                        <select class="form-select form-select-sm" id="patientConditionFilter">
                          <option value="">All Conditions</option>
                          <option value="HIV">HIV</option>
                          <option value="Diabetes">Diabetes</option>
                          <option value="Hypertension">Hypertension</option>
                          <option value="TB">TB</option>
                        </select>
                      </div>
                      <div class="col-12 col-sm-6 col-md-3">
                        <select class="form-select form-select-sm" id="patientStatusFilter">
                          <option value="">All Status</option>
                          <option value="Active">Active</option>
                          <option value="Inactive">Inactive</option>
                          <option value="Critical">Critical</option>
                          <option value="Alert">Alert</option>
                        </select>
                      </div>
                      <div class="col-12 col-sm-6 col-md-2">
                       <div class="export-icons-container">
                         <button class="export-icon-btn" style="border-color: #15696B; background-color: rgba(21, 105, 107, 0.05);" title="Add Patient" onclick="addNewPatient()">
                           <i class="ri-add-line" style="color: #15696B;"></i>
                         </button>
                         <button class="export-icon-btn export-excel-btn" title="Export to Excel" onclick="exportPatientsToExcel()">
                           <i class="ri-file-excel-2-line"></i>
                         </button>
                         <button class="export-icon-btn export-pdf-btn" title="Export to PDF" onclick="exportPatientsToPDF()">
                           <i class="ri-file-pdf-fill"></i>
                         </button>
                       </div>
                      </div>
                    </div>
                    
                    <!-- Responsive Table with Horizontal Scroll on Mobile -->
                    <div class="table-responsive">
                      <table class="table table-hover table-sm patients-table">
                        <thead>
                           <tr>
                             <th>Patient ID</th>
                             <th>Name</th>
                             <th>Age</th>
                             <th>Gender</th>
                             <th>Phone</th>
                             <th>Address</th>
                             <th>Condition</th>
                             <th>Status</th>
                             <th>HIV Status</th>
                             <th>Notes</th>
                             <th>Actions</th>
                           </tr>
                         </thead>
                        <tbody id="patientsTableBody">
                          <tr>
                            <td colspan="8" class="text-center">Loading patients...</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <!-- Pagination Controls -->
                    <nav aria-label="Patient table pagination" class="mt-3">
                      <ul class="pagination pagination-sm justify-content-center" id="patientsPagination">
                        <li class="page-item">
                          <button class="page-link" id="prevPageBtn" onclick="previousPatientPage()">
                            <i class="ri-arrow-left-s-line"></i> <span class="d-none d-sm-inline">Prev</span>
                          </button>
                        </li>
                        <li class="page-item active" id="pageInfoLi">
                          <span class="page-link" id="pageInfo">Page 1</span>
                        </li>
                        <li class="page-item">
                          <button class="page-link" id="nextPageBtn" onclick="nextPatientPage()">
                            <span class="d-none d-sm-inline">Next</span> <i class="ri-arrow-right-s-line"></i>
                          </button>
                        </li>
                      </ul>
                    </nav>
                    <div class="text-center">
                      <small class="text-muted" id="patientCountInfo">Showing 0 of 0 patients</small>
                    </div>

                    <!-- Responsive Table CSS -->
                    <style>
                      /* Horizontal scroll on mobile devices */
                      @media (max-width: 767.98px) {
                        .table-responsive {
                          overflow-x: auto;
                          -webkit-overflow-scrolling: touch;
                          overflow-y: hidden;
                        }
                        
                        .patients-table {
                          min-width: 800px;
                          font-size: 0.85rem;
                          margin-bottom: 0;
                        }
                        
                        .patients-table thead {
                          position: sticky;
                          top: 0;
                          background-color: #f8f9fa;
                          z-index: 10;
                        }
                        
                        .patients-table th {
                          padding: 0.75rem 0.5rem !important;
                          white-space: nowrap;
                          font-weight: 600;
                          border-bottom: 2px solid #dee2e6;
                        }
                        
                        .patients-table td {
                          padding: 0.5rem !important;
                          white-space: nowrap;
                        }
                        
                        .badge {
                          font-size: 0.7rem;
                          padding: 0.35rem 0.5rem;
                        }
                      }

                      /* Table adjustments for tablets and above */
                      @media (min-width: 768px) {
                        .patients-table {
                          font-size: 0.95rem;
                        }
                        
                        .patients-table th,
                        .patients-table td {
                          padding: 0.75rem !important;
                        }
                      }

                      /* Standard scrollbar styling for mobile scroll */
                      .table-responsive {
                        scrollbar-width: thin;
                        scrollbar-color: #15696B #f0f0f0;
                      }

                      .table-responsive::-webkit-scrollbar {
                        height: 6px;
                      }

                      .table-responsive::-webkit-scrollbar-track {
                        background: #f0f0f0;
                        border-radius: 10px;
                      }

                      .table-responsive::-webkit-scrollbar-thumb {
                        background: #15696B;
                        border-radius: 10px;
                      }

                      .table-responsive::-webkit-scrollbar-thumb:hover {
                        background: #0F4449;
                      }
                    </style>
                  </div>
                </div>
              </div>
              <div class="col-xxl-6 col-sm-12">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">Patients</h5>
                  </div>
                  <div class="card-body">
                    <!-- Chart removed - card only -->
                  </div>
                </div>
              </div>
              <div class="col-xxl-6 col-sm-12">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">Treatment Type</h5>
                  </div>
                  <div class="card-body">
                    <div id="treatment"></div>
                  </div>
                </div>
              </div>
              <div class="col-xxl-6 col-sm-12">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">Hospital Earnings</h5>
                  </div>
                  <div class="card-body">
                  </div>
                </div>
              </div>

              <div class="col-xxl-3 col-sm-6">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">Insurance Claims</h5>
                  </div>
                  <div class="card-body">
                  </div>
                </div>
              </div>
              <div class="col-xxl-3 col-sm-6">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">Patients by Gender</h5>
                  </div>
                  <div class="card-body">
                  </div>
                </div>
              </div>
            </div>
            <!-- Row ends -->

          </div>
          <!-- App body ends -->

          <!-- App footer starts -->
          <div class="app-footer bg-white">
            <span> LULLA admin 2025</span>
          </div>
          <!-- App footer ends -->

        </div>
        <!-- App container ends -->

      </div>
      <!-- Main container ends -->

    </div>
    <!-- Page wrapper ends -->

    <!-- *************
			************ JavaScript Files *************
		************* -->
    <!-- Required jQuery first, then Bootstrap Bundle JS -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/moment.min.js"></script>

    <!-- Export Libraries -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

    <!-- *************
    ************ Vendor Js Files *************
    ************* -->

    <!-- Overlay Scroll JS -->
    <script src="assets/js/jquery.overlayScrollbars.min.js"></script>
    <script src="assets/js/custom-scrollbar.js"></script>

    <!-- Apex Charts -->
    <script src="assets/js/apexcharts.min.js"></script>
    <script src="assets/js/patients.js"></script>
    <script src="assets/js/treatment.js"></script>
    <script src="assets/js/available-beds.js"></script>
    <script src="assets/js/earnings.js"></script>
    <script src="assets/js/gender-age.js"></script>
    <script src="assets/js/claims.js"></script>

    <!-- Custom JS files -->
    <script src="assets/js/custom.js"></script>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="supabase-config.js"></script>
    
    <!-- Dashboard Data Script -->
    <script src="dashboard-data.js"></script>

    <!-- Chatbot Handler Script -->
    <script src="chatbot-handler.js"></script>

    <!-- Smart Chatbot Matching Engine -->
    <script src="CHATBOT_SMART_MATCHING.js"></script>

    <!-- Authentication Check & Session Management -->
    <script>
      const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds
      let inactivityTimeout;

      // Initialize dashboard on page load
      document.addEventListener('DOMContentLoaded', function() {
        const sessionData = localStorage.getItem('healthflow_session');
        
        if (!sessionData) {
          // User is not logged in, redirect to login page
          window.location.href = 'login.html';
          return;
        }

        // Parse session data
        const session = JSON.parse(sessionData);

        // Display user information
        displayUserInfo(session);

        // Setup logout button
        setupLogoutButton();

        // Setup session timeout
        setupSessionTimeout();

        // Track user activity to reset inactivity timer
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
      });

      // Display user information in header and sidebar
      function displayUserInfo(session) {
        const fullname = session.fullname || session.username || 'User';
        const userRole = session.userRole || 'User';

        // Get initials from fullname
        const initials = fullname
          .split(' ')
          .map(name => name.charAt(0))
          .join('')
          .toUpperCase()
          .slice(0, 2);

        // Update header dropdown UI
        document.getElementById('userInitials').textContent = initials;
        document.getElementById('userName').textContent = fullname;
        document.getElementById('userRole').textContent = userRole;

        // Update sidebar profile UI
        document.getElementById('sidebarUserName').textContent = fullname;
        document.getElementById('sidebarUserRole').textContent = userRole;

        // Update greeting section with real data
        updateGreetingSection(fullname, session);
      }

      // Update the greeting section with user info
      function updateGreetingSection(fullname, session) {
        // Update greeting time based on current hour
        const currentHour = new Date().getHours();
        let greeting = 'Good Morning';
        
        if (currentHour >= 12 && currentHour < 17) {
          greeting = 'Good Afternoon';
        } else if (currentHour >= 17) {
          greeting = 'Good Evening';
        }

        // Update greeting elements
        document.getElementById('greetingTime').textContent = greeting + ',';
        document.getElementById('greetingUserName').textContent = fullname;

        // Fetch and update real stats from database
        fetchDashboardStats(session);
        
        // Fetch and populate patients table
        fetchAndPopulatePatients(session);
      }

      // Fetch dashboard statistics from Supabase
      async function fetchDashboardStats(session) {
        try {
          // Use numeric facility_id from session
          const numericFacilityId = session.fid || session.facility_id || session.facilityId;

          // Fetch total patients for the facility
          const { data: patients, error: patientError } = await supabaseClient
            .from('patients')
            .select('*')
            .eq('fid', numericFacilityId);

          // Fetch total appointments from patients table (patients with art_start_date)
          const { count: totalAppointmentCount, error: totalAppointmentError } = await supabaseClient
            .from('patients')
            .select('*', { count: 'exact', head: true })
            .eq('fid', numericFacilityId)
            .not('art_start_date', 'is', null);
          
          console.log('Facility ID:', numericFacilityId, 'Total appointments count:', totalAppointmentCount, 'Error:', totalAppointmentError);

          // Fetch new patients registered in the current month
          const now = new Date();
          const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
          const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
          
          const { data: newPatients, error: newPatientError } = await supabaseClient
            .from('patients')
            .select('pid')
            .eq('fid', numericFacilityId)
            .gte('patient_registration_date', monthStart)
            .lte('patient_registration_date', monthEnd);

          // Fetch critical patients needing special attention
          // This includes patients with:
          // - High viral load copies (>= 1000)
          // - Status marked as Critical or Alert or Inactive (lost to follow-up)
          let { data: allFacilityPatients, error: facilityPatientsError } = await supabaseClient
            .from('patients')
            .select('pid, viral_load_copies, status')
            .eq('fid', numericFacilityId);

          let criticalPatients = [];
          let criticalError = null;

          if (!facilityPatientsError && allFacilityPatients) {
            // Filter for critical patients: high viral load (>= 1000) or inactive status
            criticalPatients = allFacilityPatients.filter(patient => {
              const vl = parseInt(patient.viral_load_copies);
              return vl >= 1000 || ['Critical', 'Alert', 'Inactive'].includes(patient.status);
            });
          } else {
            criticalError = facilityPatientsError;
          }

          // Update UI with fetched data
          const patientCount = !patientError ? patients.length : 0;
          const newPatientCount = !newPatientError && newPatients ? newPatients.length : 0;
          const criticalPatientCount = !criticalError && criticalPatients ? criticalPatients.length : 0;
          const allAppointmentsCount = !totalAppointmentError ? totalAppointmentCount : 0;

          // Update only if elements exist
          const patientsCountEl = document.getElementById('patientsCount');
          const totalAppointmentsCountEl = document.getElementById('totalAppointmentsCount');
          const newPatientsCountEl = document.getElementById('newPatientsCount');
          const criticalPatientsCountEl = document.getElementById('criticalPatientsCount');

          if (patientsCountEl) patientsCountEl.textContent = patientCount;
          if (totalAppointmentsCountEl) totalAppointmentsCountEl.textContent = allAppointmentsCount;
          if (newPatientsCountEl) newPatientsCountEl.textContent = newPatientCount;
          if (criticalPatientsCountEl) criticalPatientsCountEl.textContent = criticalPatientCount;
        } catch (error) {
          console.error('Error fetching dashboard stats:', error);
        }
      }

      // Global variables for pagination and filtering
      let allPatients = [];
      let filteredPatients = [];
      let currentPatientPage = 1;
      const PATIENTS_PER_PAGE = 5;

      // Setup search and filter controls
       function setupPatientTableControls() {
         const searchInput = document.getElementById('patientSearchInput');
         const conditionFilter = document.getElementById('patientConditionFilter');
         const statusFilter = document.getElementById('patientStatusFilter');

         if (searchInput) searchInput.addEventListener('input', filterAndDisplayPatients);
         if (conditionFilter) conditionFilter.addEventListener('change', filterAndDisplayPatients);
         if (statusFilter) statusFilter.addEventListener('change', filterAndDisplayPatients);
       }

      // Filter and display patients based on search and filter inputs
      function filterAndDisplayPatients() {
        const searchTerm = document.getElementById('patientSearchInput').value.toLowerCase();
        const conditionFilter = document.getElementById('patientConditionFilter').value;
        const statusFilter = document.getElementById('patientStatusFilter').value;

        filteredPatients = allPatients.filter(patient => {
          const matchesSearch = !searchTerm || 
            (patient.patient_no && patient.patient_no.toLowerCase().includes(searchTerm)) ||
            (patient.first_name && patient.first_name.toLowerCase().includes(searchTerm)) ||
            (patient.last_name && patient.last_name.toLowerCase().includes(searchTerm));

          const matchesCondition = !conditionFilter || patient.condition === conditionFilter;
          const matchesStatus = !statusFilter || patient.status === statusFilter;

          return matchesSearch && matchesCondition && matchesStatus;
        });

        currentPatientPage = 1;
        displayPatientPage();
        updatePatientPaginationInfo();
      }

      // Display current page of patients
      function displayPatientPage() {
        const startIndex = (currentPatientPage - 1) * PATIENTS_PER_PAGE;
        const endIndex = startIndex + PATIENTS_PER_PAGE;
        const pagePatients = filteredPatients.slice(startIndex, endIndex);

        const tableBody = document.getElementById('patientsTableBody');

        if (pagePatients.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="11" class="text-center">No patients found</td></tr>';
          return;
        }

        // Table view (responsive with horizontal scroll on mobile)
        tableBody.innerHTML = pagePatients.map(patient => `
          <tr>
            <td>${patient.patient_no || '-'}</td>
            <td>${patient.first_name || '-'} ${patient.last_name || '-'}</td>
            <td>${patient.age || '-'}</td>
            <td>${patient.gender || '-'}</td>
            <td>${patient.phone_number || '-'}</td>
            <td>${patient.address || '-'}</td>
            <td><span class="badge bg-primary">${patient.condition || 'N/A'}</span></td>
            <td>
              <span class="badge ${getStatusBadgeClass(patient.status)}">
                ${patient.status || 'Unknown'}
              </span>
            </td>
            <td>
              <span class="badge ${getHIVStatusBadgeClass(patient.hiv_status)}">
                ${patient.hiv_status || 'Unknown'}
              </span>
            </td>
            <td>${patient.notes || '-'}</td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-sm btn-primary" title="Edit" onclick="editPatient('${patient.patient_no}')">
                  <i class="ri-pencil-line"></i>
                </button>
                <button type="button" class="btn btn-sm btn-danger" title="Delete" onclick="deletePatient('${patient.patient_no}')">
                  <i class="ri-delete-bin-line"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      // Update pagination info and button states
      function updatePatientPaginationInfo() {
        const totalPages = Math.ceil(filteredPatients.length / PATIENTS_PER_PAGE);
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const countInfo = document.getElementById('patientCountInfo');

        if (pageInfo) pageInfo.textContent = `Page ${currentPatientPage} of ${totalPages}`;
        if (countInfo) {
          const startCount = Math.max(1, (currentPatientPage - 1) * PATIENTS_PER_PAGE + 1);
          const endCount = Math.min(filteredPatients.length, currentPatientPage * PATIENTS_PER_PAGE);
          countInfo.textContent = `Showing ${startCount} to ${endCount} of ${filteredPatients.length} patients`;
        }

        if (prevBtn) prevBtn.disabled = currentPatientPage === 1;
        if (nextBtn) nextBtn.disabled = currentPatientPage >= totalPages;
      }

      // Go to previous page
      window.previousPatientPage = function() {
        if (currentPatientPage > 1) {
          currentPatientPage--;
          displayPatientPage();
          updatePatientPaginationInfo();
        }
      };

      // Go to next page
      window.nextPatientPage = function() {
        const totalPages = Math.ceil(filteredPatients.length / PATIENTS_PER_PAGE);
        if (currentPatientPage < totalPages) {
          currentPatientPage++;
          displayPatientPage();
          updatePatientPaginationInfo();
        }
      };

      // Function to generate unique Patient ID
      window.generatePatientID = async function() {
        try {
          // Get the highest patient number from the database
          const { data: patients, error } = await supabaseClient
            .from('patients')
            .select('patient_no')
            .order('patient_no', { ascending: false })
            .limit(1);
          
          if (error) throw error;
          
          let nextNumber = 1001;
          if (patients && patients.length > 0) {
            const lastPatientNo = patients[0].patient_no;
            const lastNumber = parseInt(lastPatientNo.replace('PAT', '')) || 1000;
            nextNumber = lastNumber + 1;
          }
          
          return 'PAT' + nextNumber;
        } catch (error) {
          console.error('Error generating Patient ID:', error);
          // Fallback: generate with timestamp
          return 'PAT' + (1000 + Math.floor(Math.random() * 9000));
        }
      };

      // Edit patient - Wizard Form
      window.editPatient = function(patientNo) {
        const patient = allPatients.find(p => p.patient_no === patientNo);
        if (!patient) {
          Swal.fire({
            title: 'Error',
            text: 'Patient not found',
            icon: 'error',
            confirmButtonColor: '#15696B'
          });
          return;
        }

        let currentStep = 1;
        const totalSteps = 7;

        function showStep(step) {
          for (let i = 1; i <= totalSteps; i++) {
            const stepEl = document.getElementById(`edit-wizard-step-${i}`);
            if (stepEl) stepEl.style.display = 'none';
          }
          
          const currentStepEl = document.getElementById(`edit-wizard-step-${step}`);
          if (currentStepEl) currentStepEl.style.display = 'block';

          const progressBar = document.getElementById('edit-wizard-progress-bar');
          if (progressBar) {
            const progress = (step / totalSteps) * 100;
            progressBar.style.width = progress + '%';
          }

          const stepIndicator = document.getElementById('edit-wizard-step-indicator');
          if (stepIndicator) {
            stepIndicator.textContent = `Step ${step} of ${totalSteps}`;
          }

          const prevBtn = document.getElementById('edit-wizard-prev-btn');
          const nextBtn = document.getElementById('edit-wizard-next-btn');
          const submitBtn = document.getElementById('edit-wizard-submit-btn');
          
          if (prevBtn) prevBtn.style.display = step > 1 ? 'block' : 'none';
          if (nextBtn) nextBtn.style.display = step < totalSteps ? 'block' : 'none';
          if (submitBtn) submitBtn.style.display = step === totalSteps ? 'block' : 'none';
        }

        const wizardHTML = `
          <div style="text-align: left;">
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span id="edit-wizard-step-indicator" style="font-weight: bold; color: #15696B;">Step 1 of ${totalSteps}</span>
                <span style="font-size: 12px; color: #666;">Edit Patient - Wizard</span>
              </div>
              <div style="width: 100%; height: 6px; background-color: #e0e0e0; border-radius: 3px; overflow: hidden;">
                <div id="edit-wizard-progress-bar" style="height: 100%; background-color: #15696B; width: 14.28%; transition: width 0.3s ease;"></div>
              </div>
            </div>

            <form id="editPatientWizardForm">
              <div id="edit-wizard-step-1" style="display: block;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Personal Information</h5>
                <div class="mb-3">
                  <label class="form-label">Patient ID</label>
                  <input type="text" class="form-control" value="${patient.patient_no || ''}" disabled>
                </div>
                <div class="mb-3">
                  <label class="form-label">First Name</label>
                  <input type="text" class="form-control" id="edit_first_name" value="${patient.first_name || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Last Name</label>
                  <input type="text" class="form-control" id="edit_last_name" value="${patient.last_name || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" id="edit_email" value="${patient.email || ''}">
                </div>
                <div class="mb-3">
                   <label class="form-label">Phone Number</label>
                   <input type="tel" class="form-control" id="edit_phone" placeholder="(+256) XXX XXX XXX" value="${patient.phone_number || ''}">
                 </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Age</label>
                      <input type="number" class="form-control" id="edit_age" value="${patient.age || ''}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Gender</label>
                      <select class="form-control" id="edit_gender">
                        <option value="Male" ${patient.gender === 'Male' ? 'selected' : ''}>Male</option>
                        <option value="Female" ${patient.gender === 'Female' ? 'selected' : ''}>Female</option>
                        <option value="Other" ${patient.gender === 'Other' ? 'selected' : ''}>Other</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Address</label>
                  <input type="text" class="form-control" id="edit_address" value="${patient.address || ''}">
                </div>
              </div>

              <div id="edit-wizard-step-2" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Clinical Status & Conditions</h5>
                <div class="mb-3">
                  <label class="form-label">Patient Status</label>
                  <select class="form-control" id="edit_status">
                    <option value="Active" ${patient.status === 'Active' ? 'selected' : ''}>Active</option>
                    <option value="Inactive" ${patient.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                    <option value="Critical" ${patient.status === 'Critical' ? 'selected' : ''}>Critical</option>
                    <option value="Alert" ${patient.status === 'Alert' ? 'selected' : ''}>Alert</option>
                    <option value="Transferred" ${patient.status === 'Transferred' ? 'selected' : ''}>Transferred</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Primary Condition</label>
                  <select class="form-control" id="edit_condition">
                    <option value="">Select condition</option>
                    <option value="HIV" ${patient.condition === 'HIV' ? 'selected' : ''}>HIV</option>
                    <option value="Diabetes" ${patient.condition === 'Diabetes' ? 'selected' : ''}>Diabetes</option>
                    <option value="Hypertension" ${patient.condition === 'Hypertension' ? 'selected' : ''}>Hypertension</option>
                    <option value="TB" ${patient.condition === 'TB' ? 'selected' : ''}>TB</option>
                    <option value="Cancer" ${patient.condition === 'Cancer' ? 'selected' : ''}>Cancer</option>
                    <option value="Asthma" ${patient.condition === 'Asthma' ? 'selected' : ''}>Asthma</option>
                    <option value="Heart Disease" ${patient.condition === 'Heart Disease' ? 'selected' : ''}>Heart Disease</option>
                    <option value="Other" ${patient.condition === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">HIV Status</label>
                  <select class="form-control" id="edit_hiv_status">
                    <option value="Positive" ${patient.hiv_status === 'Positive' ? 'selected' : ''}>Positive</option>
                    <option value="Negative" ${patient.hiv_status === 'Negative' ? 'selected' : ''}>Negative</option>
                    <option value="Unknown" ${patient.hiv_status === 'Unknown' ? 'selected' : ''}>Unknown</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Patient Type</label>
                  <select class="form-control" id="edit_patient_type">
                    <option value="">Select patient type</option>
                    <option value="New" ${patient.patient_type === 'New' ? 'selected' : ''}>New</option>
                    <option value="Returning" ${patient.patient_type === 'Returning' ? 'selected' : ''}>Returning</option>
                    <option value="Transferred" ${patient.patient_type === 'Transferred' ? 'selected' : ''}>Transferred In</option>
                  </select>
                </div>
              </div>

              <div id="edit-wizard-step-3" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Viral Load & HIV Monitoring</h5>
                <div class="mb-3">
                  <label class="form-label">Last Viral Load Date</label>
                  <input type="date" class="form-control" id="edit_last_viral_load_date" value="${patient.last_viral_load_date || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Viral Load Copies</label>
                  <input type="number" class="form-control" id="edit_viral_load_copies" value="${patient.viral_load_copies || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Viral Load Status</label>
                  <select class="form-control" id="edit_viral_load_status">
                    <option value="">Select status</option>
                    <option value="Undetectable" ${patient.viral_load_status === 'Undetectable' ? 'selected' : ''}>Undetectable</option>
                    <option value="Detectable" ${patient.viral_load_status === 'Detectable' ? 'selected' : ''}>Detectable</option>
                    <option value="Not Done" ${patient.viral_load_status === 'Not Done' ? 'selected' : ''}>Not Done</option>
                  </select>
                </div>
              </div>

              <div id="edit-wizard-step-4" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Vital Signs</h5>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Systolic (mmHg)</label>
                      <input type="number" class="form-control" id="edit_systolic" value="${patient.systolic || ''}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Diastolic (mmHg)</label>
                      <input type="number" class="form-control" id="edit_diastolic" value="${patient.diastolic || ''}">
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Blood Pressure (Text)</label>
                  <input type="text" class="form-control" id="edit_blood_pressure" value="${patient.blood_pressure || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Glucose Level (mg/dL)</label>
                  <input type="number" step="0.1" class="form-control" id="edit_glucose_level" value="${patient.glucose_level || ''}">
                </div>
              </div>

              <div id="edit-wizard-step-5" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">HIV Treatment</h5>
                <div class="mb-3">
                  <label class="form-label">HIV Regimen</label>
                  <select class="form-control" id="edit_hiv_regimen">
                    <option value="">Select regimen</option>
                    <option value="TDF/FTC/EFV" ${patient.hiv_regimen === 'TDF/FTC/EFV' ? 'selected' : ''}>TDF/FTC/EFV (First-line)</option>
                    <option value="TDF/FTC/DTG" ${patient.hiv_regimen === 'TDF/FTC/DTG' ? 'selected' : ''}>TDF/FTC/DTG (First-line)</option>
                    <option value="AZT/3TC/EFV" ${patient.hiv_regimen === 'AZT/3TC/EFV' ? 'selected' : ''}>AZT/3TC/EFV (First-line)</option>
                    <option value="TDF/FTC/LPV/r" ${patient.hiv_regimen === 'TDF/FTC/LPV/r' ? 'selected' : ''}>TDF/FTC/LPV/r (Second-line)</option>
                    <option value="AZT/3TC/LPV/r" ${patient.hiv_regimen === 'AZT/3TC/LPV/r' ? 'selected' : ''}>AZT/3TC/LPV/r (Second-line)</option>
                    <option value="TDF/FTC/DTG/LPV/r" ${patient.hiv_regimen === 'TDF/FTC/DTG/LPV/r' ? 'selected' : ''}>TDF/FTC/DTG/LPV/r (Second-line)</option>
                    <option value="Other" ${patient.hiv_regimen === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Regimen Start Date</label>
                  <input type="date" class="form-control" id="edit_regimen_start_date" value="${patient.regimen_start_date || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Regimen Status</label>
                  <select class="form-control" id="edit_regimen_status">
                    <option value="">Select status</option>
                    <option value="Active" ${patient.regimen_status === 'Active' ? 'selected' : ''}>Active</option>
                    <option value="Changed" ${patient.regimen_status === 'Changed' ? 'selected' : ''}>Changed</option>
                    <option value="Stopped" ${patient.regimen_status === 'Stopped' ? 'selected' : ''}>Stopped</option>
                    <option value="Not Started" ${patient.regimen_status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Appointment Type</label>
                  <select class="form-control" id="edit_appointment_type">
                    <option value="">Select type</option>
                    <option value="General" ${patient.appointment_type === 'General' ? 'selected' : ''}>General</option>
                    <option value="Follow-up" ${patient.appointment_type === 'Follow-up' ? 'selected' : ''}>Follow-up</option>
                    <option value="Lab Test" ${patient.appointment_type === 'Lab Test' ? 'selected' : ''}>Lab Test</option>
                    <option value="Counseling" ${patient.appointment_type === 'Counseling' ? 'selected' : ''}>Counseling</option>
                  </select>
                </div>
              </div>

              <div id="edit-wizard-step-6" style="display: none;">
                 <h5 style="color: #15696B; margin-bottom: 15px;">Important Dates</h5>
                <div class="mb-3">
                  <label class="form-label">Patient Registration Date</label>
                  <input type="date" class="form-control" id="edit_patient_registration_date" value="${patient.patient_registration_date || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">ART Start Date</label>
                  <input type="date" class="form-control" id="edit_art_start_date" value="${patient.art_start_date || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Last Visit Date</label>
                  <input type="date" class="form-control" id="edit_visist_date" value="${patient.visist_date || ''}">
                </div>
              </div>

              <div id="edit-wizard-step-7" style="display: none;">
                 <h5 style="color: #15696B; margin-bottom: 15px;">Appointments & Clinical Notes</h5>
                <div class="mb-3">
                  <label class="form-label">Next Appointment Date</label>
                  <input type="date" class="form-control" id="edit_next_appointment" value="${patient.next_appointment || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Appointment Time</label>
                  <input type="time" class="form-control" id="edit_appointment_time" value="${patient.appointment_time || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Clinical Note</label>
                  <textarea class="form-control" id="edit_clinical_note" rows="3">${patient.clinical_note || ''}</textarea>
                </div>
                </div>
            </form>
          </div>
        `;

        Swal.fire({
          title: 'Edit Patient',
          html: wizardHTML,
          didOpen: () => {
            showStep(1);
            // Initialize Select2 and Air Datepicker
            setTimeout(() => {
              initializeSelect2AndDatePicker();
              
              // Add phone number formatter
              const phoneInput = document.getElementById('edit_phone');
              if (phoneInput) {
                console.log('Phone input found:', phoneInput);
                
                // Set initial format if value exists
                if (phoneInput.value && phoneInput.value.length > 0) {
                  let initialValue = phoneInput.value.replace(/\D/g, '');
                  if (initialValue.startsWith('256')) {
                    initialValue = initialValue.slice(3);
                  }
                  if (initialValue.length > 0) {
                    let formatted = '(+256)';
                    if (initialValue.length > 0) {
                      formatted += ' ' + initialValue.slice(0, 3);
                    }
                    if (initialValue.length > 3) {
                      formatted += ' ' + initialValue.slice(3, 6);
                    }
                    if (initialValue.length > 6) {
                      formatted += ' ' + initialValue.slice(6, 9);
                    }
                    phoneInput.value = formatted;
                  }
                }
                
                // Use both input and keyup events
                function formatPhone(e) {
                  let value = e.target.value.replace(/\D/g, '');
                  console.log('Phone value:', value);
                  
                  // Remove leading 256 if present (user might paste it)
                  if (value.startsWith('256')) {
                    value = value.slice(3);
                  }
                  
                  // Limit to 9 digits (after country code)
                  if (value.length > 9) {
                    value = value.slice(0, 9);
                  }
                  
                  // Format as (+256) XXX XXX XXX
                  let formatted = '(+256)';
                  if (value.length > 0) {
                    formatted += ' ' + value.slice(0, 3);
                  }
                  if (value.length > 3) {
                    formatted += ' ' + value.slice(3, 6);
                  }
                  if (value.length > 6) {
                    formatted += ' ' + value.slice(6, 9);
                  }
                  
                  e.target.value = formatted;
                }
                
                phoneInput.addEventListener('input', formatPhone);
                phoneInput.addEventListener('keyup', formatPhone);
              } else {
                console.log('Phone input not found');
              }
              
              // Add name capitalization on blur
              const firstNameInput = document.getElementById('edit_first_name');
              const lastNameInput = document.getElementById('edit_last_name');
              
              if (firstNameInput) {
                firstNameInput.addEventListener('blur', function() {
                  if (this.value) {
                    this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1).toLowerCase();
                  }
                });
              }
              
              if (lastNameInput) {
                lastNameInput.addEventListener('blur', function() {
                  if (this.value) {
                    this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1).toLowerCase();
                  }
                });
              }
            }, 100);
          },
          showCancelButton: true,
          confirmButtonText: 'Next',
          confirmButtonColor: '#15696B',
          cancelButtonColor: '#6c757d',
          width: '650px',
          allowOutsideClick: false,
          willClose: () => {
            currentStep = 1;
          }
        });

        setTimeout(() => {
          const footer = document.querySelector('.swal2-actions');
          if (footer) {
            footer.innerHTML = `
              <button id="edit-wizard-prev-btn" class="wizard-btn wizard-btn-secondary" style="display: none; margin-right: auto;">
                <i class="ri-arrow-left-line"></i> Previous
              </button>
              <div style="display: flex; gap: 12px; margin-left: auto;">
                <button id="edit-wizard-next-btn" class="wizard-btn wizard-btn-primary">
                  Next <i class="ri-arrow-right-line"></i>
                </button>
                <button id="edit-wizard-submit-btn" class="wizard-btn wizard-btn-success" style="display: none;">
                  <i class="ri-check-line"></i> Update Patient
                </button>
                <button class="wizard-btn wizard-btn-outline" onclick="Swal.close()">
                  <i class="ri-close-line"></i> Cancel
                </button>
              </div>
            `;
            footer.style.display = 'flex';
            footer.style.alignItems = 'center';
            footer.style.gap = '0';

            document.getElementById('edit-wizard-prev-btn').addEventListener('click', () => {
              if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
              }
            });

            document.getElementById('edit-wizard-next-btn').addEventListener('click', () => {
              if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
              }
            });

            document.getElementById('edit-wizard-submit-btn').addEventListener('click', async () => {
              // Validation function
              function validatePatientForm() {
                const errors = [];
                
                // Step 1: Personal Information
                const firstName = document.getElementById('edit_first_name').value.trim();
                const lastName = document.getElementById('edit_last_name').value.trim();
                const email = document.getElementById('edit_email').value.trim();
                const phone = document.getElementById('edit_phone').value.trim();
                const age = document.getElementById('edit_age').value.trim();
                const gender = document.getElementById('edit_gender').value;
                
                if (!firstName) {
                  errors.push('First Name is required');
                }
                if (!lastName) {
                  errors.push('Last Name is required');
                }
                if (firstName && firstName.length < 2) {
                  errors.push('First Name must be at least 2 characters');
                }
                if (firstName && !/^[A-Z]/.test(firstName)) {
                  errors.push('First Name must start with a capital letter');
                }
                if (lastName && lastName.length < 2) {
                  errors.push('Last Name must be at least 2 characters');
                }
                if (lastName && !/^[A-Z]/.test(lastName)) {
                  errors.push('Last Name must start with a capital letter');
                }
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                  errors.push('Please enter a valid email address');
                }
                if (phone && !/^\(\+\d{3}\)\s\d{3}\s\d{3}\s\d{3}$/.test(phone)) {
                  errors.push('Phone number must be in format: (+256) XXX XXX XXX');
                }
                if (age && (isNaN(age) || age < 0 || age > 100)) {
                  errors.push('Age must be a valid number between 0 and 100');
                }
                if (!gender) {
                  errors.push('Gender is required');
                }
                
                // Step 2: Clinical Status
                const status = document.getElementById('edit_status').value;
                const hivStatus = document.getElementById('edit_hiv_status').value;
                
                if (!status) {
                  errors.push('Patient Status is required');
                }
                if (!hivStatus) {
                  errors.push('HIV Status is required');
                }
                
                // Step 3: Viral Load
                const viralLoadCopies = document.getElementById('edit_viral_load_copies').value.trim();
                if (viralLoadCopies && (isNaN(viralLoadCopies) || parseInt(viralLoadCopies) < 0)) {
                  errors.push('Viral Load Copies must be a positive number');
                }
                
                // Step 4: Blood Pressure
                const systolic = document.getElementById('edit_systolic').value.trim();
                const diastolic = document.getElementById('edit_diastolic').value.trim();
                if (systolic && (isNaN(systolic) || parseInt(systolic) < 0 || parseInt(systolic) > 300)) {
                  errors.push('Systolic BP must be between 0 and 300');
                }
                if (diastolic && (isNaN(diastolic) || parseInt(diastolic) < 0 || parseInt(diastolic) > 200)) {
                  errors.push('Diastolic BP must be between 0 and 200');
                }
                
                // Step 5: Glucose Level
                const glucose = document.getElementById('edit_glucose_level').value.trim();
                if (glucose && (isNaN(glucose) || parseFloat(glucose) < 0 || parseFloat(glucose) > 1000)) {
                  errors.push('Glucose Level must be between 0 and 1000');
                }
                
                // Step 6: Dates
                const patientRegDate = document.getElementById('edit_patient_registration_date').value.trim();
                const artStartDate = document.getElementById('edit_art_start_date').value.trim();
                const today = new Date().toISOString().split('T')[0];
                
                if (patientRegDate && patientRegDate < today) {
                  errors.push('Patient Registration Date must be in the future (today or later)');
                }
                
                if (artStartDate && patientRegDate && artStartDate < patientRegDate) {
                  errors.push('ART Start Date cannot be before Patient Registration Date');
                }
                
                return errors;
              }
              
              // Validate form
              const validationErrors = validatePatientForm();
              if (validationErrors.length > 0) {
                Swal.fire({
                  title: 'Validation Error',
                  html: '<ul style="text-align: left; font-size: 14px;">' + 
                        validationErrors.map(error => `<li style="margin: 5px 0;">${error}</li>`).join('') + 
                        '</ul>',
                  icon: 'error',
                  confirmButtonColor: '#15696B'
                });
                return;
              }

              const updatedData = {
                first_name: document.getElementById('edit_first_name').value,
                last_name: document.getElementById('edit_last_name').value,
                email: document.getElementById('edit_email').value || null,
                age: parseInt(document.getElementById('edit_age').value) || null,
                gender: document.getElementById('edit_gender').value,
                phone_number: document.getElementById('edit_phone').value || null,
                address: document.getElementById('edit_address').value || null,
                status: document.getElementById('edit_status').value,
                condition: document.getElementById('edit_condition').value || null,
                hiv_status: document.getElementById('edit_hiv_status').value,
                patient_type: document.getElementById('edit_patient_type').value || null,
                last_viral_load_date: document.getElementById('edit_last_viral_load_date').value || null,
                viral_load_copies: parseInt(document.getElementById('edit_viral_load_copies').value) || null,
                viral_load_status: document.getElementById('edit_viral_load_status').value || null,
                systolic: document.getElementById('edit_systolic').value ? parseInt(document.getElementById('edit_systolic').value) : null,
                diastolic: document.getElementById('edit_diastolic').value ? parseInt(document.getElementById('edit_diastolic').value) : null,
                blood_pressure: document.getElementById('edit_blood_pressure').value || null,
                glucose_level: document.getElementById('edit_glucose_level').value ? parseFloat(document.getElementById('edit_glucose_level').value) : null,
                hiv_regimen: document.getElementById('edit_hiv_regimen').value || null,
                regimen_start_date: document.getElementById('edit_regimen_start_date').value || null,
                regimen_status: document.getElementById('edit_regimen_status').value || null,
                appointment_type: document.getElementById('edit_appointment_type').value || null,
                patient_registration_date: document.getElementById('edit_patient_registration_date').value || null,
                art_start_date: document.getElementById('edit_art_start_date').value || null,
                visist_date: document.getElementById('edit_visist_date').value || null,
                next_appointment: document.getElementById('edit_next_appointment').value || null,
                appointment_time: document.getElementById('edit_appointment_time').value || null,
                clinical_note: document.getElementById('edit_clinical_note').value || null
                };

              try {
                const { error } = await supabaseClient
                  .from('patients')
                  .update(updatedData)
                  .eq('patient_no', patientNo);

                if (error) throw error;

                Swal.fire({
                  title: 'Success',
                  text: 'Patient updated successfully',
                  icon: 'success',
                  confirmButtonColor: '#15696B'
                });

                const session = JSON.parse(localStorage.getItem('userSession'));
                await fetchAndPopulatePatients(session);
              } catch (error) {
                Swal.fire({
                  title: 'Error',
                  text: `Failed to update patient: ${error.message}`,
                  icon: 'error',
                  confirmButtonColor: '#15696B'
                });
              }
            });
          }
        }, 100);
      };

      // Delete patient
      window.deletePatient = function(patientNo) {
        Swal.fire({
          title: 'Delete Patient',
          text: `Are you sure you want to delete patient ${patientNo}? This action cannot be undone.`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, delete',
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d'
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const { error } = await supabaseClient
                .from('patients')
                .delete()
                .eq('patient_no', patientNo);

              if (error) throw error;

              Swal.fire({
                title: 'Deleted',
                text: 'Patient has been deleted successfully',
                icon: 'success',
                confirmButtonColor: '#15696B'
              });

              // Refresh the table
              const session = JSON.parse(localStorage.getItem('userSession'));
              await fetchAndPopulatePatients(session);
            } catch (error) {
              Swal.fire({
                title: 'Error',
                text: `Failed to delete patient: ${error.message}`,
                icon: 'error',
                confirmButtonColor: '#15696B'
              });
            }
          }
        });
      };

      // Add new patient - Wizard Form
      window.addNewPatient = async function() {
        // Generate new Patient ID
        const newPatientID = await generatePatientID();
        
        let currentStep = 1;
        const totalSteps = 7;

        function showStep(step) {
          // Hide all steps
          for (let i = 1; i <= totalSteps; i++) {
            const stepEl = document.getElementById(`wizard-step-${i}`);
            if (stepEl) stepEl.style.display = 'none';
          }
          
          // Show current step
          const currentStepEl = document.getElementById(`wizard-step-${step}`);
          if (currentStepEl) currentStepEl.style.display = 'block';

          // Update progress bar
          const progressBar = document.getElementById('wizard-progress-bar');
          if (progressBar) {
            const progress = (step / totalSteps) * 100;
            progressBar.style.width = progress + '%';
          }

          // Update step indicator
          const stepIndicator = document.getElementById('wizard-step-indicator');
          if (stepIndicator) {
            stepIndicator.textContent = `Step ${step} of ${totalSteps}`;
          }

          // Update button states
          const prevBtn = document.getElementById('wizard-prev-btn');
          const nextBtn = document.getElementById('wizard-next-btn');
          const submitBtn = document.getElementById('wizard-submit-btn');
          
          if (prevBtn) prevBtn.style.display = step > 1 ? 'block' : 'none';
          if (nextBtn) nextBtn.style.display = step < totalSteps ? 'block' : 'none';
          if (submitBtn) submitBtn.style.display = step === totalSteps ? 'block' : 'none';
        }

        const wizardHTML = `
          <div style="text-align: left;">
            <!-- Progress Bar -->
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span id="wizard-step-indicator" style="font-weight: bold; color: #15696B;">Step 1 of ${totalSteps}</span>
                <span style="font-size: 12px; color: #666;">Patient Registration Wizard</span>
              </div>
              <div style="width: 100%; height: 6px; background-color: #e0e0e0; border-radius: 3px; overflow: hidden;">
                <div id="wizard-progress-bar" style="height: 100%; background-color: #15696B; width: 14.28%; transition: width 0.3s ease;"></div>
              </div>
            </div>

            <form id="addPatientWizardForm">
              <!-- STEP 1: Personal Information -->
              <div id="wizard-step-1" style="display: block;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Personal Information</h5>
                <div class="mb-3">
                   <label class="form-label">Patient ID *</label>
                   <input type="text" class="form-control" id="add_patient_no" placeholder="Auto-generated" value="${newPatientID}" disabled readonly>
                 </div>
                <div class="mb-3">
                  <label class="form-label">First Name *</label>
                  <input type="text" class="form-control" id="add_first_name" placeholder="Enter first name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Last Name *</label>
                  <input type="text" class="form-control" id="add_last_name" placeholder="Enter last name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" id="add_email" placeholder="Enter email address">
                </div>
                <div class="mb-3">
                  <label class="form-label">Phone Number</label>
                  <input type="tel" class="form-control" id="add_phone" placeholder="Enter phone number">
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Age</label>
                      <input type="number" class="form-control" id="add_age" placeholder="Enter age">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Gender *</label>
                      <select class="form-control" id="add_gender" required>
                        <option value="">Select gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Address</label>
                  <input type="text" class="form-control" id="add_address" placeholder="Enter residential address">
                </div>
              </div>

              <!-- STEP 2: Clinical Status -->
              <div id="wizard-step-2" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Clinical Status & Conditions</h5>
                <div class="mb-3">
                  <label class="form-label">Patient Status *</label>
                  <select class="form-control" id="add_status" required>
                    <option value="">Select status</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Critical">Critical</option>
                    <option value="Alert">Alert</option>
                    <option value="Transferred">Transferred</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Primary Condition</label>
                  <select class="form-control" id="add_condition">
                    <option value="">Select condition</option>
                    <option value="HIV">HIV</option>
                    <option value="Diabetes">Diabetes</option>
                    <option value="Hypertension">Hypertension</option>
                    <option value="TB">TB</option>
                    <option value="Cancer">Cancer</option>
                    <option value="Asthma">Asthma</option>
                    <option value="Heart Disease">Heart Disease</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">HIV Status *</label>
                  <select class="form-control" id="add_hiv_status" required>
                    <option value="">Select HIV Status</option>
                    <option value="Positive">Positive</option>
                    <option value="Negative">Negative</option>
                    <option value="Unknown">Unknown</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Patient Type</label>
                  <select class="form-control" id="add_patient_type">
                    <option value="">Select patient type</option>
                    <option value="New">New</option>
                    <option value="Returning">Returning</option>
                    <option value="Transferred">Transferred In</option>
                  </select>
                </div>
              </div>

              <!-- STEP 3: Viral Load & HIV Monitoring -->
              <div id="wizard-step-3" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Viral Load & HIV Monitoring</h5>
                <div class="mb-3">
                  <label class="form-label">Last Viral Load Date</label>
                  <input type="date" class="form-control" id="add_last_viral_load_date">
                </div>
                <div class="mb-3">
                  <label class="form-label">Viral Load Copies</label>
                  <input type="number" class="form-control" id="add_viral_load_copies" placeholder="Enter viral load count">
                </div>
                <div class="mb-3">
                  <label class="form-label">Viral Load Status</label>
                  <select class="form-control" id="add_viral_load_status">
                    <option value="">Select status</option>
                    <option value="Undetectable">Undetectable</option>
                    <option value="Detectable">Detectable</option>
                    <option value="Not Done">Not Done</option>
                  </select>
                </div>
              </div>

              <!-- STEP 4: NCD Management -->
              <div id="wizard-step-4" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Vital Signs</h5>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Systolic (mmHg)</label>
                      <input type="number" class="form-control" id="add_systolic" placeholder="e.g., 120">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Diastolic (mmHg)</label>
                      <input type="number" class="form-control" id="add_diastolic" placeholder="e.g., 80">
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Blood Pressure (Text)</label>
                  <input type="text" class="form-control" id="add_blood_pressure" placeholder="e.g., 120/80">
                </div>
                <div class="mb-3">
                  <label class="form-label">Glucose Level (mg/dL)</label>
                  <input type="number" step="0.1" class="form-control" id="add_glucose_level" placeholder="Enter glucose level">
                </div>
              </div>

              <!-- STEP 5: HIV Treatment Regimen -->
              <div id="wizard-step-5" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">HIV Treatment</h5>
                <div class="mb-3">
                  <label class="form-label">HIV Regimen</label>
                  <select class="form-control" id="add_hiv_regimen">
                    <option value="">Select regimen</option>
                    <option value="TDF/FTC/EFV">TDF/FTC/EFV (First-line)</option>
                    <option value="TDF/FTC/DTG">TDF/FTC/DTG (First-line)</option>
                    <option value="AZT/3TC/EFV">AZT/3TC/EFV (First-line)</option>
                    <option value="TDF/FTC/LPV/r">TDF/FTC/LPV/r (Second-line)</option>
                    <option value="AZT/3TC/LPV/r">AZT/3TC/LPV/r (Second-line)</option>
                    <option value="TDF/FTC/DTG/LPV/r">TDF/FTC/DTG/LPV/r (Second-line)</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Regimen Start Date</label>
                  <input type="date" class="form-control" id="add_regimen_start_date">
                </div>
                <div class="mb-3">
                  <label class="form-label">Regimen Status</label>
                  <select class="form-control" id="add_regimen_status">
                    <option value="">Select status</option>
                    <option value="Active">Active</option>
                    <option value="Changed">Changed</option>
                    <option value="Stopped">Stopped</option>
                    <option value="Not Started">Not Started</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Appointment Type</label>
                  <select class="form-control" id="add_appointment_type">
                    <option value="">Select type</option>
                    <option value="General">General</option>
                    <option value="Follow-up">Follow-up</option>
                    <option value="Lab Test">Lab Test</option>
                    <option value="Counseling">Counseling</option>
                  </select>
                </div>
              </div>

              <!-- STEP 6: Important Dates -->
              <div id="wizard-step-6" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Important Dates</h5>
                <div class="mb-3">
                  <label class="form-label">Patient Registration Date</label>
                  <input type="date" class="form-control" id="add_patient_registration_date">
                </div>
                <div class="mb-3">
                  <label class="form-label">ART Start Date</label>
                  <input type="date" class="form-control" id="add_art_start_date">
                </div>
                <div class="mb-3">
                  <label class="form-label">Last Visit Date</label>
                  <input type="date" class="form-control" id="add_visist_date">
                </div>
              </div>

              <!-- STEP 7: Appointments & Notes -->
              <div id="wizard-step-7" style="display: none;">
                 <h5 style="color: #15696B; margin-bottom: 15px;">Appointments & Clinical Notes</h5>
                <div class="mb-3">
                  <label class="form-label">Next Appointment Date</label>
                  <input type="date" class="form-control" id="add_next_appointment">
                </div>
                <div class="mb-3">
                  <label class="form-label">Appointment Time</label>
                  <input type="time" class="form-control" id="add_appointment_time">
                </div>
                <div class="mb-3">
                  <label class="form-label">Clinical Note</label>
                  <textarea class="form-control" id="add_clinical_note" rows="3" placeholder="Enter detailed clinical notes"></textarea>
                </div>
                </div>
            </form>
          </div>
        `;

        Swal.fire({
          title: 'Add New Patient',
          html: wizardHTML,
          didOpen: () => {
            showStep(1);
            // Set facility info from session
            const session = JSON.parse(localStorage.getItem('userSession'));
            const facilityEl = document.getElementById('add_facility_id_code');
            if (facilityEl && session) {
              facilityEl.value = session.facility_id_code || 'N/A';
            }
            // Initialize Select2 and Air Datepicker
            setTimeout(() => {
              initializeSelect2AndDatePicker();
            }, 100);
          },
          showCancelButton: true,
          confirmButtonText: 'Next',
          confirmButtonColor: '#15696B',
          cancelButtonColor: '#6c757d',
          width: '650px',
          allowOutsideClick: false,
          willClose: () => {
            // Reset when modal closes
            currentStep = 1;
          }
        });

        // Add custom navigation buttons
        setTimeout(() => {
          const footer = document.querySelector('.swal2-actions');
          if (footer) {
            footer.innerHTML = `
              <button id="wizard-prev-btn" class="btn btn-secondary" style="display: none; margin-right: 10px;">Previous</button>
              <button id="wizard-next-btn" class="btn btn-primary" style="background-color: #15696B; border-color: #15696B;">Next</button>
              <button id="wizard-submit-btn" class="btn btn-success" style="display: none;">Submit</button>
              <button class="btn btn-outline-secondary" onclick="Swal.close()">Cancel</button>
            `;

            document.getElementById('wizard-prev-btn').addEventListener('click', () => {
              if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                document.querySelector('.swal2-confirm').textContent = currentStep === totalSteps ? 'Submit' : 'Next';
              }
            });

            document.getElementById('wizard-next-btn').addEventListener('click', () => {
              if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
              }
            });

            document.getElementById('wizard-submit-btn').addEventListener('click', async () => {
              const patientNo = document.getElementById('add_patient_no').value;
              const firstName = document.getElementById('add_first_name').value;
              const lastName = document.getElementById('add_last_name').value;
              const gender = document.getElementById('add_gender').value;
              const status = document.getElementById('add_status').value;
              const hivStatus = document.getElementById('add_hiv_status').value;

              if (!patientNo || !firstName || !lastName || !gender || !status || !hivStatus) {
                Swal.showValidationMessage('Please fill in all required fields');
                return;
              }

              const session = JSON.parse(localStorage.getItem('userSession'));
              const newPatientData = {
                patient_no: patientNo,
                first_name: firstName,
                last_name: lastName,
                email: document.getElementById('add_email').value || null,
                age: parseInt(document.getElementById('add_age').value) || null,
                gender: gender,
                phone_number: document.getElementById('add_phone').value || null,
                address: document.getElementById('add_address').value || null,
                status: status,
                condition: document.getElementById('add_condition').value || null,
                hiv_status: hivStatus,
                patient_type: document.getElementById('add_patient_type').value || null,
                last_viral_load_date: document.getElementById('add_last_viral_load_date').value || null,
                viral_load_copies: parseInt(document.getElementById('add_viral_load_copies').value) || null,
                viral_load_status: document.getElementById('add_viral_load_status').value || null,
                systolic: document.getElementById('add_systolic').value ? parseInt(document.getElementById('add_systolic').value) : null,
                diastolic: document.getElementById('add_diastolic').value ? parseInt(document.getElementById('add_diastolic').value) : null,
                blood_pressure: document.getElementById('add_blood_pressure').value || null,
                glucose_level: document.getElementById('add_glucose_level').value ? parseFloat(document.getElementById('add_glucose_level').value) : null,
                hiv_regimen: document.getElementById('add_hiv_regimen').value || null,
                regimen_start_date: document.getElementById('add_regimen_start_date').value || null,
                regimen_status: document.getElementById('add_regimen_status').value || null,
                appointment_type: document.getElementById('add_appointment_type').value || null,
                patient_registration_date: document.getElementById('add_patient_registration_date').value || null,
                art_start_date: document.getElementById('add_art_start_date').value || null,
                visist_date: document.getElementById('add_visist_date').value || null,
                next_appointment: document.getElementById('add_next_appointment').value || null,
                appointment_time: document.getElementById('add_appointment_time').value || null,
                clinical_note: document.getElementById('add_clinical_note').value || null,
                fid: session.fid || session.facility_id
              };

              try {
                const { error } = await supabaseClient
                  .from('patients')
                  .insert([newPatientData]);

                if (error) throw error;

                Swal.fire({
                  title: 'Success',
                  text: 'Patient added successfully',
                  icon: 'success',
                  confirmButtonColor: '#15696B'
                });

                const updatedSession = JSON.parse(localStorage.getItem('userSession'));
                await fetchAndPopulatePatients(updatedSession);
              } catch (error) {
                Swal.fire({
                  title: 'Error',
                  text: `Failed to add patient: ${error.message}`,
                  icon: 'error',
                  confirmButtonColor: '#15696B'
                });
              }
            });
          }
        }, 100);
      };

      // Get patient data for export
       function getPatientExportData() {
         return {
           headers: ['Patient ID', 'First Name', 'Last Name', 'Age', 'Gender', 'Phone', 'Address', 'Condition', 'Status', 'HIV Status', 'Notes'],
           rows: filteredPatients.map(patient => [
             patient.patient_no || '',
             patient.first_name || '',
             patient.last_name || '',
             patient.age || '',
             patient.gender || '',
             patient.phone_number || '',
             patient.address || '',
             patient.condition || '',
             patient.status || '',
             patient.hiv_status || '',
             patient.notes || ''
           ])
         };
       }

      // Export patients to CSV
       window.exportPatientsToCSV = function() {
         const { headers, rows } = getPatientExportData();
         
         let csvContent = headers.join(',') + '\n';
         rows.forEach(row => {
           csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
         });

         const blob = new Blob([csvContent], { type: 'text/csv' });
         const url = window.URL.createObjectURL(blob);
         const a = document.createElement('a');
         a.href = url;
         a.download = `patients_${new Date().toISOString().split('T')[0]}.csv`;
         document.body.appendChild(a);
         a.click();
         document.body.removeChild(a);
         window.URL.revokeObjectURL(url);
       };

      // Export patients to Excel
       window.exportPatientsToExcel = function() {
         try {
           if (!window.XLSX) {
             throw new Error('XLSX library not loaded');
           }
           
           const { headers, rows } = getPatientExportData();
           const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
           
           // Set column widths
           ws['!cols'] = [
             {wch: 12}, {wch: 15}, {wch: 15}, {wch: 8}, {wch: 10}, 
             {wch: 20}, {wch: 15}, {wch: 12}, {wch: 15}, {wch: 20}
           ];
           
           const wb = XLSX.utils.book_new();
           XLSX.utils.book_append_sheet(wb, ws, 'Patients');
           XLSX.writeFile(wb, `patients_${new Date().toISOString().split('T')[0]}.xlsx`);
         } catch (error) {
           console.error('Error exporting to Excel:', error);
           Swal.fire({
             title: 'Export Failed',
             text: `Failed to export patients to Excel: ${error.message}`,
             icon: 'error',
             confirmButtonColor: '#15696B'
           });
         }
       };

      // Export patients to PDF
        window.exportPatientsToPDF = function() {
          try {
            if (!window.jspdf) {
              throw new Error('jsPDF library not loaded');
            }
            
            const { headers, rows } = getPatientExportData();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
           
           doc.setFontSize(16);
           doc.text('Patients Report', 14, 15);
           
           doc.setFontSize(10);
           doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 25);
           
           doc.autoTable({
             head: [headers],
             body: rows,
             startY: 35,
             theme: 'grid',
             headStyles: {
               fillColor: [21, 105, 107],
               textColor: [255, 255, 255],
               fontStyle: 'bold',
               halign: 'center'
             },
             bodyStyles: {
               textColor: [0, 0, 0]
             },
             alternateRowStyles: {
               fillColor: [240, 240, 240]
             },
             margin: 10,
             didDrawPage: function(data) {
               // Add page number
               const pageSize = doc.internal.pageSize;
               const pageHeight = pageSize.getHeight();
               const pageWidth = pageSize.getWidth();
               doc.setFontSize(8);
               doc.text(`Page ${doc.internal.pages.length - 1}`, pageWidth - 20, pageHeight - 10);
             }
           });
           
           doc.save(`patients_${new Date().toISOString().split('T')[0]}.pdf`);
         } catch (error) {
           console.error('Error exporting to PDF:', error);
           Swal.fire({
             title: 'Export Failed',
             text: `Failed to export patients to PDF: ${error.message}`,
             icon: 'error',
             confirmButtonColor: '#15696B'
           });
         }
       };

      // Fetch and populate all patients in the table
      async function fetchAndPopulatePatients(session) {
        try {
          console.log('fetchAndPopulatePatients called with session:', session);
          
          // Check if supabaseClient is available
          if (!supabaseClient) {
            console.error('Supabase client not initialized');
            document.getElementById('patientsTableBody').innerHTML = 
              '<tr><td colspan="10" class="text-center text-danger">Supabase not initialized</td></tr>';
            return;
          }

          const numericFacilityId = session.fid || session.facility_id || session.facilityId;
          console.log('Fetching patients for facility ID:', numericFacilityId);
          
          // Fetch all patients for the facility with relevant fields
           const { data: patients, error: patientError } = await supabaseClient
             .from('patients')
             .select('patient_no, first_name, last_name, age, gender, phone_number, address, condition, status, hiv_status, notes')
             .eq('fid', numericFacilityId);

          console.log('Patients fetch result:', { patients, error: patientError });

          if (patientError) {
            console.error('Error fetching patients:', patientError);
            document.getElementById('patientsTableBody').innerHTML = 
              `<tr><td colspan="10" class="text-center text-danger">Error: ${patientError.message}</td></tr>`;
            return;
          }

          if (!patients || patients.length === 0) {
            document.getElementById('patientsTableBody').innerHTML = '<tr><td colspan="10" class="text-center">No patients found</td></tr>';
            return;
          }

          console.log('Fetched', patients.length, 'patients');

          // Store all patients for filtering
          allPatients = patients;
          filteredPatients = patients;
          currentPatientPage = 1;

          // Setup event listeners for search and filters
          setupPatientTableControls();

          // Display first page
          displayPatientPage();
          updatePatientPaginationInfo();
        } catch (error) {
           console.error('Error fetching and populating patients:', error);
           document.getElementById('patientsTableBody').innerHTML = 
             `<tr><td colspan="10" class="text-center text-danger">Error: ${error.message}</td></tr>`;
         }
      }

      // Helper function to get status badge class
      function getStatusBadgeClass(status) {
        switch(status) {
          case 'Active':
            return 'bg-success-subtle text-success';
          case 'Inactive':
            return 'bg-danger-subtle text-danger';
          case 'Critical':
            return 'bg-warning-subtle text-warning';
          case 'Alert':
            return 'bg-info-subtle text-info';
          default:
            return 'bg-secondary-subtle text-secondary';
        }
      }

      // Helper function to get HIV status badge class
      function getHIVStatusBadgeClass(hivStatus) {
        if (!hivStatus) return 'bg-secondary-subtle text-secondary';
        const status = hivStatus.toLowerCase();
        if (status.includes('positive')) {
          return 'bg-danger-subtle text-danger';
        } else if (status.includes('negative')) {
          return 'bg-success-subtle text-success';
        } else if (status.includes('unknown')) {
          return 'bg-warning-subtle text-warning';
        }
        return 'bg-secondary-subtle text-secondary';
      }

      // Setup logout button functionality
      function setupLogoutButton() {
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            logout();
          });
        }
      }

      // Logout function
      function logout() {
        // Clear session data
        localStorage.removeItem('healthflow_session');
        localStorage.removeItem('healthflow_email');

        // Clear inactivity timer
        if (inactivityTimeout) {
          clearTimeout(inactivityTimeout);
        }

        // Redirect to login page
        window.location.href = 'login.html';
      }

      // Setup session timeout on inactivity
      function setupSessionTimeout() {
        resetInactivityTimer();
      }

      // Reset inactivity timer
      function resetInactivityTimer() {
        // Clear existing timeout
        if (inactivityTimeout) {
          clearTimeout(inactivityTimeout);
        }

        // Set new timeout
        inactivityTimeout = setTimeout(function() {
          // Session expired due to inactivity
          const sessionData = localStorage.getItem('healthflow_session');
          if (sessionData) {
            // Show warning before logout
            Swal.fire({
              title: 'Session Expired',
              text: 'Your session has expired due to inactivity. Please login again.',
              icon: 'warning',
              confirmButtonColor: '#15696B',
              confirmButtonText: 'Login',
              allowOutsideClick: false,
              allowEscapeKey: false
            }).then((result) => {
              if (result.isConfirmed) {
                logout();
              }
            });
          }
        }, SESSION_TIMEOUT);
      }

      // Handle page visibility change (minimize/maximize)
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          // Page is now visible, check session validity
          const sessionData = localStorage.getItem('healthflow_session');
          if (!sessionData) {
            window.location.href = 'login.html';
          }
        }
      });
    </script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- Air Datepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.4.0/air-datepicker.js"></script>
    
    <!-- Set English as default language for Air Datepicker -->
    <script>
      window.AirDatepickerLocaleOverride = {
        en: {
          days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
          daysShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
          daysMin: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'],
          months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
          monthsShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          today: 'Today',
          clear: 'Clear'
        }
      };
    </script>
    
    <!-- Initialize Select2 and Air Datepicker -->
    <script>
      function initializeSelect2AndDatePicker() {
        try {
          // Initialize Select2 for all select elements
          const selectElements = document.querySelectorAll('.swal2-html-container select.form-control');
          selectElements.forEach(function(selectEl) {
            const $select = jQuery(selectEl);
            
            // Destroy existing Select2 if it exists
            if ($select.data('select2')) {
              $select.select2('destroy');
            }
            
            // Initialize Select2 with dropdown parent set to html-container
            $select.select2({
              width: '100%',
              allowClear: false,
              dropdownParent: jQuery('.swal2-html-container')
            });
          });

          // Initialize Air Datepicker for all date inputs
          const dateElements = document.querySelectorAll('.swal2-html-container input[type="date"]');
          dateElements.forEach(function(dateEl) {
            if (!dateEl.hasAttribute('data-datepicker-initialized')) {
              try {
                // Change input type to text for Air Datepicker
                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.className = dateEl.className;
                textInput.id = dateEl.id;
                textInput.value = dateEl.value;
                dateEl.parentNode.replaceChild(textInput, dateEl);
                
                new AirDatepicker(textInput, {
                  isMobile: false,
                  autoClose: true,
                  position: 'bottom left',
                  dateFormat: 'yyyy-MM-dd',
                  locale: window.AirDatepickerLocaleOverride.en,
                  onSelect: function({date}) {
                    if (date) {
                      const year = date.getFullYear();
                      const month = String(date.getMonth() + 1).padStart(2, '0');
                      const day = String(date.getDate()).padStart(2, '0');
                      textInput.value = `${year}-${month}-${day}`;
                    }
                  }
                });
                textInput.setAttribute('data-datepicker-initialized', 'true');
              } catch(e) {
                console.log('AirDatepicker init error:', e.message);
              }
            }
          });
        } catch(error) {
          console.log('Initialization info:', error);
        }
      }

      // Make function globally accessible
      window.initializeSelect2AndDatePicker = initializeSelect2AndDatePicker;
    </script>
  </body>

</html>