<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HealthFlow - Healthcare Automation Dashboard</title>

    <!-- Meta -->
    <meta name="description"
        content="HealthFlow Healthcare Automation Platform - Streamline patient management, appointments, and healthcare data with intelligent automation.">
    <meta property="og:title" content="HealthFlow - Healthcare Automation Dashboard">
    <meta property="og:description"
        content="Automate healthcare operations, reduce paperwork, and save lives with HealthFlow's intelligent healthcare automation platform.">
    <meta property="og:type" content="Website">
    <link rel="shortcut icon" href="assets/images/favicon.png">

    <!-- *************
		************ CSS Files *************
	************* -->
    <link rel="stylesheet" href="assets/css/remixicon.css">
    <link rel="stylesheet" href="assets/css/main.min.css">
    <link rel="stylesheet" href="chat-system-improved.css">
    <link rel="stylesheet" href="assets/css/chatbot.css">

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- jQuery -->
    <script src="assets/js/jquery.min.js"></script>

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Material Design Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">

    <!-- WhatsApp Style Chat CSS -->
    <style>
.chat {
  height: calc(100% - 69px);
}

.chat-container {
  height: 100%;
}

.user-bar {
  height: 55px;
  background: #005e54;
  color: #fff;
  padding: 0 8px;
  font-size: 24px;
  position: relative;
  z-index: 1;
}

.user-bar:after {
  content: "";
  display: table;
  clear: both;
}

.user-bar div {
  float: left;
  transform: translateY(-50%);
  position: relative;
  top: 50%;
}

.user-bar .actions {
  float: right;
  margin: 0 0 0 20px;
}

.user-bar .actions.more {
  margin: 0 12px 0 32px;
}

.user-bar .actions.attachment {
  margin: 0 0 0 30px;
}

.user-bar .actions.attachment i {
  display: block;
  transform: rotate(-45deg);
}

.user-bar .avatar {
  margin: 0 0 0 5px;
  width: 36px;
  height: 36px;
}

.user-bar .avatar img {
  border-radius: 50%;
  box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1);
  display: block;width: 100%;
}

.user-bar .name {
  font-size: 17px;
  font-weight: 600;
  text-overflow: ellipsis;
  letter-spacing: 0.3px;
  margin: 0 0 0 8px;
  overflow: hidden;
  white-space: nowrap;
  width: auto;
}

.user-bar .status {
  display: block;
  font-size: 13px;
  font-weight: 400;
  letter-spacing: 0;
  width:auto;
}

.conversation {
  height: calc(100% - 12px);
  position: relative;
  background: #efe7dd url("https://cloud.githubusercontent.com/assets/398893/15136779/4e765036-1639-11e6-9201-67e728e86f39.jpg") repeat;
  z-index: 0;
}

.conversation ::-webkit-scrollbar {
  transition: all .5s;
  width: 5px;
  height: 1px;
  z-index: 10;
}

.conversation ::-webkit-scrollbar-track {
  background: transparent;
}

.conversation ::-webkit-scrollbar-thumb {
  background: #b3ada7;
}

.conversation .conversation-container {
  height: calc(100% - 68px);
  box-shadow: inset 0 10px 10px -10px #000000;
  overflow-x: hidden;
  padding: 0 16px;
  margin-bottom: 5px;
}

.conversation .conversation-container:after {
  content: "";
  display: table;
  clear: both;
}

.message {
  color: #000;
clear: both;
  line-height: 18px;
  font-size: 15px;
  padding: 8px;
  position: relative;
  margin: 8px 0;
  max-width: 80%;
  word-wrap: break-word;

}

.message:after {
  position: absolute;
  content: "";
  width: 0;
  height: 0;
  border-style: solid;
}

.metadata {
  display: inline-block;
  float: right;
  padding: 0 0 0 7px;
  position: relative;
  bottom: -4px;
}
.metadata .time {
  color: rgba(0, 0, 0, .45);
  font-size: 11px;
  display: inline-block;
}

.metadata .tick {
  display: inline-block;
  margin-left: 2px;
  position: relative;
  top: 4px;
  height: 16px;
  width: 16px;
}

.metadata .tick svg {
  position: absolute;
  transition: .5s ease-in-out;
}

.metadata .tick svg:first-child {
  -webkit-backface-visibility: hidden;
          backface-visibility: hidden;
  -webkit-transform: perspective(800px) rotateY(180deg);
          transform: perspective(800px) rotateY(180deg);
}

.metadata .tick svg:last-child {
  -webkit-backface-visibility: hidden;
          backface-visibility: hidden;
  -webkit-transform: perspective(800px) rotateY(0deg);
          transform: perspective(800px) rotateY(0deg);
}

.metadata .tick-animation svg:first-child {
  -webkit-transform: perspective(800px) rotateY(0);
          transform: perspective(800px) rotateY(0);
}

.metadata .tick-animation svg:last-child {
  -webkit-transform: perspective(800px) rotateY(-179.9deg);
transform: perspective(800px) rotateY(-179.9deg);
}

.message:first-child {
  margin: 16px 0 8px;
}

.message.received {
  background: #fff;
  border-radius: 0px 5px 5px 5px;
  float: left;
}

.message.received .metadata {
  padding: 0 0 0 16px;
}

.message.received:after {
  border-width: 0px 10px 10px 0;
  border-color: transparent #fff transparent transparent;
  top: 0;left: -10px;
}

.message.sent {
  background: #e1ffc7;
  border-radius: 5px 0px 5px 5px;
  float: right;
}

.message.sent:after {
  border-width: 0px 0 10px 10px;
  border-color: transparent transparent transparent #e1ffc7;
  top: 0;
  right: -10px;
}


.conversation-compose {
  display: flex;
  flex-direction: row;
align-items: flex-end;
  overflow: hidden;
  height: 50px;
  width: 100%;
  z-index: 2;
}

.conversation-compose div,
.conversation-compose input {
  background: #fff;
  height: 100%;
}

.conversation-compose .emoji {
  display: flex;
  align-items: center;
  justify-content: center;
  background: white;
  border-radius: 5px 0 0 5px;
  flex: 0 0 auto;
  margin-left: 8px;
  width: 48px;
}

.conversation-compose .input-msg {
  border: 0;
  flex: 1 1 auto;
  font-size: 16px;
  margin: 0;
  outline: none;
  min-width: 50px;
}

.conversation-compose .photo {
  flex: 0 0 auto;
  border-radius: 0 0 5px 0;
  text-align: center;
  position: relative;
  width: 48px;
}

.conversation-compose .photo:after {
  border-width: 0px 0 10px 10px;
  border-color: transparent transparent transparent #fff;
border-style: solid;
  position: absolute;
  width: 0;
  height: 0;
  content: "";
  top: 0;
  right: -10px;
}

.conversation-compose .photo i {
  display: block;
  color: #7d8488;
  font-size: 24px;
  transform: translate(-50%, -50%);
  position: relative;
  top: 50%;
  left: 50%;
}

.conversation-compose .send {
  background: transparent;
  border: 0;
cursor: pointer;
  flex: 0 0 auto;
  margin-left: 8px;
  margin-right: 8px;
  padding: 0;
  position: relative;
  outline: none;
}

.conversation-compose .send .circle {
  background: #008a7c;
  border-radius: 50%;
  color: #fff;
  position: relative;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.conversation-compose .send .circle i {
  font-size: 24px;
  margin-left: 5px;
}



  .marvel-device .status-bar {
    display: none;
  }

  .screen-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  .conversation {
    height: calc(100vh - 55px);
  }
  .conversation .conversation-container {
    height: calc(100vh - 120px);
  }
.back{
    font-size:30px;
    float:left;
}
.forword{
    font-size:30px;
    float:right;
}
    </style>


    <!-- Appointment Notifications -->
    <script src="appointment-notifications.js" defer></script>

    <!-- PWA Installation System -->
    <script src="pwa-install-cta.js" defer></script>
    <script src="pwa-install-improved.js" defer></script>

    <!-- FAB Button CSS -->
    <style>
        /* Hide the chatbot's default FAB button */
        .chatbot-fab {
            display: none !important;
        }

        /* FAB Button Styles */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            font-family: inherit;
        }

        .fab-menu {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column-reverse;
            align-items: flex-end;
            gap: 12px;
        }

        .fab-menu-item {
            transform: scale(0);
            transform-origin: bottom right;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .fab-container.active .fab-menu-item {
            transform: scale(1);
        }

        .fab-menu-item:nth-child(1) {
            transition-delay: 0.05s;
        }

        .fab-menu-item:nth-child(2) {
            transition-delay: 0.1s;
        }

        .fab-menu-item:nth-child(3) {
            transition-delay: 0.15s;
        }

        .fab-menu-item button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: white;
            color: #15696B;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .fab-menu-item button:hover {
            background: #f5f5f5;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .fab-menu-item button.chat-btn {
            background: #15696B;
            color: white;
        }

        .fab-menu-item button.chat-btn:hover {
            background: #0F4449;
        }

        .fab-menu-item button.import-btn {
            background: #15696B;
            color: white;
        }

        .fab-menu-item button.import-btn:hover {
            background: #0F4449;
        }

        .fab-button {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #15696B 0%, #0F4449 100%);
            color: white;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(21, 105, 107, 0.4);
            transition: all 0.3s ease;
            position: relative;
            font-weight: bold;
            font-family: Arial, sans-serif;
        }

        .fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 28px rgba(21, 105, 107, 0.6);
        }

        .fab-button.active {
            transform: rotate(45deg);
        }

        .fab-button i {
            transition: transform 0.3s ease;
        }

        /* Tooltip styles */
        .fab-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            right: 70px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .fab-menu-item button:hover .fab-tooltip {
            opacity: 1;
        }

        /* Mobile responsiveness */
        @media (max-width: 576px) {
            .fab-container {
                bottom: 20px;
                right: 20px;
            }

            .fab-button {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }

            .fab-menu-item button {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }
        }
    </style>

    <!-- Theme Color Override -->
    <style>
        :root {
            --logo-flow: #15696B;
            --bs-primary: var(--logo-flow);
            --bs-primary-rgb: 21, 105, 107;
            --bs-link-color: var(--logo-flow);
            --bs-link-hover-color: #0F4449;
        }

        /* Fix SweetAlert2 input interaction - AGGRESSIVE */
        .swal2-popup {
            pointer-events: auto !important;
        }

        .swal2-html-container {
            pointer-events: auto !important;
        }

        .swal2-html-container * {
            pointer-events: auto !important;
        }

        .swal2-html-container input,
        .swal2-html-container select,
        .swal2-html-container textarea,
        input#editFullname,
        input#editEmail,
        select#editRole,
        input#editActive {
            pointer-events: auto !important;
            cursor: text !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            position: relative !important;
            z-index: 1060 !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
        }

        input#editFullname:focus,
        input#editEmail:focus,
        select#editRole:focus,
        input#editActive:focus {
            outline: 2px solid #15696B !important;
            outline-offset: 2px !important;
        }

        /* AirDatepicker styles for SweetAlert2 modal */
        .air-datepicker {
            position: fixed !important;
            z-index: 9999 !important;
            pointer-events: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .air-datepicker-input {
            position: relative !important;
            z-index: 1061 !important;
            pointer-events: auto !important;
            cursor: text !important;
        }

        .air-datepicker-input:focus {
             outline: 2px solid #15696B !important;
             outline-offset: 2px !important;
         }

        /* Improved User Profile Dropdown Styles */
        .dropdown-menu {
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        #userSettings + .dropdown-menu a:hover {
            background-color: #f8f9fa;
        }

        #userSettings + .dropdown-menu a:active,
        #userSettings + .dropdown-menu a:focus {
            background-color: #e9ecef;
        }

        .dropdown-menu .avatar-box {
            background: linear-gradient(135deg, #15696B 0%, #0F4449 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            min-width: 48px;
        }

        #subscriptionType {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, rgba(21, 105, 107, 0.05) 0%, rgba(15, 68, 73, 0.05) 100%);
            padding: 8px 12px;
            border-radius: 6px;
        }

        /* Ensure datepicker is above SweetAlert2 */
        .swal2-container {
            z-index: 100 !important;
        }

        .swal2-popup {
            z-index: 101 !important;
        }

        .swal2-backdrop {
            z-index: 99 !important;
        }

        /* Force datepicker to be on top */
        .air-datepicker {
            z-index: 9999 !important;
            position: fixed !important;
        }

        .air-datepicker-body {
            z-index: 9999 !important;
        }

        .air-datepicker-pointer {
            z-index: 9999 !important;
        }

        .air-datepicker * {
            z-index: 9999 !important;
        }

        .swal2-html-container input[type="checkbox"],
        .swal2-html-container input[type="radio"],
        input#editActive {
            cursor: pointer !important;
            width: 18px !important;
            height: 18px !important;
        }

        .swal2-modal {
            pointer-events: auto !important;
            z-index: 1050 !important;
        }

        .swal2-backdrop {
            z-index: 1049 !important;
        }

        .swal2-icon,
        .swal2-loader {
            pointer-events: none !important;
        }

        .app-header {
            background-color: white !important;
        }

        /* Export Icons Styling */
        .export-icons-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            height: 38px;
        }

        .export-icon-btn {
            background: none;
            border: 1px solid #ccc;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 38px;
            height: 38px;
        }

        .export-excel-btn i {
            color: #00a651;
        }

        .export-pdf-btn i {
            color: #d32f2f;
        }

        .export-icon-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .export-excel-btn:hover {
            border-color: #00a651;
            background-color: rgba(0, 166, 81, 0.05);
        }

        .export-pdf-btn:hover {
            border-color: #d32f2f;
            background-color: rgba(211, 47, 47, 0.05);
        }

        /* Select2 Custom Styling */
        .select2-container--default .select2-dropdown {
            border-color: #ced4da;
            border-radius: 0.25rem;
        }

        .select2-container--default .select2-results>.select2-results__options {
            max-height: 250px;
        }

        .select2-container--default .select2-results__option {
            padding: 10px;
            text-align: left !important;
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #15696B;
        }

        .select2-container--default.select2-container--open .select2-selection--single {
            border-color: #15696B;
        }

        .select2-container--default .select2-selection--single {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            height: 38px;
            padding: 0 !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #495057;
            line-height: 36px;
            text-align: left !important;
            padding-left: 12px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
            right: 0 !important;
            width: 32px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow b {
            margin-top: -6px !important;
        }

        /* Wrapper alignment */
        .select2-container {
            width: 100% !important;
        }

        .select2-container--default.select2-container--focus .select2-selection--single {
            border-color: #15696B;
            box-shadow: 0 0 0 0.2rem rgba(21, 105, 107, 0.25);
        }

        /* SweetAlert2 modal adjustments for Select2 */
        .swal2-html-container {
            overflow: visible !important;
        }

        .swal2-popup {
            overflow: visible !important;
            z-index: 1055 !important;
        }

        .swal2-container {
            z-index: 1050 !important;
        }

        /* Ensure action buttons appear below dropdown */
        .swal2-actions {
            z-index: auto !important;
            position: relative;
        }

        /* Select2 dropdown styling */
        .select2-dropdown {
            z-index: 10000 !important;
            margin-top: 5px;
            position: absolute !important;
        }

        .select2-dropdown--above {
            margin-top: 0;
            margin-bottom: 5px;
        }

        .select2-dropdown--below {
            margin-top: 5px;
        }

        .select2-results {
            max-height: 250px !important;
            overflow-y: auto !important;
        }

        .select2-container--open {
            z-index: 999999 !important;
        }

        .swal2-html-container select.form-control {
            margin-bottom: 0;
        }

        /* Air Datepicker styling */
        .air-datepicker {
            z-index: 10000 !important;
        }

        .air-datepicker-input {
            width: 100%;
        }

        /* Modal Table No Wrap */
        #statDetailModal .table td,
        #statDetailModal .table th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Spinner Animation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* SweetAlert2 Modal Z-Index Fix - Highest Priority */
        .swal2-container.swal2-shown {
            z-index: 99999 !important;
        }

        .swal2-container {
            z-index: 99999 !important;
            position: fixed !important;
        }

        .swal2-backdrop {
            z-index: 99998 !important;
        }

        .swal2-popup {
            z-index: 100000 !important;
            position: fixed !important;
        }

        .swal2-popup * {
            pointer-events: auto !important;
        }

        /* User Management Modal - Lower Z-Index */
        .modal#userManagementModal {
            z-index: 1050 !important;
        }

        .modal-backdrop {
            z-index: 1049 !important;
        }

        /* SweetAlert2 Form Input Fix */
        .swal2-html-container {
            overflow: visible !important;
            pointer-events: auto !important;
        }

        .swal2-html-container input,
        .swal2-html-container select,
        .swal2-html-container textarea {
            width: 100% !important;
            padding: 0.5rem 0.75rem !important;
            border: 1px solid #ced4da !important;
            border-radius: 0.25rem !important;
            font-size: 1rem !important;
            color: #495057 !important;
            background-color: #fff !important;
            margin-bottom: 0.5rem !important;
            pointer-events: auto !important;
            cursor: text !important;
            position: relative !important;
            z-index: 10 !important;
        }

        .swal2-html-container input:focus,
        .swal2-html-container select:focus,
        .swal2-html-container textarea:focus {
            outline: none !important;
            border-color: #15696B !important;
            box-shadow: 0 0 0 0.2rem rgba(21, 105, 107, 0.25) !important;
        }

        .swal2-html-container label {
            display: block !important;
            margin-bottom: 0.3rem !important;
            font-weight: 500 !important;
            font-size: 0.9rem !important;
            color: #333 !important;
            pointer-events: auto !important;
        }

        .swal2-html-container .form-check-label {
            display: flex !important;
            align-items: center !important;
            margin-bottom: 0.5rem !important;
            font-weight: normal !important;
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        .swal2-html-container .form-check-label input {
            width: auto !important;
            margin-right: 0.5rem !important;
            margin-bottom: 0 !important;
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        /* Wizard Form Button Styling */
        .wizard-btn {
            padding: 10px 24px;
            font-weight: 500;
            font-size: 14px;
            border-radius: 0.35rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 100px;
        }

        .wizard-btn-primary {
            background-color: #15696B;
            color: white;
            border: 1px solid #15696B;
        }

        .wizard-btn-primary:hover {
            background-color: #0F4449;
            border-color: #0F4449;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(21, 105, 107, 0.3);
        }

        .wizard-btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(21, 105, 107, 0.2);
        }

        .wizard-btn-success {
            background-color: #28a745;
            color: white;
            border: 1px solid #28a745;
        }

        .wizard-btn-success:hover {
            background-color: #218838;
            border-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .wizard-btn-success:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2);
        }

        .wizard-btn-secondary {
            background-color: #6c757d;
            color: white;
            border: 1px solid #6c757d;
        }

        .wizard-btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .wizard-btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(108, 117, 125, 0.2);
        }

        .wizard-btn-outline {
            background-color: transparent;
            color: #15696B;
            border: 1.5px solid #15696B;
        }

        .wizard-btn-outline:hover {
            background-color: #f0f5f5;
            border-color: #0F4449;
            color: #0F4449;
            transform: translateY(-2px);
        }

        .wizard-btn-outline:active {
            transform: translateY(0);
        }

        .wizard-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .wizard-btn:disabled:hover {
            background-color: inherit;
            border-color: inherit;
            transform: none;
            box-shadow: none;
        }
    </style>

    <!-- *************
		************ Vendor Css Files *************
	************ -->

    <!-- Scrollbar CSS -->
    <link rel="stylesheet" href="assets/css/OverlayScrollbars.min.css">
</head>

<body>

    <!-- Loading starts -->
    <div id="loading-wrapper">
        <div class='spin-wrapper'>
            <div class='spin'>
                <div class='inner'></div>
            </div>
            <div class='spin'>
                <div class='inner'></div>
            </div>
            <div class='spin'>
                <div class='inner'></div>
            </div>
            <div class='spin'>
                <div class='inner'></div>
            </div>
            <div class='spin'>
                <div class='inner'></div>
            </div>
            <div class='spin'>
                <div class='inner'></div>
            </div>
        </div>
    </div>
    <!-- Loading ends -->

    <!-- Page wrapper starts -->
    <div class="page-wrapper">

        <!-- App header starts -->
        <div class="app-header d-flex align-items-center">

            <!-- Toggle buttons starts -->
            <div class="d-flex">
                <button class="toggle-sidebar">
                    <i class="ri-menu-line"></i>
                </button>
                <button class="pin-sidebar">
                    <i class="ri-menu-line"></i>
                </button>
            </div>
            <!-- Toggle buttons ends -->

            <!-- App brand starts -->
            <div class="app-brand ms-3">
                <a href="index.html" class="d-lg-block d-none">
                    <img src="assets/images/logo.png" class="logo" alt="HealthFlow Admin Template">
                </a>
                <a href="index.html" class="d-lg-none d-md-block">
                    <img src="assets/images/logo.png" class="logo" alt="HealthFlow Admin Template">
                </a>
            </div>
            <!-- App brand ends -->

            <!-- App header actions starts -->
            <div class="header-actions">

                <!-- Search container starts -->
                <div class="search-container d-lg-block d-none mx-3">
                    <input type="text" class="form-control" id="searchId" placeholder="Search">
                    <i class="ri-search-line"></i>
                </div>
                <!-- Search container ends -->

                <!-- Header actions starts -->
                <div class="d-lg-flex d-none gap-2">

                    <!-- Select country dropdown starts -->
                    <div class="dropdown">
                        <a class="dropdown-toggle header-icon" href="#!" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <img src="assets/images/flags/1x1/fr.svg" class="header-country-flag"
                                alt="Bootstrap Dashboards">
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-mini">
                            <div class="country-container">
                                <a href="index.html" class="py-2">
                                    <img src="assets/images/flags/1x1/us.svg" alt="Admin Panel">
                                </a>
                                <a href="index.html" class="py-2">
                                    <img src="assets/images/flags/1x1/in.svg" alt="Admin Panels">
                                </a>
                                <a href="index.html" class="py-2">
                                    <img src="assets/images/flags/1x1/br.svg" alt="Admin Dashboards">
                                </a>
                                <a href="index.html" class="py-2">
                                    <img src="assets/images/flags/1x1/tr.svg" alt="Admin Templatess">
                                </a>
                                <a href="index.html" class="py-2">
                                    <img src="assets/images/flags/1x1/gb.svg" alt="Google Admin">
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Select country dropdown ends -->

                    <!-- Notifications dropdown starts -->
                    <div class="dropdown">
                        <a class="dropdown-toggle header-icon" href="#!" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="ri-list-check-3"></i>
                            <span class="count-label warning"></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-300">
                            <h5 class="fw-semibold px-3 py-2 text-primary">Activity</h5>

                            <!-- Scroll starts -->
                            <div class="scroll300">

                                <!-- Activity List Starts -->
                                <div class="p-3">
                                    <ul class="p-0 activity-list2">
                                        <li class="activity-item pb-3 mb-3">
                                            <a href="#!">
                                                <h5 class="fw-regular">
                                                    <i class="ri-circle-fill text-danger me-1"></i>
                                                    Invoices.
                                                </h5>
                                                <div class="ps-3 ms-2 border-start">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="flex-shrink-0">
                                                            <img src="assets/images/products/1.jpg"
                                                                class="img-shadow img-3x rounded-1"
                                                                alt="Hospital Admin Templates">
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            23 invoices have been paid to the MediCare Labs.
                                                        </div>
                                                    </div>
                                                    <p class="m-0 small">10:20AM Today</p>
                                                </div>
                                            </a>
                                        </li>
                                        <li class="activity-item pb-3 mb-3">
                                            <a href="#!">
                                                <h5 class="fw-regular">
                                                    <i class="ri-circle-fill text-info me-1"></i>
                                                    Purchased.
                                                </h5>
                                                <div class="ps-3 ms-2 border-start">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="flex-shrink-0">
                                                            <img src="assets/images/products/2.jpg"
                                                                class="img-shadow img-3x rounded-1"
                                                                alt="Hospital Admin Templates">
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            28 new surgical equipments have been purchased.
                                                        </div>
                                                    </div>
                                                    <p class="m-0 small">04:30PM Today</p>
                                                </div>
                                            </a>
                                        </li>
                                        <li class="activity-item pb-3 mb-3">
                                            <a href="#!">
                                                <h5 class="fw-regular">
                                                    <i class="ri-circle-fill text-success me-1"></i>
                                                    Appointed.
                                                </h5>
                                                <div class="ps-3 ms-2 border-start">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="flex-shrink-0">
                                                            <img src="assets/images/products/8.jpg"
                                                                class="img-shadow img-3x rounded-1"
                                                                alt="Hospital Admin Templates">
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            36 new doctors and 28 staff members appointed.
                                                        </div>
                                                    </div>
                                                    <p class="m-0 small">06:50PM Today</p>
                                                </div>
                                            </a>
                                        </li>
                                        <li class="activity-item">
                                            <a href="#!">
                                                <h5 class="fw-regular">
                                                    <i class="ri-circle-fill text-warning me-1"></i>
                                                    Requested
                                                </h5>
                                                <div class="ps-3 ms-2 border-start">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="flex-shrink-0">
                                                            <img src="assets/images/products/9.jpg"
                                                                class="img-shadow img-3x rounded-1"
                                                                alt="Hospital Admin Templates">
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            Requested for 6 new vehicles for medical emergency. .
                                                        </div>
                                                    </div>
                                                    <p class="m-0 small">08:30PM Today</p>
                                                </div>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                <!-- Activity List Ends -->

                            </div>
                            <!-- Scroll ends -->

                            <!-- View all button starts -->
                            <div class="d-grid m-3">
                                <a href="javascript:void(0)" class="btn btn-primary">View all</a>
                            </div>
                            <!-- View all button ends -->

                        </div>
                    </div>
                    <!-- Notifications dropdown ends -->

                    <!-- Notifications dropdown starts -->
                    <div class="dropdown">
                        <a class="dropdown-toggle header-icon" href="#!" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="ri-alarm-warning-line"></i>
                            <span class="count-label success"></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-300">
                            <h5 class="fw-semibold px-3 py-2 text-primary">Alerts</h5>

                            <!-- Scroll starts -->
                            <div class="scroll300">

                                <!-- Alert list starts -->
                                <div class="p-3">
                                    <div class="d-flex py-2">
                                        <div class="icon-box md bg-info rounded-circle me-3">
                                            <span class="fw-bold fs-6 text-white">DS</span>
                                        </div>
                                        <div class="m-0">
                                            <h6 class="mb-1 fw-semibold">Douglass Shaw</h6>
                                            <p class="mb-1">
                                                Appointed as a new President 2014-2025
                                            </p>
                                            <p class="small m-0 opacity-50">Today, 07:30pm</p>
                                        </div>
                                    </div>
                                    <div class="d-flex py-2">
                                        <div class="icon-box md bg-danger rounded-circle me-3">
                                            <span class="fw-bold fs-6 text-white">WG</span>
                                        </div>
                                        <div class="m-0">
                                            <h6 class="mb-1 fw-semibold">Willie Garrison</h6>
                                            <p class="mb-1">
                                                Congratulate, James for new job.
                                            </p>
                                            <p class="small m-0 opacity-50">Today, 08:00pm</p>
                                        </div>
                                    </div>
                                    <div class="d-flex py-2">
                                        <div class="icon-box md bg-warning rounded-circle me-3">
                                            <span class="fw-bold fs-6 text-white">TJ</span>
                                        </div>
                                        <div class="m-0">
                                            <h6 class="mb-1 fw-semibold">Terry Jenkins</h6>
                                            <p class="mb-1">
                                                Lewis added new doctors training schedule.
                                            </p>
                                            <p class="small m-0 opacity-50">Today, 09:30pm</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- Alert list ends -->

                            </div>
                            <!-- Scroll ends -->

                            <!-- View all button starts -->
                            <div class="d-grid m-3">
                                <a href="javascript:void(0)" class="btn btn-primary">View all</a>
                            </div>
                            <!-- View all button ends -->

                        </div>
                    </div>
                    <!-- Notifications dropdown ends -->

                    <!-- Messages dropdown starts -->
                    <div class="dropdown">
                        <a class="dropdown-toggle header-icon" href="#!" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="ri-message-3-line"></i>
                            <span class="count-label"></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-300">
                            <h5 class="fw-semibold px-3 py-2 text-primary">Messages</h5>

                            <!-- Scroll starts -->
                            <div class="scroll300">

                                <!-- Messages list starts -->
                                <div class="p-3">
                                    <div class="d-flex py-2">
                                        <img src="assets/images/user3.png" class="img-shadow img-3x me-3 rounded-5"
                                            alt="Hospital Admin Templates">
                                        <div class="m-0">
                                            <h6 class="mb-1 fw-semibold">LOHDA BABBU</h6>
                                            <p class="mb-1">
                                                Appointed as a new President 2014-2025
                                            </p>
                                            <p class="small m-0 opacity-50">Today, 07:30pm</p>
                                        </div>
                                    </div>
                                    <div class="d-flex py-2">
                                        <img src="assets/images/user1.png" class="img-shadow img-3x me-3 rounded-5"
                                            alt="Hospital Admin Templates">
                                        <div class="m-0">
                                            <h6 class="mb-1 fw-semibold">Clyde Fowler</h6>
                                            <p class="mb-1">
                                                Congratulate, James for new job.
                                            </p>
                                            <p class="small m-0 opacity-50">Today, 08:00pm</p>
                                        </div>
                                    </div>
                                    <div class="d-flex py-2">
                                        <img src="assets/images/user4.png" class="img-shadow img-3x me-3 rounded-5"
                                            alt="Hospital Admin Templates">
                                        <div class="m-0">
                                            <h6 class="mb-1 fw-semibold">Sophie Michiels</h6>
                                            <p class="mb-1">
                                                Lewis added new doctors training schedule.
                                            </p>
                                            <p class="small m-0 opacity-50">Today, 09:30pm</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- Messages list ends -->

                            </div>
                            <!-- Scroll ends -->

                            <!-- View all button starts -->
                            <div class="d-grid m-3">
                                <a href="javascript:void(0)" class="btn btn-primary">View all</a>
                            </div>
                            <!-- View all button ends -->

                        </div>
                    </div>
                </div>
                <!-- Header actions ends -->

                <!-- Header user settings starts -->
                <div class="dropdown ms-2">
                    <a id="userSettings" class="dropdown-toggle d-flex align-items-center" href="#!" role="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="avatar-box"><span id="userInitials">--</span><span class="status busy"></span></div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end shadow-lg" style="min-width: 280px;">
                        <!-- Profile Header -->
                        <div class="px-3 py-3" style="border-bottom: 1px solid #e9ecef;">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-box me-3" style="width: 48px; height: 48px; font-size: 20px;"><span id="userInitialsLarge">--</span></div>
                                <div class="flex-grow-1">
                                    <h6 class="m-0 fw-semibold" id="userName">Loading...</h6>
                                    <span class="small text-muted d-block" id="userRole">User</span>
                                </div>
                            </div>
                            <p class="m-0 small text-muted" id="facilityName">
                                <i class="ri-building-line me-1"></i>Facility</p>
                            <p class="m-0 small mt-2" id="subscriptionType" style="color: #15696B; font-weight: 500; display: none;">
                                <i class="ri-vip-crown-line me-1"></i>Subscription: <span id="subTypeValue"></span></p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="px-3 py-3" style="border-bottom: 1px solid #e9ecef;">
                            <a href="#" class="d-flex align-items-center text-decoration-none text-dark small py-2 rounded-2" style="transition: all 0.3s ease;">
                                <i class="ri-user-line me-2"></i><span>Profile Settings</span>
                            </a>
                            <a href="#" class="d-flex align-items-center text-decoration-none text-dark small py-2 rounded-2" style="transition: all 0.3s ease;">
                                <i class="ri-settings-3-line me-2"></i><span>Account Settings</span>
                            </a>
                        </div>

                        <!-- Logout -->
                        <div class="px-3 py-2">
                            <button id="logoutBtn" class="btn btn-danger btn-sm w-100">
                                <i class="ri-logout-circle-line me-1"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Header user settings ends -->

            </div>
            <!-- App header actions ends -->

        </div>
        <!-- App header ends -->
        <!-- Main container starts -->
        <div class="main-container">
            <!-- Sidebar wrapper starts -->
            <nav id="sidebar" class="sidebar-wrapper">
                <!-- Sidebar profile starts -->
                <div class="sidebar-profile">
                    <img src="assets/images/user6.png" class="img-shadow img-3x me-3 rounded-5"
                        alt="Hospital Admin Templates">
                    <div class="m-0">
                        <h5 class="mb-1 profile-name text-nowrap text-truncate" id="sidebarUserName">Loading...</h5>
                        <p class="m-0 small profile-name text-nowrap text-truncate" id="sidebarUserRole">User</p>
                    </div>
                </div>
                <!-- Sidebar profile ends -->

                <!-- Sidebar menu starts -->
                <div class="sidebarMenuScroll">
                    <ul class="sidebar-menu">
                        <li class="active current-page">
                            <a href="index.html">
                                <i class="ri-home-6-line"></i>
                                <span class="menu-text">Hospital Dashboard</span>
                            </a>
                        </li>



                        <li class="treeview">
                            <a href="#!">
                                <i class="ri-heart-pulse-line"></i>
                                <span class="menu-text">Patients</span>
                            </a>
                            <ul class="treeview-menu">
                                <li>
                                    <a href="#">Patients Dashboard</a>
                                </li>
                                <li>
                                    <a href="#">Patients List</a>
                                </li>
                                <li>
                                    <a href="#">Add Patient</a>
                                </li>
                                <li>
                                    <a href="#">Edit Patient Details</a>
                                </li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#!">
                                <i class="ri-nurse-line"></i>
                                <span class="menu-text">Staff</span>
                            </a>
                            <ul class="treeview-menu">
                                <li>
                                    <a href="#">Staff List</a>
                                </li>
                                <li>
                                    <a href="#">Add Staff</a>
                                </li>
                                <li>
                                    <a href="#">Edit Staff Details</a>
                                </li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#!">
                                <i class="ri-dossier-line"></i>
                                <span class="menu-text">Appointments</span>
                            </a>
                            <ul class="treeview-menu">
                                <li>
                                    <a href="#">Appointments</a>
                                </li>
                                <li>
                                    <a href="#">Appointments List</a>
                                </li>
                                <li>
                                    <a href="#">Book Appointment</a>
                                </li>
                                <li>
                                    <a href="#">Edit Appointment</a>
                                </li>
                            </ul>
                        </li>

                        <li class="treeview">
                            <a href="#!">
                                <i class="ri-secure-payment-line"></i>
                                <span class="menu-text">Accounts</span>
                            </a>
                            <ul class="treeview-menu">
                                <li>
                                    <a href="#!" onclick="openUserManagementModal()">Users</a>
                                </li>
                                <li>
                                    <a href="#">Payments</a>
                                </li>

                            </ul>
                        </li>








                        <li class="treeview">
                            <a href="#!">
                                <i class="ri-login-circle-line"></i>
                                <span class="menu-text">Login/Signup</span>
                            </a>
                            <ul class="treeview-menu">
                                <li>
                                    <a href="#">Login</a>
                                </li>
                                <li>
                                    <a href="#">Signup</a>
                                </li>
                                <li>
                                    <a href="#">Forgot Password</a>
                                </li>
                                <li>
                                    <a href="#">Reset Password</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a href="#">
                                <i class="ri-alert-line"></i>
                                <span class="menu-text">Page Not Found</span>
                            </a>
                        </li>



                    </ul>
                </div>
                <!-- Sidebar menu ends -->

                <!-- Sidebar contact starts -->
                <div class="sidebar-contact">
                    <p class="fw-light mb-1 text-nowrap text-truncate">Emergency Contact</p>
                    <h5 class="m-0 lh-1 text-nowrap text-truncate">0987654321</h5>
                    <i class="ri-phone-line"></i>
                </div>
                <!-- Sidebar contact ends -->

            </nav>
            <!-- Sidebar wrapper ends -->

            <style>
                @media (max-width: 1024px) {
                    #leftChatSidebar {
                        position: fixed;
                        left: 0;
                        top: 0;
                        width: 280px;
                        height: 100vh;
                        z-index: 10001;
                        transform: translateX(-100%);
                        transition: transform 0.3s ease;
                    }
                    
                    #leftChatSidebar.open {
                        transform: translateX(0);
                    }
                    
                    #rightChatSidebar {
                        position: fixed;
                        right: 0;
                        top: 0;
                        width: 280px;
                        height: 100vh;
                        z-index: 10001;
                        transform: translateX(100%);
                        transition: transform 0.3s ease;
                    }
                    
                    #rightChatSidebar.open {
                        transform: translateX(0);
                    }
                    
                    #chatInterface::before {
                        content: '';
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        z-index: 10000;
                        opacity: 0;
                        pointer-events: none;
                        transition: opacity 0.3s ease;
                    }
                    
                    #chatInterface.show-sidebar::before {
                        opacity: 1;
                        pointer-events: auto;
                    }
                }
            </style>

            <!-- Chat Interface - ChatONN Design -->
            <div id="chatInterface" style="display: none; position: fixed; right: 0; top: 0; width: 100%; height: 100vh; z-index: 9000; background: linear-gradient(135deg, #734CF4 0%, #9966FF 100%); padding: 0; overflow: hidden;">
                <div style="width: 100%; height: 100%; display: flex; background: #FFFFFF; border-radius: 0; overflow: hidden; box-shadow: none;">
                    
                    <!-- Left Sidebar - Chat List -->
                    <div id="leftChatSidebar" style="width: 280px; background: #FFFFFF; border-right: 1px solid #F0F0F0; display: flex; flex-direction: column; min-height: 100vh;">
                        <div style="padding: 24px 20px; border-bottom: 1px solid #F0F0F0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
                                <h3 style="margin: 0; font-size: 24px; font-weight: 700; color: #1a1a1a;">Chats</h3>
                                <button onclick="closeChatInterface()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;"></button>
                            </div>
                            <input type="text" id="contactSearchInput" placeholder="Search..." style="width: 100%; padding: 10px 14px; border: 1px solid #E8E8E8; border-radius: 0; font-size: 13px; box-sizing: border-box; background: #F8F8F8; outline: none;">
                        </div>
                        <div id="contactsList" style="flex: 1; overflow-y: auto; padding: 8px 0;">
                            <!-- Contacts will be populated here -->
                        </div>
                    </div>

                    <!-- Center - Messages Area -->
                    <div style="flex: 1; display: flex; flex-direction: column; background: #FFFFFF; width: 100%; height: 100vh;">
                        <!-- Header with Contact Info -->
                        <div style="padding: 20px 24px; border-bottom: 1px solid #F0F0F0; background: #FFFFFF;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <button onclick="toggleLeftSidebar()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #999; display: none;" id="toggleLeftBtn"></button>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="position: relative;">
                                        <img id="selectedAvatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Default" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%;">
                                        <div style="position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #2DDC9A; border: 2px solid white; border-radius: 50%;"></div>
                                    </div>
                                    <div>
                                        <h4 id="selectedName" style="margin: 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">Kirti Yadav</h4>
                                        <p id="selectedStatus" style="margin: 0; font-size: 11px; color: #999;">Last seen 3 hours ago</p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button style="background: none; border: none; font-size: 18px; cursor: pointer; color: #999;"></button>
                                    <button style="background: none; border: none; font-size: 18px; cursor: pointer; color: #999;"></button>
                                    <button style="background: none; border: none; font-size: 18px; cursor: pointer; color: #999;"></button>
                                    <button onclick="toggleRightSidebar()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #999; display: none;" id="toggleRightBtn"></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Messages Container -->
                        <div id="ap" style="flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 50%, #F3F4F6 100%); background-attachment: fixed; position: relative;">
                            <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.03; pointer-events: none;" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#000" stroke-width="0.5"/>
                                    </pattern>
                                </defs>
                                <rect width="100%" height="100%" fill="url(#grid)" />
                            </svg>
                            <div style="text-align: center; color: #999; font-size: 13px; margin: 20px 0; position: relative; z-index: 1;">Today 12:31 AM</div>
                        </div>

                        <!-- Input Area -->
                        <div style="padding: 20px 24px; border-top: 1px solid #F0F0F0; background: #FFFFFF;">
                            <form id="form" style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" style="background: none; border: none; cursor: pointer; color: #999; padding: 0; display: flex; align-items: center; flex-shrink: 0;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
                                        <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0z"/>
                                    </svg>
                                </button>
                                <div style="flex: 1; position: relative; display: flex; align-items: center;">
                                    <input type="text" id="val" placeholder="Type a message here..." style="flex: 1; padding: 12px 50px 12px 16px; border: 1px solid #E8E8E8; border-radius: 0; font-size: 14px; outline: none; background: #F8F8F8; width: 100%; box-sizing: border-box;">
                                    <div style="position: absolute; right: 12px; display: flex; gap: 8px; pointer-events: all;">
                                        <button type="button" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #999; padding: 0; display: flex; align-items: center;"></button>
                                        <button type="button" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #999; padding: 0; display: flex; align-items: center;"></button>
                                    </div>
                                </div>
                                <button type="button" id="msend" style="background: #734CF4; color: white; border: none; padding: 10px 24px; border-radius: 0; font-weight: 600; cursor: pointer; font-size: 14px; flex-shrink: 0;"></button>
                            </form>
                        </div>
                    </div>

                    <!-- Right Sidebar - Notifications & Suggestions -->
                    <div id="rightChatSidebar" style="width: 280px; background: #FFFFFF; border-left: 1px solid #F0F0F0; display: flex; flex-direction: column; overflow: hidden; min-height: 100vh;">
                        <!-- Notifications Section -->
                        <div style="flex: 1; border-bottom: 1px solid #F0F0F0; overflow-y: auto; padding: 20px 16px;">
                            <h5 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 700; color: #1a1a1a;">Notifications</h5>
                            <div id="notificationsList" style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- Notifications will be populated here -->
                            </div>
                        </div>

                        <!-- Suggestions Section -->
                        <div style="flex: 1; overflow-y: auto; padding: 20px 16px;">
                            <h5 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 700; color: #1a1a1a;">Suggestions</h5>
                            <div id="suggestionsList" style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- Suggestions will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- App container starts -->
            <div class="app-container">

                <!-- App hero header starts -->
                <div class="app-hero-header d-flex align-items-center">

                    <!-- Breadcrumb starts -->
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <i class="ri-home-8-line lh-1 pe-3 me-3 border-end"></i>
                            <a href="index.html">Home</a>
                        </li>
                        <li class="breadcrumb-item text-primary" aria-current="page">
                            Dashboard
                        </li>
                    </ol>
                    <!-- Breadcrumb ends -->

                    <!-- Sales stats starts -->
                    <div class="ms-auto d-lg-flex d-none flex-row">
                        <div class="d-flex flex-row gap-1 day-sorting">
                            <button class="btn btn-sm btn-primary">Today</button>
                            <button class="btn btn-sm">7d</button>
                            <button class="btn btn-sm">2w</button>
                            <button class="btn btn-sm">1m</button>
                            <button class="btn btn-sm">3m</button>
                            <button class="btn btn-sm">6m</button>
                            <button class="btn btn-sm">1y</button>
                        </div>
                    </div>
                    <!-- Sales stats ends -->

                </div>
                <!-- App Hero header ends -->

                <!-- App body starts -->
                <div class="app-body">

                    <!-- Row starts -->
                    <div class="row gx-3">
                        <div class="col-xxl-12 col-sm-12">
                            <div class="card mb-3 bg-2">
                                <div class="card-body">
                                    <div class="py-4 px-3 text-white">
                                        <h6 id="greetingTime">Good Morning,</h6>
                                        <h2 id="greetingUserName">Loading...</h2>
                                        <h5>Your schedule today.</h5>
                                        <div class="mt-4 d-flex gap-3">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-box lg bg-arctic rounded-3 me-3">
                                                    <i class="ri-surgical-mask-line fs-4"></i>
                                                </div>
                                                <div class="d-flex flex-column">
                                                    <h2 class="m-0 lh-1" id="patientsCount">0</h2>
                                                    <p class="m-0">Patients</p>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <div class="icon-box lg bg-lime rounded-3 me-3">
                                                    <i class="ri-calendar-todo-line fs-4"></i>
                                                </div>
                                                <div class="d-flex flex-column">
                                                    <h2 class="m-0 lh-1" id="appointmentsCount">0</h2>
                                                    <p class="m-0">Appointments</p>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <div class="icon-box lg bg-peach rounded-3 me-3">
                                                    <i class="ri-alert-line fs-4"></i>
                                                </div>
                                                <div class="d-flex flex-column">
                                                    <h2 class="m-0 lh-1" id="criticalPatientsCount">0</h2>
                                                    <p class="m-0">Critical Patients</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Row ends -->

                    <!-- Row starts -->
                    <div class="row gx-3">
                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="p-2 border border-success rounded-circle me-3">
                                            <div class="icon-box md bg-success-subtle rounded-5">
                                                <i class="ri-surgical-mask-line fs-4 text-success"></i>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-column">
                                            <h2 class="lh-1" id="newPatientCount">0</h2>
                                            <p class="m-0">New Patients</p>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-1">
                                        <a class="text-success" href="javascript:void(0);">
                                            <span>View All</span>
                                            <i class="ri-arrow-right-line text-success ms-1"></i>
                                        </a>
                                        <div class="text-end">
                                            <p class="mb-0 text-success">+40%</p>
                                            <span class="badge bg-success-subtle text-success small">this month</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="p-2 border border-info rounded-circle me-3">
                                            <div class="icon-box md bg-info-subtle rounded-5">
                                                <i class="ri-user-follow-line fs-4 text-info"></i>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-column">
                                            <h2 class="lh-1" id="returnPatientCount">0</h2>
                                            <p class="m-0">Return Patients</p>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-1">
                                        <a class="text-info" href="javascript:void(0);">
                                            <span>View All</span>
                                            <i class="ri-arrow-right-line text-info ms-1"></i>
                                        </a>
                                        <div class="text-end">
                                            <p class="mb-0 text-info">+25%</p>
                                            <span class="badge bg-info-subtle text-info small">this month</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="p-2 border border-primary rounded-circle me-3">
                                            <div class="icon-box md bg-primary-subtle rounded-5">
                                                <i class="ri-lungs-line fs-4 text-primary"></i>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-column">
                                            <h2 class="lh-1">360</h2>
                                            <p class="m-0">OPD Patients</p>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-1">
                                        <a class="text-primary" href="javascript:void(0);">
                                            <span>View All</span>
                                            <i class="ri-arrow-right-line ms-1"></i>
                                        </a>
                                        <div class="text-end">
                                            <p class="mb-0 text-primary">+30%</p>
                                            <span class="badge bg-primary-subtle text-primary small">this month</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="p-2 border border-danger rounded-circle me-3">
                                            <div class="icon-box md bg-danger-subtle rounded-5">
                                                <i class="ri-microscope-line fs-4 text-danger"></i>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-column">
                                            <h2 class="lh-1">980</h2>
                                            <p class="m-0">Lab tests</p>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-end justify-content-between mt-1">
                                        <a class="text-danger" href="javascript:void(0);">
                                            <span>View All</span>
                                            <i class="ri-arrow-right-line ms-1"></i>
                                        </a>
                                        <div class="text-end">
                                            <p class="mb-0 text-danger">+60%</p>
                                            <span class="badge bg-danger-subtle text-danger small">this month</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- Row ends -->

                    <!-- Row starts -->
                    <div class="row gx-3">
                        <div class="col-xl-2 col-sm-6 col-12">
                            <button type="button" class="btn btn-link text-decoration-none p-0 w-100 text-start"
                                style="border: none; outline: none; box-shadow: none;"
                                data-bs-toggle="modal" data-bs-target="#statDetailModal"
                                onclick="openStatDetail('all-appointments', this)">
                                <div class="card mb-3" style="cursor: pointer; border: none; box-shadow: none;">
                                    <div class="card-body" style="padding: 0;">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="icon-box md rounded-5 bg-primary mb-3">
                                                <i class="ri-verified-badge-line fs-4 lh-1"></i>
                                            </div>
                                            <h6>Appointments</h6>
                                            <h2 class="text-primary m-0" id="totalAppointmentsCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div class="col-xl-2 col-sm-6 col-12">
                            <button type="button" class="btn btn-link text-decoration-none p-0 w-100 text-start"
                                style="border: none; outline: none; box-shadow: none;"
                                data-bs-toggle="modal" data-bs-target="#statDetailModal"
                                onclick="openStatDetail('next-week', this)">
                                <div class="card mb-3" style="cursor: pointer; border: none; box-shadow: none;">
                                    <div class="card-body" style="padding: 0;">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="icon-box md rounded-5 bg-success mb-3">
                                                <i class="ri-calendar-event-line fs-4 lh-1"></i>
                                            </div>
                                            <h6>Next Week</h6>
                                            <h2 class="text-success m-0" id="nextWeekAppointmentsCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div class="col-xl-2 col-sm-6 col-12">
                            <button type="button" class="btn btn-link text-decoration-none p-0 w-100 text-start"
                                style="border: none; outline: none; box-shadow: none;"
                                data-bs-toggle="modal" data-bs-target="#statDetailModal"
                                onclick="openStatDetail('overdue', this)">
                                <div class="card mb-3" style="cursor: pointer; border: none; box-shadow: none;">
                                    <div class="card-body" style="padding: 0;">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="icon-box md rounded-5 bg-danger mb-3">
                                                <i class="ri-time-line fs-4 lh-1"></i>
                                            </div>
                                            <h6>Overdue</h6>
                                            <h2 class="text-danger m-0" id="overdueAppointmentsCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div class="col-xl-2 col-sm-6 col-12">
                            <button type="button" class="btn btn-link text-decoration-none p-0 w-100 text-start"
                                style="border: none; outline: none; box-shadow: none;"
                                data-bs-toggle="modal" data-bs-target="#statDetailModal"
                                onclick="openStatDetail('missed', this)">
                                <div class="card mb-3" style="cursor: pointer; border: none; box-shadow: none;">
                                    <div class="card-body" style="padding: 0;">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="icon-box md rounded-5 bg-warning mb-3">
                                                <i class="ri-close-circle-line fs-4 lh-1"></i>
                                            </div>
                                            <h6>Missed</h6>
                                            <h2 class="text-warning m-0" id="missedAppointmentsCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div class="col-xl-2 col-sm-6 col-12">
                            <button type="button" class="btn btn-link text-decoration-none p-0 w-100 text-start"
                                style="border: none; outline: none; box-shadow: none;"
                                data-bs-toggle="modal" data-bs-target="#statDetailModal"
                                onclick="openStatDetail('high-viral', this)">
                                <div class="card mb-3" style="cursor: pointer; border: none; box-shadow: none;">
                                    <div class="card-body" style="padding: 0;">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="icon-box md rounded-5 bg-danger mb-3">
                                                <i class="ri-alert-line fs-4 lh-1"></i>
                                            </div>
                                            <h6>High Viraemia</h6>
                                            <h2 class="text-danger m-0" id="highViraemiaCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div class="col-xl-2 col-sm-6 col-12">
                            <button type="button" class="btn btn-link text-decoration-none p-0 w-100 text-start"
                                style="border: none; outline: none; box-shadow: none;"
                                data-bs-toggle="modal" data-bs-target="#statDetailModal"
                                onclick="openStatDetail('low-viral', this)">
                                <div class="card mb-3" style="cursor: pointer; border: none; box-shadow: none;">
                                    <div class="card-body" style="padding: 0;">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="icon-box md rounded-5 bg-info mb-3">
                                                <i class="ri-lungs-line fs-4 lh-1"></i>
                                            </div>
                                            <h6>Low Viraemia</h6>
                                            <h2 class="text-info m-0" id="lowViraemiaCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div class="col-xl-2 col-sm-6 col-12">
                            <button type="button" class="btn btn-link text-decoration-none p-0 w-100 text-start"
                                style="border: none; outline: none; box-shadow: none;"
                                data-bs-toggle="modal" data-bs-target="#statDetailModal"
                                onclick="openStatDetail('hypertension', this)">
                                <div class="card mb-3" style="cursor: pointer; border: none; box-shadow: none;">
                                    <div class="card-body" style="padding: 0;">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="icon-box md rounded-5 bg-danger mb-3">
                                                <i class="ri-pulse-line fs-4 lh-1"></i>
                                            </div>
                                            <h6>Hypertension</h6>
                                            <h2 class="text-danger m-0" id="hypertensionCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div class="col-xl-2 col-sm-6 col-12">
                            <button type="button" class="btn btn-link text-decoration-none p-0 w-100 text-start"
                                style="border: none; outline: none; box-shadow: none;"
                                data-bs-toggle="modal" data-bs-target="#statDetailModal"
                                onclick="openStatDetail('diabetes', this)">
                                <div class="card mb-3" style="cursor: pointer; border: none; box-shadow: none;">
                                    <div class="card-body" style="padding: 0;">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="icon-box md rounded-5 bg-warning mb-3">
                                                <i class="ri-capsule-line fs-4 lh-1"></i>
                                            </div>
                                            <h6>Diabetes</h6>
                                            <h2 class="text-warning m-0" id="diabetesCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>

                    </div>
                    <!-- Row ends -->

                    <!-- Row starts -->
                    <div class="row gx-3" id="patientsTable">
                        <div class="col-xxl-12 col-sm-12">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="card-title">All Patients</h5>
                                </div>
                                <div class="card-body">
                                    <!-- Search, Filter, Export Controls -->
                                    <div class="row mb-3 g-2">
                                        <div class="col-12 col-sm-6 col-md-4">
                                            <input type="text" class="form-control form-control-sm"
                                                id="patientSearchInput" placeholder="Search patients...">
                                        </div>
                                        <div class="col-12 col-sm-6 col-md-3">
                                            <select class="form-select form-select-sm" id="patientConditionFilter">
                                                <option value="">All Conditions</option>
                                                <option value="HIV">HIV</option>
                                                <option value="Diabetes">Diabetes</option>
                                                <option value="Hypertension">Hypertension</option>
                                                <option value="TB">TB</option>
                                            </select>
                                        </div>
                                        <div class="col-12 col-sm-6 col-md-3">
                                            <select class="form-select form-select-sm" id="patientStatusFilter">
                                                <option value="">All Status</option>
                                                <option value="Active">Active</option>
                                                <option value="Inactive">Inactive</option>
                                                <option value="Critical">Critical</option>
                                                <option value="Alert">Alert</option>
                                            </select>
                                        </div>
                                        <div class="col-12 col-sm-6 col-md-2">
                                            <div class="export-icons-container">
                                                <button class="export-icon-btn"
                                                    style="border-color: #15696B; background-color: rgba(21, 105, 107, 0.05);"
                                                    title="Add Patient" onclick="addNewPatient()">
                                                    <i class="ri-add-line" style="color: #15696B;"></i>
                                                </button>
                                                <button class="export-icon-btn export-excel-btn" title="Export to Excel"
                                                    onclick="exportPatientsToExcel()">
                                                    <i class="ri-file-excel-2-line"></i>
                                                </button>
                                                <button class="export-icon-btn export-pdf-btn" title="Export to PDF"
                                                    onclick="exportPatientsToPDF()">
                                                    <i class="ri-file-pdf-fill"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Responsive Table with Horizontal Scroll on Mobile -->
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm patients-table">
                                            <thead>
                                                <tr>
                                                    <th>Patient ID</th>
                                                    <th>Name</th>
                                                    <th>Age</th>
                                                    <th>Gender</th>
                                                    <th>Phone</th>
                                                    <th>Address</th>
                                                    <th>Condition</th>
                                                    <th>Status</th>
                                                    <th>HIV Status</th>
                                                    <th>Notes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="patientsTableBody">
                                                <tr>
                                                    <td colspan="8" class="text-center">Loading patients...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Pagination Controls -->
                                    <nav aria-label="Patient table pagination" class="mt-3">
                                        <ul class="pagination pagination-sm justify-content-center"
                                            id="patientsPagination">
                                            <li class="page-item">
                                                <button class="page-link" id="prevPageBtn"
                                                    onclick="previousPatientPage()">
                                                    <i class="ri-arrow-left-s-line"></i> <span
                                                        class="d-none d-sm-inline">Prev</span>
                                                </button>
                                            </li>
                                            <li class="page-item active" id="pageInfoLi">
                                                <span class="page-link" id="pageInfo">Page 1</span>
                                            </li>
                                            <li class="page-item">
                                                <button class="page-link" id="nextPageBtn" onclick="nextPatientPage()">
                                                    <span class="d-none d-sm-inline">Next</span> <i
                                                        class="ri-arrow-right-s-line"></i>
                                                </button>
                                            </li>
                                        </ul>
                                    </nav>
                                    <div class="text-center">
                                        <small class="text-muted" id="patientCountInfo">Showing 0 of 0 patients</small>
                                    </div>

                                    <!-- Responsive Table CSS -->
                                    <style>
                                        /* Horizontal scroll on mobile devices */
                                        @media (max-width: 767.98px) {
                                            .table-responsive {
                                                overflow-x: auto;
                                                -webkit-overflow-scrolling: touch;
                                                overflow-y: hidden;
                                            }

                                            .patients-table {
                                                min-width: 800px;
                                                font-size: 0.85rem;
                                                margin-bottom: 0;
                                            }

                                            .patients-table thead {
                                                position: sticky;
                                                top: 0;
                                                background-color: #f8f9fa;
                                                z-index: 10;
                                            }

                                            .patients-table th {
                                                padding: 0.75rem 0.5rem !important;
                                                white-space: nowrap;
                                                font-weight: 600;
                                                border-bottom: 2px solid #dee2e6;
                                            }

                                            .patients-table td {
                                                padding: 0.5rem !important;
                                                white-space: nowrap;
                                            }

                                            .badge {
                                                font-size: 0.7rem;
                                                padding: 0.35rem 0.5rem;
                                            }
                                        }

                                        /* Table adjustments for tablets and above */
                                        @media (min-width: 768px) {
                                            .patients-table {
                                                font-size: 0.95rem;
                                            }

                                            .patients-table th,
                                            .patients-table td {
                                                padding: 0.75rem !important;
                                            }
                                        }

                                        /* Standard scrollbar styling for mobile scroll */
                                        .table-responsive {
                                            scrollbar-width: thin;
                                            scrollbar-color: #15696B #f0f0f0;
                                        }

                                        .table-responsive::-webkit-scrollbar {
                                            height: 6px;
                                        }

                                        .table-responsive::-webkit-scrollbar-track {
                                            background: #f0f0f0;
                                            border-radius: 10px;
                                        }

                                        .table-responsive::-webkit-scrollbar-thumb {
                                            background: #15696B;
                                            border-radius: 10px;
                                        }

                                        .table-responsive::-webkit-scrollbar-thumb:hover {
                                            background: #0F4449;
                                        }
                                    </style>
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-6 col-sm-12">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="card-title">Patients</h5>
                                </div>
                                <div class="card-body">
                                    <!-- Chart removed - card only -->
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-6 col-sm-12">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="card-title">Treatment Type</h5>
                                </div>
                                <div class="card-body">
                                    <div id="treatment"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-6 col-sm-12">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="card-title">Hospital Earnings</h5>
                                </div>
                                <div class="card-body">
                                </div>
                            </div>
                        </div>

                        <div class="col-xxl-3 col-sm-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="card-title">Insurance Claims</h5>
                                </div>
                                <div class="card-body">
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-3 col-sm-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="card-title">Patients by Gender</h5>
                                </div>
                                <div class="card-body">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Row ends -->

                    <!-- Patient Medical History & Appointments Section -->
                    <div class="row gx-3" id="patient-records" style="display: none;">
                        <div class="col-12">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="ri-file-medical-line me-2"></i>Patient Medical History & Appointments
                                    </h5>
                                    <small class="text-muted d-block mt-2">Click "View Details" button on any patient in
                                        the table above to display their information</small>
                                </div>
                                <div class="card-body">
                                    <!-- Tabs for Medical History and Appointments -->
                                    <ul class="nav nav-tabs mb-4" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="medical-history-tab"
                                                data-bs-toggle="tab" data-bs-target="#medical-history-content"
                                                type="button" role="tab" aria-controls="medical-history-content"
                                                aria-selected="true">
                                                <i class="ri-file-text-line me-2"></i>Medical History
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="appointments-tab" data-bs-toggle="tab"
                                                data-bs-target="#appointments-content" type="button" role="tab"
                                                aria-controls="appointments-content" aria-selected="false">
                                                <i class="ri-calendar-line me-2"></i>Appointments
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="clinical-notes-tab" data-bs-toggle="tab"
                                                data-bs-target="#clinical-notes-content" type="button" role="tab"
                                                aria-controls="clinical-notes-content" aria-selected="false">
                                                <i class="ri-note-line me-2"></i>Clinical Notes
                                            </button>
                                        </li>
                                    </ul>

                                    <!-- Tab Content -->
                                    <div class="tab-content">
                                        <!-- Medical History Tab -->
                                        <div class="tab-pane fade show active" id="medical-history-content"
                                            role="tabpanel" aria-labelledby="medical-history-tab">
                                            <div id="medicalHistoryContent">
                                                <p class="text-muted text-center py-5">
                                                    <i class="ri-eye-line me-2" style="font-size: 2rem;"></i><br>
                                                    Click the <strong>View Details</strong> button on any patient in the
                                                    table above
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Appointments Tab -->
                                        <div class="tab-pane fade" id="appointments-content" role="tabpanel"
                                            aria-labelledby="appointments-tab">
                                            <div id="appointmentsContent">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0" id="appointmentsTable">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Patient Name</th>
                                                                <th>Appointment Date</th>
                                                                <th>Time</th>
                                                                <th>Status</th>
                                                                <th>Type</th>
                                                                <th>Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="appointmentsTableBody">
                                                            <tr>
                                                                <td colspan="6" class="text-center text-muted py-4">
                                                                    No appointments scheduled
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Clinical Notes Tab -->
                                        <div class="tab-pane fade" id="clinical-notes-content" role="tabpanel"
                                            aria-labelledby="clinical-notes-tab">
                                            <div id="clinicalNotesContent">
                                                <p class="text-muted text-center py-4">
                                                    <i class="ri-file-text-line me-2"></i>Select a patient to view
                                                    clinical notes
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Patient Medical History & Appointments Section Ends -->

                </div>
                <!-- App body ends -->

                <!-- App footer starts -->
                <div class="app-footer bg-white">
                    <span> HealthFlow 2025</span>
                </div>
                <!-- App footer ends -->

            </div>
            <!-- App container ends -->

        </div>
        <!-- Main container ends -->

    </div>
    <!-- Page wrapper ends -->

    <!-- Stat Detail Modal -->
    <div class="modal fade" id="statDetailModal" tabindex="-1" aria-labelledby="statDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statDetailModalLabel">Detail View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="statDetailContent">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-success" id="exportExcelBtn"
                            onclick="exportStatToExcel()">
                            <i class="ri-file-excel-line me-1"></i>Export Excel
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="exportPdfBtn"
                            onclick="exportStatToPdf()">
                            <i class="ri-file-pdf-line me-1"></i>Export PDF
                        </button>
                    </div>
                    <div class="d-flex gap-2 ms-auto">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="viewAllBtn" onclick="viewAllInTable()">View
                            All in Table</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userManagementModal" tabindex="-1" aria-labelledby="userManagementModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #15696B; color: white;">
                    <h5 class="modal-title" id="userManagementModalLabel">User Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">System Users</h6>
                        <button type="button" class="btn btn-sm btn-primary" onclick="openCreateUserModal()">
                            <i class="ri-add-line"></i> Create New User
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Created Date</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i>
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #15696B; color: white;">
                    <h5 class="modal-title">Create New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div id="createUserMessage" style="display: none;"></div>
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="newUserFullname" placeholder="John Doe"
                                required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="newUserEmail" placeholder="john@example.com"
                                required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" id="newUserUsername" placeholder="@johndoe123"
                                readonly>
                            <small class="text-muted">Auto-generated from full name</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role *</label>
                            <select class="form-control" id="newUserRole" required onchange="handleRoleChange()">
                                <option value="">Select a role</option>
                                <option value="patient">Patient</option>
                                <option value="admin">Admin</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                        <!-- Patient Selection Field (shown only when Patient role is selected) -->
                        <div class="mb-3" id="patientSelectionGroup" style="display: none;">
                            <label class="form-label">Select Patient *</label>
                            <select class="form-control" id="newUserPatient" onchange="handlePatientSelection()">
                                <option value="">Search and select a patient...</option>
                            </select>
                            <small class="text-muted">Link this user account to an existing patient record</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-control" id="newUserPassword"
                                placeholder="Enter password" required>
                            <small class="text-muted">Min 8 chars, uppercase, lowercase, numbers</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm Password *</label>
                            <input type="password" class="form-control" id="newUserConfirmPassword"
                                placeholder="Confirm password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitCreateUserBtn"
                        onclick="handleCreateUser(event)">Create User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- *************
			************ JavaScript Files *************
		************* -->
    <!-- Required Bootstrap Bundle JS (jQuery already loaded in head) -->
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/moment.min.js"></script>

    <!-- Export Libraries -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
    <!-- Email.js for Gmail/SMTP support -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- *************
    ************ Vendor Js Files *************
    ************* -->

    <!-- Overlay Scroll JS -->
    <script src="assets/js/jquery.overlayScrollbars.min.js"></script>
    <script src="assets/js/custom-scrollbar.js"></script>

    <!-- Apex Charts -->
    <script src="assets/js/apexcharts.min.js"></script>
    <script src="assets/js/patients.js"></script>
    <script src="assets/js/treatment.js"></script>
    <script src="assets/js/available-beds.js"></script>
    <script src="assets/js/earnings.js"></script>
    <script src="assets/js/gender-age.js"></script>
    <script src="assets/js/claims.js"></script>

    <!-- Custom JS files -->
    <script src="assets/js/custom.js"></script>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="supabase-config.js"></script>

    <!-- Dashboard Data Script -->
    <script src="dashboard-data.js"></script>

    <!-- Chat System Script -->
    <script src="chat-system.js"></script>

    <!-- Feature Access Matrix -->
    <script src="FEATURE_ACCESS_MATRIX.js"></script>

    <!-- Subscription Upgrade Modal & Logging -->
    <script src="subscription-upgrade-modal.js"></script>

    <!-- FAB Button Script -->
     <script>
         // FAB Button Functionality with Subscription Check
         document.addEventListener('DOMContentLoaded', function () {
             const fabContainer = document.getElementById('fabContainer');
             const fabButton = document.getElementById('fabButton');
             const fabChatBtn = document.getElementById('fabChatBtn');
             const fabChatbotBtn = document.getElementById('fabChatbotBtn');
             const fabImportBtn = document.getElementById('fabImportBtn');

             // Get current subscription type from session
             const sessionData = localStorage.getItem('userSession');
             const session = sessionData ? JSON.parse(sessionData) : {};
             const subscriptionType = session.subscriptionType;
             const isAdvanced = subscriptionType === 'Advanced';

             // Ensure FAB is visible
             if (fabContainer) {
                 fabContainer.style.display = 'block';
                 fabContainer.style.visibility = 'visible';
                 console.log('FAB Container initialized');
             }

             // Toggle FAB menu on main button click
             if (fabButton) {
                 fabButton.addEventListener('click', function (e) {
                     e.preventDefault();
                     fabContainer.classList.toggle('active');
                     fabButton.classList.toggle('active');
                 });
             }

             // Close menu when clicking outside
             document.addEventListener('click', function (e) {
                 if (fabContainer && !fabContainer.contains(e.target)) {
                     fabContainer.classList.remove('active');
                     if (fabButton) {
                         fabButton.classList.remove('active');
                     }
                 }
             });

             // Chat button functionality - Advanced subscription only
             if (fabChatBtn) {
                 if (!isAdvanced) {
                     fabChatBtn.style.opacity = '0.5';
                     fabChatBtn.style.cursor = 'not-allowed';
                     fabChatBtn.title = 'Chat available for Advanced subscriptions only';
                 }
                 
                 fabChatBtn.addEventListener('click', function (e) {
                     e.preventDefault();
                     e.stopPropagation();

                     if (!isAdvanced) {
                         SubscriptionUpgradeModal.showAccessDenied('chat.system', subscriptionType);
                         return;
                     }

                     // Log successful access
                     FeatureAccessLogger.logAccessAttempt({
                         feature: 'chat.system',
                         subscriptionType: subscriptionType,
                         status: 'allowed',
                         userAgent: navigator.userAgent
                     });

                     // Close FAB menu
                     fabContainer.classList.remove('active');
                     fabButton.classList.remove('active');

                     // Open chat system
                     if (typeof chatSystem !== 'undefined' && chatSystem.openChat) {
                         chatSystem.openChat();
                     }
                 });
             }

             // Chatbot button functionality - Advanced subscription only
             if (fabChatbotBtn) {
                 if (!isAdvanced) {
                     fabChatbotBtn.style.opacity = '0.5';
                     fabChatbotBtn.style.cursor = 'not-allowed';
                     fabChatbotBtn.title = 'AI Chatbot available for Advanced subscriptions only';
                 }
                 
                 fabChatbotBtn.addEventListener('click', function (e) {
                     e.preventDefault();
                     e.stopPropagation();

                     if (!isAdvanced) {
                         SubscriptionUpgradeModal.showAccessDenied('chatbot.ai', subscriptionType);
                         return;
                     }

                     // Log successful access
                     FeatureAccessLogger.logAccessAttempt({
                         feature: 'chatbot.ai',
                         subscriptionType: subscriptionType,
                         status: 'allowed',
                         userAgent: navigator.userAgent
                     });

                     // Close FAB menu
                     fabContainer.classList.remove('active');
                     fabButton.classList.remove('active');

                     // Open chatbot
                     if (typeof window.chatbotUI !== 'undefined' && window.chatbotUI && window.chatbotUI.open) {
                         window.chatbotUI.open();
                     } else if (typeof chatbotUI !== 'undefined' && chatbotUI && chatbotUI.open) {
                         chatbotUI.open();
                     } else {
                         console.warn('Chatbot UI not available yet');
                     }
                 });
             }

            // Import button functionality
            if (fabImportBtn) {
                fabImportBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Close FAB menu
                    fabContainer.classList.remove('active');
                    fabButton.classList.remove('active');

                    // Show import dialog
                    showImportDialog();
                });
            }

            // System database columns for patient table (from actual schema)
            const SYSTEM_COLUMNS = [
                'patient_no',
                'first_name',
                'last_name',
                'age',
                'gender',
                'phone_number',
                'email',
                'facility_id_code',
                'status',
                'notes',
                'pid',
                'fid',
                'address',
                'condition',
                'viral_load_copies',
                'viral_load_status',
                'visit_date',
                'next_appointment',
                'appointment_time',
                'health_worker_name',
                'health_worker_role',
                'patient_registration_date',
                'art_start_date',
                'patient_type',
                'last_viral_load_date',
                'hiv_status',
                'appointment_type',
                'systolic',
                'diastolic',
                'hiv_regimen',
                'regimen_start_date',
                'regimen_status',
                'glucose_level'
            ];

            // Import Dialog Function
            function showImportDialog() {
                Swal.fire({
                    title: '<i class="ri-upload-cloud-2-line" style="color: #15696B; margin-right: 8px;"></i>Import Patient Data',
                    titleRatio: 1.5,
                    html: `
              <div class="text-start" style="padding: 0 10px;">
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Upload a CSV file to import multiple patient records at once.</p>
                
                <div style="margin-bottom: 20px;">
                  <label for="fileInput" class="form-label" style="font-weight: 600; color: #333;">CSV File</label>
                  <div style="position: relative; margin-top: 8px;">
                    <input type="file" id="fileInput" class="form-control" accept=".csv" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer;" />
                  </div>
                </div>

                <div style="background: linear-gradient(135deg, #e8f4f8 0%, #f0f9fb 100%); border-left: 4px solid #15696B; border-radius: 6px; padding: 12px 15px; margin-bottom: 10px;">
                  <p style="margin: 0; font-size: 13px; color: #333;">
                    <i class="ri-information-line" style="color: #15696B; margin-right: 6px;"></i>
                    <strong>CSV Format:</strong> First row must contain column headers (e.g., first_name, last_name, age, etc.)
                  </p>
                </div>

                <div style="background: #fff9e6; border-left: 4px solid #ffc107; border-radius: 6px; padding: 12px 15px;">
                  <p style="margin: 0; font-size: 13px; color: #666;">
                    <i class="ri-lightbulb-flash-line" style="color: #ffc107; margin-right: 6px;"></i>
                    You'll be able to match CSV columns to patient fields on the next step.
                  </p>
                </div>
              </div>
            `,
                    width: '500px',
                    showCancelButton: true,
                    confirmButtonText: '<i class="ri-arrow-right-line" style="margin-right: 6px;"></i>Next',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#15696B',
                    cancelButtonColor: '#6c757d',
                    buttonsStyling: false,
                    customClass: {
                        confirmButton: 'btn btn-primary',
                        cancelButton: 'btn btn-secondary me-2'
                    },
                    didOpen: () => {
                        const fileInput = document.getElementById('fileInput');
                        fileInput.focus();
                    },
                    preConfirm: () => {
                        const fileInput = document.getElementById('fileInput');
                        if (!fileInput.files[0]) {
                            Swal.showValidationMessage('Please select a file');
                            return false;
                        }
                        return fileInput.files[0];
                    }
                }).then((result) => {
                    if (result.isConfirmed && result.value) {
                        handleFileUpload(result.value);
                    }
                });
            }

            // Handle file upload and parse for column matching
            function handleFileUpload(file) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    try {
                        const csv = e.target.result;
                        const lines = csv.trim().split('\n');

                        if (lines.length < 2) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Invalid File',
                                text: 'CSV file must contain at least a header row and one data row'
                            });
                            return;
                        }

                        // Parse CSV
                        const headers = lines[0].split(',').map(h => h.trim());
                        const data = lines.slice(1).map(line => {
                            const values = line.split(',').map(v => v.trim());
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            return row;
                        });

                        // Auto-match columns and show dialog for manual adjustments
                        const autoMapping = autoMatchColumns(headers);
                        showColumnMatchingDialog(headers, data, autoMapping);
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error parsing CSV file: ' + error.message
                        });
                    }
                };

                reader.onerror = function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error reading file'
                    });
                };

                reader.readAsText(file);
            }

            // Auto-match CSV columns to database columns
            function autoMatchColumns(csvHeaders) {
                const columnMapping = {};

                csvHeaders.forEach(header => {
                    const lowerHeader = header.toLowerCase().replace(/\s+/g, '_');

                    // Exact match first
                    const exactMatch = SYSTEM_COLUMNS.find(col =>
                        col.toLowerCase() === lowerHeader
                    );
                    if (exactMatch) {
                        columnMapping[header] = exactMatch;
                        return;
                    }

                    // Partial match
                    const partialMatch = SYSTEM_COLUMNS.find(col => {
                        const colLower = col.toLowerCase();
                        const headerClean = lowerHeader.replace(/_/g, '').replace(/\s+/g, '');
                        const colClean = colLower.replace(/_/g, '');
                        return headerClean.includes(colClean) || colClean.includes(headerClean);
                    });

                    columnMapping[header] = partialMatch || '';
                });

                return columnMapping;
            }

            // Show column matching dialog with auto-matched values
            function showColumnMatchingDialog(csvHeaders, csvData, autoMapping) {
                let columnMapping = {
                    ...autoMapping
                };

                const mappingHtml = `
            <div class="text-start" style="padding: 0 10px;">
              <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                <i class="ri-align-justify" style="color: #15696B; margin-right: 6px;"></i>
                <strong>Map CSV Columns to Patient Fields</strong>
              </p>
              
              <p style="color: #888; margin-bottom: 15px; font-size: 13px;">
                We've auto-detected field matches. You can adjust them below if needed.
              </p>

              <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px;">
                <div class="table-responsive">
                  <table class="table table-sm" style="margin-bottom: 0;">
                    <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                      <tr>
                        <th style="width: 40%; padding: 10px; font-weight: 600; color: #333;">CSV Column</th>
                        <th style="width: 60%; padding: 10px; font-weight: 600; color: #333;">Map to Field</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${csvHeaders.map((header, idx) => `
                        <tr style="border-bottom: 1px solid #e0e0e0; ${idx % 2 === 0 ? 'background: #fafafa;' : ''}">
                          <td style="padding: 10px; vertical-align: middle;">
                            <small style="font-weight: 500; color: #333;">${header}</small>
                          </td>
                          <td style="padding: 8px;">
                            <select class="form-select form-select-sm column-mapping" data-csv-column="${header}" style="font-size: 0.85rem; border-color: ${columnMapping[header] ? '#15696B' : '#dee2e6'}; border-width: 1.5px;">
                              <option value="">-- Skip column --</option>
                              ${SYSTEM_COLUMNS.map(col => `
                                <option value="${col}" ${columnMapping[header] === col ? 'selected' : ''}>${col.replace(/_/g, ' ')}</option>
                              `).join('')}
                            </select>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>

              <div style="background: #e8f4f8; border-left: 4px solid #15696B; border-radius: 6px; padding: 12px 15px; margin-top: 15px;">
                <p style="margin: 0; font-size: 13px; color: #333;">
                  <i class="ri-file-list-line" style="color: #15696B; margin-right: 6px;"></i>
                  <strong>${csvData.length} rows</strong> will be imported from your CSV file.
                </p>
              </div>
            </div>
          `;

                Swal.fire({
                    title: '<i class="ri-links-line" style="color: #15696B; margin-right: 8px;"></i>Match Columns',
                    html: mappingHtml,
                    width: '650px',
                    showCancelButton: true,
                    confirmButtonText: '<i class="ri-arrow-right-line" style="margin-right: 6px;"></i>Continue',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#15696B',
                    cancelButtonColor: '#6c757d',
                    buttonsStyling: false,
                    customClass: {
                        confirmButton: 'btn btn-primary',
                        cancelButton: 'btn btn-secondary me-2'
                    },
                    didOpen: () => {
                        // Attach event listeners to dropdowns
                        document.querySelectorAll('.column-mapping').forEach(select => {
                            select.addEventListener('change', (e) => {
                                const csvColumn = e.target.getAttribute(
                                    'data-csv-column');
                                columnMapping[csvColumn] = e.target.value;
                            });
                        });
                    },
                    preConfirm: () => {
                        // Validate that at least some columns are mapped
                        const mappedCount = Object.values(columnMapping).filter(v => v !== '')
                            .length;
                        if (mappedCount === 0) {
                            Swal.showValidationMessage('Please map at least one column');
                            return false;
                        }
                        return true;
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        showImportPreview(csvHeaders, csvData, columnMapping);
                    }
                });
            }

            // Show import preview with mapped data
            function showImportPreview(csvHeaders, csvData, columnMapping) {
                const mappedData = csvData.map(row => {
                    const mappedRow = {};
                    csvHeaders.forEach(csvCol => {
                        const systemCol = columnMapping[csvCol];
                        if (systemCol) {
                            mappedRow[systemCol] = row[csvCol];
                        }
                    });
                    return mappedRow;
                });

                const previewRows = mappedData.slice(0, 3);
                const mappedColumns = Object.keys(columnMapping).filter(csv => columnMapping[csv] !== '');

                let previewHtml = `
            <div style="padding: 0; max-height: calc(100vh - 300px); overflow-y: auto;">
              <!-- Stats Cards -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div style="background: linear-gradient(135deg, #15696B 0%, #0F4449 100%); border-radius: 6px; padding: 12px; color: white; box-shadow: 0 2px 8px rgba(21, 105, 107, 0.15);">
                  <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                      <p style="margin: 0; font-size: 10px; opacity: 0.85; text-transform: uppercase; letter-spacing: 0.3px;">Records</p>
                      <p style="margin: 6px 0 0 0; font-size: 24px; font-weight: 700;">${csvData.length}</p>
                    </div>
                    <div style="font-size: 28px; opacity: 0.25;">
                      <i class="ri-user-add-line"></i>
                    </div>
                  </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 6px; padding: 12px; color: white; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);">
                  <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                      <p style="margin: 0; font-size: 10px; opacity: 0.85; text-transform: uppercase; letter-spacing: 0.3px;">Fields</p>
                      <p style="margin: 6px 0 0 0; font-size: 24px; font-weight: 700;">${mappedColumns.length}</p>
                    </div>
                    <div style="font-size: 28px; opacity: 0.25;">
                      <i class="ri-checkbox-multiple-mark-line"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Mapped Fields Section -->
              <div style="margin-bottom: 12px;">
                <p style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 8px; font-weight: 600;">
                  <i class="ri-links-line" style="color: #15696B; margin-right: 4px;"></i>Mapped Fields
                </p>
                <div style="background: #f8f9fa; border-radius: 6px; padding: 10px; border: 1px solid #e0e0e0; max-height: 80px; overflow-y: auto;">
                  <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                    ${mappedColumns.map(csv => `
                      <span style="background: white; border: 1px solid #15696B; color: #15696B; padding: 4px 10px; border-radius: 16px; font-size: 11px; font-weight: 500;">
                        ${columnMapping[csv]}
                      </span>
                    `).join('')}
                  </div>
                </div>
              </div>

              <!-- Data Preview Section -->
              <div style="margin-bottom: 12px;">
                <p style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 8px; font-weight: 600;">
                  <i class="ri-eye-line" style="color: #15696B; margin-right: 4px;"></i>Data Preview
                </p>
                
                <div style="border-radius: 6px; overflow: hidden; border: 1px solid #e0e0e0; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);">
                  <div style="overflow: auto; max-height: 150px;">
                    <table class="table table-sm" style="margin-bottom: 0; background: white; font-size: 11px;">
                      <thead style="background: linear-gradient(135deg, #f8f9fa 0%, #eef2f5 100%); position: sticky; top: 0; z-index: 10;">
                        <tr>
                          ${mappedColumns.map(csv => `
                            <th style="padding: 8px 6px; font-size: 10px; font-weight: 600; color: #333; border-bottom: 1px solid #dee2e6; white-space: nowrap; background: #f8f9fa;">
                              ${columnMapping[csv]}
                            </th>
                          `).join('')}
                        </tr>
                      </thead>
                      <tbody>
                        ${previewRows.map((row, idx) => `
                          <tr style="border-bottom: 1px solid #e0e0e0;">
                            ${mappedColumns.map(csv => `
                              <td style="padding: 6px; font-size: 11px; color: ${row[columnMapping[csv]] ? '#333' : '#999'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">
                                ${row[columnMapping[csv]] || ''}
                              </td>
                            `).join('')}
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Warning Banner -->
              <div style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 6px; padding: 10px 12px; border: 1px solid #FCD34D; display: flex; align-items: flex-start; gap: 10px;">
                <div style="font-size: 16px; color: #D97706; margin-top: 1px; flex-shrink: 0;">
                  <i class="ri-alert-fill"></i>
                </div>
                <div>
                  <p style="margin: 0; font-size: 11px; color: #92400E; font-weight: 600;">Important</p>
                  <p style="margin: 3px 0 0 0; font-size: 10px; color: #B45309; line-height: 1.4;">
                    This will import ${csvData.length} record${csvData.length !== 1 ? 's' : ''}. Cannot be undone.
                  </p>
                </div>
              </div>
            </div>
          `;

                Swal.fire({
                    title: '<i class="ri-file-list-line" style="color: #15696B; margin-right: 8px;"></i>Review & Confirm',
                    html: previewHtml,
                    width: '700px',
                    showCancelButton: true,
                    confirmButtonText: '<i class="ri-download-cloud-2-line" style="margin-right: 6px;"></i>Import Now',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#15696B',
                    cancelButtonColor: '#6c757d',
                    buttonsStyling: false,
                    customClass: {
                        confirmButton: 'btn btn-primary',
                        cancelButton: 'btn btn-secondary me-2'
                    },
                }).then((result) => {
                    if (result.isConfirmed) {
                        importPatientData(mappedData);
                    }
                });
            }

            // Import patient data to database
            async function importPatientData(data) {
                let currentProgress = 0;

                const importingHtml = `
            <div style="padding: 20px 0;">
              <div style="margin-bottom: 30px;">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                  <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #15696B 0%, #0F4449 100%); display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 15px rgba(21, 105, 107, 0.3);">
                    <div style="width: 70px; height: 70px; border-radius: 50%; border: 4px solid rgba(255, 255, 255, 0.2); border-top-color: white; animation: spin 1.5s linear infinite; position: absolute;"></div>
                    <div style="font-size: 32px; color: white; z-index: 1;">
                      <i class="ri-download-cloud-2-line"></i>
                    </div>
                  </div>
                </div>
                
                <p style="text-align: center; font-size: 16px; font-weight: 600; color: #333; margin: 0 0 8px 0;">Importing Patient Data</p>
                <p style="text-align: center; font-size: 12px; color: #666; margin: 0;">Processing records...</p>
              </div>

              <!-- Progress Bar -->
              <div style="margin-bottom: 20px;">
                <div style="background: #e0e0e0; height: 6px; border-radius: 10px; overflow: hidden; margin-bottom: 8px;">
                  <div id="importProgress" style="background: linear-gradient(90deg, #15696B 0%, #10B981 100%); height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s ease; box-shadow: 0 0 10px rgba(21, 105, 107, 0.4);"></div>
                </div>
                <p style="text-align: center; font-size: 11px; color: #999; margin: 0;">
                  <span id="importCount">0</span> / ${data.length} records
                </p>
              </div>

              <!-- Stats -->
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div style="background: #f0f9f8; border-radius: 6px; padding: 10px; text-align: center; border: 1px solid #d0e8e6;">
                  <p style="margin: 0; font-size: 10px; color: #666; text-transform: uppercase;">Added</p>
                  <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: 600; color: #10B981;" id="successStat">0</p>
                </div>
                <div style="background: #f0f4ff; border-radius: 6px; padding: 10px; text-align: center; border: 1px solid #d0d8ff;">
                  <p style="margin: 0; font-size: 10px; color: #666; text-transform: uppercase;">Updated</p>
                  <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: 600; color: #3b82f6;" id="updateStat">0</p>
                </div>
                <div style="background: #fef2f2; border-radius: 6px; padding: 10px; text-align: center; border: 1px solid #fed7d7;">
                  <p style="margin: 0; font-size: 10px; color: #666; text-transform: uppercase;">Failed</p>
                  <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: 600; color: #ef4444;" id="errorStat">0</p>
                </div>
              </div>

              <!-- Status Message -->
              <p style="text-align: center; font-size: 11px; color: #999; margin: 0;" id="statusMessage">Initializing import...</p>
            </div>

            <style>
              @keyframes spin {
                to { transform: rotate(360deg); }
              }
            </style>
          `;

                Swal.fire({
                    title: '',
                    html: importingHtml,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        // Update progress during import
                        window.updateImportProgress = (current, success, updates, errors,
                            message) => {
                            const percent = (current / data.length) * 100;
                            document.getElementById('importProgress').style.width =
                                percent + '%';
                            document.getElementById('importCount').textContent = current;
                            document.getElementById('successStat').textContent = success;
                            document.getElementById('updateStat').textContent = updates;
                            document.getElementById('errorStat').textContent = errors;
                            document.getElementById('statusMessage').textContent = message;
                        };
                    }
                });

                try {
                    // Check if Supabase is available
                    if (typeof supabaseClient === 'undefined') {
                        throw new Error('Database connection not available');
                    }

                    // Get user's facility ID from session
                    const sessionData = localStorage.getItem('userSession');
                    if (!sessionData) {
                        throw new Error('User session not found');
                    }
                    const session = JSON.parse(sessionData);
                    const userFid = session.fid || 1;

                    let successCount = 0;
                    let updateCount = 0;
                    let errorCount = 0;
                    let processedCount = 0;

                    for (const patient of data) {
                        processedCount++;
                        try {
                            // Build record from mapped data (already using system column names)
                            const patientRecord = {
                                patient_no: patient['patient_no'] || '',
                                first_name: patient['first_name'] || '',
                                last_name: patient['last_name'] || '',
                                age: patient['age'] ? parseInt(patient['age']) : null,
                                gender: patient['gender'] || null,
                                phone_number: patient['phone_number'] || null,
                                email: patient['email'] || null,
                                facility_id_code: patient['facility_id_code'] || null,
                                status: patient['status'] || null,
                                notes: patient['notes'] || null,
                                fid: userFid,
                                address: patient['address'] || null,
                                condition: patient['condition'] || null,
                                viral_load_copies: patient['viral_load_copies'] ? parseFloat(patient[
                                    'viral_load_copies']) : null,
                                viral_load_status: patient['viral_load_status'] || null,
                                visit_date: patient['visit_date'] || null,
                                next_appointment: patient['next_appointment'] || null,
                                appointment_time: patient['appointment_time'] || null,
                                health_worker_name: patient['health_worker_name'] || null,
                                health_worker_role: patient['health_worker_role'] || null,
                                patient_registration_date: patient['patient_registration_date'] || null,
                                art_start_date: patient['art_start_date'] || null,
                                patient_type: patient['patient_type'] || null,
                                last_viral_load_date: patient['last_viral_load_date'] || null,
                                hiv_status: patient['hiv_status'] || null,
                                appointment_type: patient['appointment_type'] || null,
                                systolic: patient['systolic'] ? parseFloat(patient['systolic']) : null,
                                diastolic: patient['diastolic'] ? parseFloat(patient['diastolic']) :
                                    null,
                                hiv_regimen: patient['hiv_regimen'] || null,
                                regimen_start_date: patient['regimen_start_date'] || null,
                                regimen_status: patient['regimen_status'] || null,
                                glucose_level: patient['glucose_level'] ? parseFloat(patient[
                                    'glucose_level']) : null,
                            };

                            // Skip if no patient_no is provided
                            if (!patientRecord.patient_no) {
                                errorCount++;
                                console.warn('Skipping row: patient_no is required');
                                continue;
                            }

                            // Validate and clean date fields
                            const dateFields = ['visit_date', 'next_appointment',
                                'patient_registration_date', 'art_start_date', 'last_viral_load_date',
                                'regimen_start_date'
                            ];
                            for (const dateField of dateFields) {
                                if (patientRecord[dateField]) {
                                    const value = String(patientRecord[dateField]).trim();
                                    // Check if it looks like a date (YYYY-MM-DD or MM/DD/YYYY)
                                    const dateRegex = /^\d{4}-\d{2}-\d{2}$|^\d{1,2}\/\d{1,2}\/\d{4}$/;
                                    if (!dateRegex.test(value)) {
                                        // Not a valid date format, set to null
                                        patientRecord[dateField] = null;
                                    }
                                }
                            }

                            // Validate numeric fields
                            const numericFields = ['age', 'viral_load_copies', 'systolic', 'diastolic',
                                'glucose_level'
                            ];
                            for (const numField of numericFields) {
                                if (patientRecord[numField]) {
                                    const numValue = parseFloat(patientRecord[numField]);
                                    if (isNaN(numValue)) {
                                        patientRecord[numField] = null;
                                    }
                                }
                            }

                            // Check if patient already exists by patient_no
                            const {
                                data: existingPatient,
                                error: fetchError
                            } = await supabaseClient
                                .from('patients')
                                .select('pid', {
                                    count: 'exact'
                                })
                                .eq('patient_no', patientRecord.patient_no);

                            if (fetchError) {
                                // Error checking patient
                                errorCount++;
                                console.error('Error checking patient:', fetchError);
                                continue;
                            }

                            if (existingPatient && existingPatient.length > 0) {
                                // Patient exists - update their information
                                const {
                                    error: updateError
                                } = await supabaseClient
                                    .from('patients')
                                    .update(patientRecord)
                                    .eq('patient_no', patientRecord.patient_no);

                                if (!updateError) {
                                    updateCount++;
                                } else {
                                    errorCount++;
                                    console.error('Update error:', updateError);
                                }
                            } else {
                                // Patient does not exist - insert as new
                                const {
                                    error: insertError
                                } = await supabaseClient
                                    .from('patients')
                                    .insert([patientRecord]);

                                if (!insertError) {
                                    successCount++;
                                } else {
                                    errorCount++;
                                    console.error('Insert error:', insertError);
                                }
                            }
                        } catch (rowError) {
                            errorCount++;
                            console.error('Row processing error:', rowError);
                        }

                        // Update progress
                        if (window.updateImportProgress) {
                            const message = `Processing record ${processedCount} of ${data.length}...`;
                            window.updateImportProgress(processedCount, successCount, updateCount,
                                errorCount, message);
                        }
                    }

                    // Close loading dialog and show results
                    Swal.close();

                    Swal.fire({
                        icon: (successCount + updateCount) > 0 ? 'success' : 'warning',
                        title: 'Import Complete',
                        html: `
                <div class="text-start">
                  <p><strong style="color: #28a745;">New records:</strong> ${successCount}</p>
                  <p><strong style="color: #0066cc;">Updated records:</strong> ${updateCount}</p>
                  ${errorCount > 0 ? `<p><strong style="color: #dc3545;">Failed:</strong> ${errorCount} records</p>` : ''}
                  <p class="mt-3 mb-0"><small>Total processed: ${successCount + updateCount + errorCount}</small></p>
                </div>
              `,
                        confirmButtonColor: '#15696B'
                    }).then(() => {
                        // Refresh the page or table
                        if (typeof location !== 'undefined' && window.location) {
                            location.reload();
                        }
                    });
                } catch (error) {
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Import Failed',
                        text: error.message || 'An error occurred during import'
                    });
                }
            }
        });
    </script>

    <!-- Authentication Check & Session Management -->
    <script>
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds
        let inactivityTimeout;

        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', function () {
            const sessionData = localStorage.getItem('userSession');

            if (!sessionData) {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html';
                return;
            }

            // Parse session data
            const session = JSON.parse(sessionData);

            // Display user information
            displayUserInfo(session);

            // Setup logout button
            setupLogoutButton();

            // Setup session timeout
            setupSessionTimeout();

            // Track user activity to reset inactivity timer
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
        });

        // Display user information in header and sidebar
         function displayUserInfo(session) {
             const fullname = session.fullname || session.username || 'User';
             const userRole = session.userRole || 'User';
             const subscriptionType = session.subscriptionType;
             
             // Debug logging
             console.log('Session data:', session);
             console.log('Subscription type:', subscriptionType);

             // Get initials from fullname
             const initials = fullname
                 .split(' ')
                 .map(name => name.charAt(0))
                 .join('')
                 .toUpperCase()
                 .slice(0, 2);

             // Update header dropdown UI
             document.getElementById('userInitials').textContent = initials;
             document.getElementById('userInitialsLarge').textContent = initials;
             document.getElementById('userName').textContent = fullname;
             document.getElementById('userRole').textContent = userRole;

             // Update facility name in dropdown
             const facilityNameEl = document.getElementById('facilityName');
             if (facilityNameEl) {
                 facilityNameEl.innerHTML = '<i class="ri-building-line me-1"></i>' + (session.facilityName || 'Facility');
             }

             // Update subscription type in dropdown (only if it exists)
             if (subscriptionType) {
                 const subscriptionEl = document.getElementById('subscriptionType');
                 const badgeColor = subscriptionType === 'Advanced' ? '#DC3545' : 
                                  subscriptionType === 'Standard' ? '#FFC107' : '#15696B';
                 document.getElementById('subTypeValue').textContent = subscriptionType;
                 document.getElementById('subTypeValue').style.color = badgeColor;
                 document.getElementById('subTypeValue').style.fontWeight = '600';
                 subscriptionEl.style.display = 'block';
             }

             // Update sidebar profile UI
             document.getElementById('sidebarUserName').textContent = fullname;
             document.getElementById('sidebarUserRole').textContent = userRole;

             // Update greeting section with real data
             updateGreetingSection(fullname, session);
         }

        // Update the greeting section with user info
        function updateGreetingSection(fullname, session) {
            // Update greeting time based on current hour
            const currentHour = new Date().getHours();
            let greeting = 'Good Morning';

            if (currentHour >= 12 && currentHour < 17) {
                greeting = 'Good Afternoon';
            } else if (currentHour >= 17) {
                greeting = 'Good Evening';
            }

            // Update greeting elements
            document.getElementById('greetingTime').textContent = greeting + ',';
            document.getElementById('greetingUserName').textContent = fullname;

            // Fetch and update real stats from database
            fetchDashboardStats(session);

            // Fetch and populate patients table
            fetchAndPopulatePatients(session);
        }

        // Fetch dashboard statistics from Supabase
        async function fetchDashboardStats(session) {
            try {
                // Use numeric facility_id from session
                const numericFacilityId = session.fid || session.facility_id || session.facilityId;

                // Fetch total patients for the facility
                const {
                    data: patients,
                    error: patientError
                } = await supabaseClient
                    .from('patients')
                    .select('*')
                    .eq('fid', numericFacilityId);

                // Fetch total appointments from patients table (patients with art_start_date)
                const {
                    count: totalAppointmentCount,
                    error: totalAppointmentError
                } = await supabaseClient
                    .from('patients')
                    .select('*', {
                        count: 'exact',
                        head: true
                    })
                    .eq('fid', numericFacilityId)
                    .not('art_start_date', 'is', null);

                console.log('Facility ID:', numericFacilityId, 'Total appointments count:', totalAppointmentCount,
                    'Error:', totalAppointmentError);

                // Fetch new patients registered in the current month
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

                const {
                    data: newPatients,
                    error: newPatientError
                } = await supabaseClient
                    .from('patients')
                    .select('pid')
                    .eq('fid', numericFacilityId)
                    .gte('patient_registration_date', monthStart)
                    .lte('patient_registration_date', monthEnd);

                // Fetch critical patients needing special attention
                // This includes patients with:
                // - High viral load copies (>= 1000)
                // - Status marked as Critical or Alert or Inactive (lost to follow-up)
                let {
                    data: allFacilityPatients,
                    error: facilityPatientsError
                } = await supabaseClient
                    .from('patients')
                    .select('pid, viral_load_copies, status')
                    .eq('fid', numericFacilityId);

                let criticalPatients = [];
                let criticalError = null;

                if (!facilityPatientsError && allFacilityPatients) {
                    // Filter for critical patients: high viral load (>= 1000) or inactive status
                    criticalPatients = allFacilityPatients.filter(patient => {
                        const vl = parseInt(patient.viral_load_copies);
                        return vl >= 1000 || ['Critical', 'Alert', 'Inactive'].includes(patient.status);
                    });
                } else {
                    criticalError = facilityPatientsError;
                }

                // Fetch next week appointments from appointments table
                // Next week = Monday through Sunday
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dayOfWeek = today.getDay();

                // Calculate next Monday (0 = Sunday, 1 = Monday)
                // First calculate days until end of this week (Sunday)
                const daysUntilSunday = dayOfWeek === 0 ? 0 : (7 - dayOfWeek);
                const endOfThisWeek = new Date(today);
                endOfThisWeek.setDate(endOfThisWeek.getDate() + daysUntilSunday);
                
                // Next Monday is the day after Sunday
                const nextMonday = new Date(endOfThisWeek);
                nextMonday.setDate(nextMonday.getDate() + 1);

                // Calculate Sunday of next week
                const nextSunday = new Date(nextMonday);
                nextSunday.setDate(nextSunday.getDate() + 6);

                const nextMondayStr = nextMonday.toISOString().split('T')[0];
                const nextSundayStr = nextSunday.toISOString().split('T')[0];

                const {
                    data: nextWeekAppointments,
                    error: nextWeekError
                } = await supabaseClient
                    .from('patients')
                    .select('pid, next_appointment')
                    .eq('fid', numericFacilityId)
                    .not('next_appointment', 'is', null)
                    .gte('next_appointment', nextMondayStr)
                    .lte('next_appointment', nextSundayStr);

                const nextWeekCount = !nextWeekError && nextWeekAppointments ? nextWeekAppointments.length : 0;

                // Fetch overdue appointments from patients table
                const todayStr = today.toISOString().split('T')[0];

                const {
                    data: overdueAppointments,
                    error: overdueError
                } = await supabaseClient
                    .from('patients')
                    .select('pid, next_appointment')
                    .eq('fid', numericFacilityId)
                    .not('next_appointment', 'is', null)
                    .lt('next_appointment', todayStr);

                const overdueCount = !overdueError && overdueAppointments ? overdueAppointments.length : 0;

                // Fetch missed appointments from patients table
                // Missed = next_appointment is in the past and status is not Completed
                const {
                    data: missedAppointments,
                    error: missedError
                } = await supabaseClient
                    .from('patients')
                    .select('pid, next_appointment')
                    .eq('fid', numericFacilityId)
                    .not('next_appointment', 'is', null)
                    .lt('next_appointment', todayStr)
                    .neq('status', 'Completed');

                const missedCount = !missedError && missedAppointments ? missedAppointments.length : 0;

                // Fetch high viraemia patients (viral_load_copies >= 1000)
                const {
                    data: highViraemiaPatients,
                    error: highViraemiaError
                } = await supabaseClient
                    .from('patients')
                    .select('pid, viral_load_copies')
                    .eq('fid', numericFacilityId)
                    .gte('viral_load_copies', 1000);

                const highViraemiaCount = !highViraemiaError && highViraemiaPatients ? highViraemiaPatients.length :
                    0;

                // Fetch low viraemia patients (viral_load_copies between 201 and 999)
                const {
                    data: lowViraemiaPatients,
                    error: lowViraemiaError
                } = await supabaseClient
                    .from('patients')
                    .select('pid, viral_load_copies')
                    .eq('fid', numericFacilityId)
                    .gte('viral_load_copies', 201)
                    .lte('viral_load_copies', 999);

                const lowViraemiaCount = !lowViraemiaError && lowViraemiaPatients ? lowViraemiaPatients.length : 0;

                // Fetch hypertension patients (condition = 'Hypertension')
                const {
                    data: hypertensionPatients,
                    error: hypertensionError
                } = await supabaseClient
                    .from('patients')
                    .select('pid, condition')
                    .eq('fid', numericFacilityId)
                    .eq('condition', 'Hypertension');

                const hypertensionCount = !hypertensionError && hypertensionPatients ? hypertensionPatients.length : 0;

                // Fetch diabetes patients (condition = 'Diabetes')
                const {
                    data: diabetesPatients,
                    error: diabetesError
                } = await supabaseClient
                    .from('patients')
                    .select('pid, condition')
                    .eq('fid', numericFacilityId)
                    .eq('condition', 'Diabetes');

                const diabetesCount = !diabetesError && diabetesPatients ? diabetesPatients.length : 0;

                // Debug: fetch all viral load values to inspect
                const {
                    data: allVLData
                } = await supabaseClient
                    .from('patients')
                    .select('pid, viral_load_copies')
                    .eq('fid', numericFacilityId)
                    .limit(10);

                console.log('Sample viral load data:', allVLData);
                console.log('High viraemia patients raw data:', highViraemiaPatients);
                console.log('High viraemia patients:', {
                    highViraemiaCount,
                    highViraemiaError,
                    numericFacilityId
                });
                console.log('Missed appointments:', {
                    missedCount,
                    missedError,
                    numericFacilityId
                });
                console.log('Overdue appointments:', {
                    todayStr,
                    overdueCount,
                    overdueError,
                    numericFacilityId
                });
                console.log('Next week appointments:', {
                    nextMondayStr,
                    nextSundayStr,
                    nextWeekCount,
                    nextWeekError,
                    numericFacilityId
                });
                console.log('Hypertension patients:', {
                    hypertensionCount,
                    hypertensionError,
                    numericFacilityId
                });
                console.log('Diabetes patients:', {
                    diabetesCount,
                    diabetesError,
                    numericFacilityId
                });

                // Update UI with fetched data
                const patientCount = !patientError ? patients.length : 0;
                const newPatientCount = !newPatientError && newPatients ? newPatients.length : 0;
                const criticalPatientCount = !criticalError && criticalPatients ? criticalPatients.length : 0;
                const allAppointmentsCount = !totalAppointmentError ? totalAppointmentCount : 0;
                const nextWeekAppointmentsCount = !nextWeekError ? nextWeekCount : 0;

                // Update only if elements exist
                const patientsCountEl = document.getElementById('patientsCount');
                const totalAppointmentsCountEl = document.getElementById('totalAppointmentsCount');
                const newPatientsCountEl = document.getElementById('newPatientsCount');
                const criticalPatientsCountEl = document.getElementById('criticalPatientsCount');
                const nextWeekAppointmentsCountEl = document.getElementById('nextWeekAppointmentsCount');
                const overdueAppointmentsCountEl = document.getElementById('overdueAppointmentsCount');
                const missedAppointmentsCountEl = document.getElementById('missedAppointmentsCount');
                const highViraemiaCountEl = document.getElementById('highViraemiaCount');
                const lowViraemiaCountEl = document.getElementById('lowViraemiaCount');
                const hypertensionCountEl = document.getElementById('hypertensionCount');
                const diabetesCountEl = document.getElementById('diabetesCount');

                if (patientsCountEl) patientsCountEl.textContent = patientCount;
                if (totalAppointmentsCountEl) totalAppointmentsCountEl.textContent = allAppointmentsCount;
                if (newPatientsCountEl) newPatientsCountEl.textContent = newPatientCount;
                if (criticalPatientsCountEl) criticalPatientsCountEl.textContent = criticalPatientCount;
                if (nextWeekAppointmentsCountEl) nextWeekAppointmentsCountEl.textContent =
                nextWeekAppointmentsCount;
                if (overdueAppointmentsCountEl) overdueAppointmentsCountEl.textContent = overdueCount;
                if (missedAppointmentsCountEl) missedAppointmentsCountEl.textContent = missedCount;
                if (highViraemiaCountEl) highViraemiaCountEl.textContent = highViraemiaCount;
                if (lowViraemiaCountEl) lowViraemiaCountEl.textContent = lowViraemiaCount;
                if (hypertensionCountEl) hypertensionCountEl.textContent = hypertensionCount;
                if (diabetesCountEl) diabetesCountEl.textContent = diabetesCount;
            } catch (error) {
                console.error('Error fetching dashboard stats:', error);
            }
        }

        // Global variables for pagination and filtering
        let allPatients = [];
        let filteredPatients = [];
        let currentPatientPage = 1;
        const PATIENTS_PER_PAGE = 5;

        // Filter patients from stat card clicks
        function filterPatients(filterType, filterValue) {
            const searchInput = document.getElementById('patientSearchInput');
            const conditionFilter = document.getElementById('patientConditionFilter');
            const statusFilter = document.getElementById('patientStatusFilter');

            // Clear previous filters
            if (searchInput) searchInput.value = '';
            if (conditionFilter) conditionFilter.value = '';
            if (statusFilter) statusFilter.value = '';

            // Apply the clicked filter
            if (filterType === 'appointment-type') {
                if (filterValue === 'next-week') {
                    statusFilter.value = 'Next Week';
                } else if (filterValue === 'overdue') {
                    statusFilter.value = 'Overdue';
                } else if (filterValue === 'missed') {
                    statusFilter.value = 'Missed';
                }
            } else if (filterType === 'viral-status') {
                if (filterValue === 'high') {
                    conditionFilter.value = 'High Viraemia';
                } else if (filterValue === 'low') {
                    conditionFilter.value = 'Low Viraemia';
                }
            }

            // Scroll to patients table
            document.getElementById('patientsTable').scrollIntoView({
                behavior: 'smooth'
            });

            // Apply filters
            filterAndDisplayPatients();
        }

        // Setup search and filter controls
        function setupPatientTableControls() {
            const searchInput = document.getElementById('patientSearchInput');
            const conditionFilter = document.getElementById('patientConditionFilter');
            const statusFilter = document.getElementById('patientStatusFilter');

            if (searchInput) searchInput.addEventListener('input', filterAndDisplayPatients);
            if (conditionFilter) conditionFilter.addEventListener('change', filterAndDisplayPatients);
            if (statusFilter) statusFilter.addEventListener('change', filterAndDisplayPatients);
        }

        // Filter and display patients based on search and filter inputs
        function filterAndDisplayPatients() {
            const searchTerm = document.getElementById('patientSearchInput').value.toLowerCase();
            const conditionFilter = document.getElementById('patientConditionFilter').value;
            const statusFilter = document.getElementById('patientStatusFilter').value;

            filteredPatients = allPatients.filter(patient => {
                const matchesSearch = !searchTerm ||
                    (patient.patient_no && patient.patient_no.toLowerCase().includes(searchTerm)) ||
                    (patient.first_name && patient.first_name.toLowerCase().includes(searchTerm)) ||
                    (patient.last_name && patient.last_name.toLowerCase().includes(searchTerm));

                const matchesCondition = !conditionFilter || patient.condition === conditionFilter;
                const matchesStatus = !statusFilter || patient.status === statusFilter;

                return matchesSearch && matchesCondition && matchesStatus;
            });

            currentPatientPage = 1;
            displayPatientPage();
            updatePatientPaginationInfo();
        }

        // Display current page of patients
        function displayPatientPage() {
            const startIndex = (currentPatientPage - 1) * PATIENTS_PER_PAGE;
            const endIndex = startIndex + PATIENTS_PER_PAGE;
            const pagePatients = filteredPatients.slice(startIndex, endIndex);

            const tableBody = document.getElementById('patientsTableBody');

            if (pagePatients.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center">No patients found</td></tr>';
                return;
            }

            // Table view (responsive with horizontal scroll on mobile)
            tableBody.innerHTML = pagePatients.map(patient => `
           <tr data-patient-id="${patient.pid}">
             <td>${patient.patient_no || '-'}</td>
             <td>${patient.first_name || '-'} ${patient.last_name || '-'}</td>
             <td>${patient.age || '-'}</td>
             <td>${patient.gender || '-'}</td>
             <td>${patient.phone_number || '-'}</td>
             <td>${patient.address || '-'}</td>
             <td><span class="badge bg-primary">${patient.condition || 'N/A'}</span></td>
             <td>
               <span class="badge ${getStatusBadgeClass(patient.status)}">
                 ${patient.status || 'Unknown'}
               </span>
             </td>
             <td>
               <span class="badge ${getHIVStatusBadgeClass(patient.hiv_status)}">
                 ${patient.hiv_status || 'Unknown'}
               </span>
             </td>
             <td>${patient.notes || '-'}</td>
             <td>
               <div class="btn-group btn-group-sm" role="group">
                 <button type="button" class="btn btn-sm btn-info patient-view-btn" title="View Details">
                   <i class="ri-eye-line"></i>
                 </button>
                 <button type="button" class="btn btn-sm btn-primary" title="Edit" onclick="editPatient('${patient.patient_no}')">
                   <i class="ri-pencil-line"></i>
                 </button>
                 <button type="button" class="btn btn-sm btn-danger" title="Delete" onclick="deletePatient('${patient.patient_no}')">
                   <i class="ri-delete-bin-line"></i>
                 </button>
               </div>
             </td>
           </tr>
         `).join('');

            // Add event listeners for view buttons
            document.querySelectorAll('.patient-view-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const patientId = this.closest('tr').dataset.patientId;
                    viewPatientDetails(patientId);
                });
            });
        }

        // Update pagination info and button states
        function updatePatientPaginationInfo() {
            const totalPages = Math.ceil(filteredPatients.length / PATIENTS_PER_PAGE);
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const countInfo = document.getElementById('patientCountInfo');

            if (pageInfo) pageInfo.textContent = `Page ${currentPatientPage} of ${totalPages}`;
            if (countInfo) {
                const startCount = Math.max(1, (currentPatientPage - 1) * PATIENTS_PER_PAGE + 1);
                const endCount = Math.min(filteredPatients.length, currentPatientPage * PATIENTS_PER_PAGE);
                countInfo.textContent = `Showing ${startCount} to ${endCount} of ${filteredPatients.length} patients`;
            }

            if (prevBtn) prevBtn.disabled = currentPatientPage === 1;
            if (nextBtn) nextBtn.disabled = currentPatientPage >= totalPages;
        }

        // Go to previous page
        window.previousPatientPage = function () {
            if (currentPatientPage > 1) {
                currentPatientPage--;
                displayPatientPage();
                updatePatientPaginationInfo();
            }
        };

        // Go to next page
        window.nextPatientPage = function () {
            const totalPages = Math.ceil(filteredPatients.length / PATIENTS_PER_PAGE);
            if (currentPatientPage < totalPages) {
                currentPatientPage++;
                displayPatientPage();
                updatePatientPaginationInfo();
            }
        };

        // Function to generate unique Patient ID
        window.generatePatientID = async function () {
            try {
                // Get facility name from session
                const session = JSON.parse(localStorage.getItem('userSession') || '{}');
                const facilityName = session.facilityName || session.facility_name || 'FAC';

                // Get first 3 letters of facility name in uppercase
                const facilityPrefix = facilityName.substring(0, 3).toUpperCase();

                // Get the highest patient number from the database for this facility
                const {
                    data: patients,
                    error
                } = await supabaseClient
                    .from('patients')
                    .select('patient_no')
                    .like('patient_no', 'PAT-' + facilityPrefix + '%')
                    .order('patient_no', {
                        ascending: false
                    })
                    .limit(1);

                if (error) throw error;

                let nextNumber = 1001;
                if (patients && patients.length > 0) {
                    const lastPatientNo = patients[0].patient_no;
                    // Extract number from patient ID (e.g., "PAT-KIT 1005" -> 1005)
                    const lastNumber = parseInt(lastPatientNo.replace(/PAT-[A-Z]+\s/, '')) || 1000;
                    nextNumber = lastNumber + 1;
                }

                return 'PAT-' + facilityPrefix + ' ' + nextNumber;
            } catch (error) {
                console.error('Error generating Patient ID:', error);
                // Fallback: generate with timestamp
                const session = JSON.parse(localStorage.getItem('userSession') || '{}');
                const facilityName = session.facilityName || session.facility_name || 'FAC';
                const facilityPrefix = facilityName.substring(0, 3).toUpperCase();
                return 'PAT-' + facilityPrefix + ' ' + (1000 + Math.floor(Math.random() * 9000));
            }
        };

        // Edit patient - Wizard Form
        window.editPatient = function (patientNo) {
            const patient = allPatients.find(p => p.patient_no === patientNo);
            if (!patient) {
                Swal.fire({
                    title: 'Error',
                    text: 'Patient not found',
                    icon: 'error',
                    confirmButtonColor: '#15696B'
                });
                return;
            }

            let currentStep = 1;
            const totalSteps = 7;

            function showStep(step) {
                for (let i = 1; i <= totalSteps; i++) {
                    const stepEl = document.getElementById(`edit-wizard-step-${i}`);
                    if (stepEl) stepEl.style.display = 'none';
                }

                const currentStepEl = document.getElementById(`edit-wizard-step-${step}`);
                if (currentStepEl) currentStepEl.style.display = 'block';

                const progressBar = document.getElementById('edit-wizard-progress-bar');
                if (progressBar) {
                    const progress = (step / totalSteps) * 100;
                    progressBar.style.width = progress + '%';
                }

                const stepIndicator = document.getElementById('edit-wizard-step-indicator');
                if (stepIndicator) {
                    stepIndicator.textContent = `Step ${step} of ${totalSteps}`;
                }

                const prevBtn = document.getElementById('edit-wizard-prev-btn');
                const nextBtn = document.getElementById('edit-wizard-next-btn');
                const submitBtn = document.getElementById('edit-wizard-submit-btn');

                if (prevBtn) prevBtn.style.display = step > 1 ? 'block' : 'none';
                if (nextBtn) nextBtn.style.display = step < totalSteps ? 'block' : 'none';
                if (submitBtn) submitBtn.style.display = step === totalSteps ? 'block' : 'none';
            }

            const wizardHTML = `
          <div style="text-align: left;">
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span id="edit-wizard-step-indicator" style="font-weight: bold; color: #15696B;">Step 1 of ${totalSteps}</span>
                <span style="font-size: 12px; color: #666;">Edit Patient - Wizard</span>
              </div>
              <div style="width: 100%; height: 6px; background-color: #e0e0e0; border-radius: 3px; overflow: hidden;">
                <div id="edit-wizard-progress-bar" style="height: 100%; background-color: #15696B; width: 14.28%; transition: width 0.3s ease;"></div>
              </div>
            </div>

            <form id="editPatientWizardForm">
              <div id="edit-wizard-step-1" style="display: block;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Personal Information</h5>
                <div class="mb-3">
                  <label class="form-label">Patient ID</label>
                  <input type="text" class="form-control" value="${patient.patient_no || ''}" disabled>
                </div>
                <div class="mb-3">
                  <label class="form-label">First Name</label>
                  <input type="text" class="form-control" id="edit_first_name" value="${patient.first_name || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Last Name</label>
                  <input type="text" class="form-control" id="edit_last_name" value="${patient.last_name || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" id="edit_email" value="${patient.email || ''}">
                </div>
                <div class="mb-3">
                   <label class="form-label">Phone Number</label>
                   <input type="tel" class="form-control" id="edit_phone" placeholder="(+256) XXX XXX XXX" value="${patient.phone_number || ''}">
                 </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Age</label>
                      <input type="number" class="form-control" id="edit_age" value="${patient.age || ''}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Gender</label>
                      <select class="form-control" id="edit_gender">
                        <option value="Male" ${patient.gender === 'Male' ? 'selected' : ''}>Male</option>
                        <option value="Female" ${patient.gender === 'Female' ? 'selected' : ''}>Female</option>
                        <option value="Other" ${patient.gender === 'Other' ? 'selected' : ''}>Other</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Address</label>
                  <input type="text" class="form-control" id="edit_address" value="${patient.address || ''}">
                </div>
              </div>

              <div id="edit-wizard-step-2" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Clinical Status & Conditions</h5>
                <div class="mb-3">
                  <label class="form-label">Patient Status</label>
                  <select class="form-control" id="edit_status">
                    <option value="Active" ${patient.status === 'Active' ? 'selected' : ''}>Active</option>
                    <option value="Inactive" ${patient.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                    <option value="Critical" ${patient.status === 'Critical' ? 'selected' : ''}>Critical</option>
                    <option value="Alert" ${patient.status === 'Alert' ? 'selected' : ''}>Alert</option>
                    <option value="Transferred" ${patient.status === 'Transferred' ? 'selected' : ''}>Transferred</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Primary Condition</label>
                  <select class="form-control" id="edit_condition">
                    <option value="">Select condition</option>
                    <option value="HIV" ${patient.condition === 'HIV' ? 'selected' : ''}>HIV</option>
                    <option value="Diabetes" ${patient.condition === 'Diabetes' ? 'selected' : ''}>Diabetes</option>
                    <option value="Hypertension" ${patient.condition === 'Hypertension' ? 'selected' : ''}>Hypertension</option>
                    <option value="TB" ${patient.condition === 'TB' ? 'selected' : ''}>TB</option>
                    <option value="Cancer" ${patient.condition === 'Cancer' ? 'selected' : ''}>Cancer</option>
                    <option value="Asthma" ${patient.condition === 'Asthma' ? 'selected' : ''}>Asthma</option>
                    <option value="Heart Disease" ${patient.condition === 'Heart Disease' ? 'selected' : ''}>Heart Disease</option>
                    <option value="Other" ${patient.condition === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">HIV Status</label>
                  <select class="form-control" id="edit_hiv_status">
                    <option value="Positive" ${patient.hiv_status === 'Positive' ? 'selected' : ''}>Positive</option>
                    <option value="Negative" ${patient.hiv_status === 'Negative' ? 'selected' : ''}>Negative</option>
                    <option value="Unknown" ${patient.hiv_status === 'Unknown' ? 'selected' : ''}>Unknown</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Patient Type</label>
                  <select class="form-control" id="edit_patient_type">
                    <option value="">Select patient type</option>
                    <option value="New" ${patient.patient_type === 'New' ? 'selected' : ''}>New</option>
                    <option value="Returning" ${patient.patient_type === 'Returning' ? 'selected' : ''}>Returning</option>
                    <option value="Transferred" ${patient.patient_type === 'Transferred' ? 'selected' : ''}>Transferred In</option>
                  </select>
                </div>
              </div>

              <div id="edit-wizard-step-3" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Viral Load & HIV Monitoring</h5>
                <div class="mb-3">
                  <label class="form-label">Last Viral Load Date</label>
                  <input type="date" class="form-control" id="edit_last_viral_load_date" value="${patient.last_viral_load_date || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Viral Load Copies</label>
                  <input type="number" class="form-control" id="edit_viral_load_copies" value="${patient.viral_load_copies || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Viral Load Status</label>
                  <select class="form-control" id="edit_viral_load_status">
                    <option value="">Select status</option>
                    <option value="Undetectable" ${patient.viral_load_status === 'Undetectable' ? 'selected' : ''}>Undetectable</option>
                    <option value="Detectable" ${patient.viral_load_status === 'Detectable' ? 'selected' : ''}>Detectable</option>
                    <option value="Not Done" ${patient.viral_load_status === 'Not Done' ? 'selected' : ''}>Not Done</option>
                  </select>
                </div>
              </div>

              <div id="edit-wizard-step-4" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Vital Signs</h5>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Systolic (mmHg)</label>
                      <input type="number" class="form-control" id="edit_systolic" value="${patient.systolic || ''}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Diastolic (mmHg)</label>
                      <input type="number" class="form-control" id="edit_diastolic" value="${patient.diastolic || ''}">
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Glucose Level (mg/dL)</label>
                  <input type="number" step="0.1" class="form-control" id="edit_glucose_level" value="${patient.glucose_level || ''}">
                </div>
              </div>

              <div id="edit-wizard-step-5" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">HIV Treatment</h5>
                <div class="mb-3">
                  <label class="form-label">HIV Regimen</label>
                  <select class="form-control" id="edit_hiv_regimen">
                    <option value="">Select regimen</option>
                    <option value="TDF/FTC/EFV" ${patient.hiv_regimen === 'TDF/FTC/EFV' ? 'selected' : ''}>TDF/FTC/EFV (First-line)</option>
                    <option value="TDF/FTC/DTG" ${patient.hiv_regimen === 'TDF/FTC/DTG' ? 'selected' : ''}>TDF/FTC/DTG (First-line)</option>
                    <option value="AZT/3TC/EFV" ${patient.hiv_regimen === 'AZT/3TC/EFV' ? 'selected' : ''}>AZT/3TC/EFV (First-line)</option>
                    <option value="TDF/FTC/LPV/r" ${patient.hiv_regimen === 'TDF/FTC/LPV/r' ? 'selected' : ''}>TDF/FTC/LPV/r (Second-line)</option>
                    <option value="AZT/3TC/LPV/r" ${patient.hiv_regimen === 'AZT/3TC/LPV/r' ? 'selected' : ''}>AZT/3TC/LPV/r (Second-line)</option>
                    <option value="TDF/FTC/DTG/LPV/r" ${patient.hiv_regimen === 'TDF/FTC/DTG/LPV/r' ? 'selected' : ''}>TDF/FTC/DTG/LPV/r (Second-line)</option>
                    <option value="Other" ${patient.hiv_regimen === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Regimen Start Date</label>
                  <input type="date" class="form-control" id="edit_regimen_start_date" value="${patient.regimen_start_date || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Regimen Status</label>
                  <select class="form-control" id="edit_regimen_status">
                    <option value="">Select status</option>
                    <option value="Active" ${patient.regimen_status === 'Active' ? 'selected' : ''}>Active</option>
                    <option value="Changed" ${patient.regimen_status === 'Changed' ? 'selected' : ''}>Changed</option>
                    <option value="Stopped" ${patient.regimen_status === 'Stopped' ? 'selected' : ''}>Stopped</option>
                    <option value="Not Started" ${patient.regimen_status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Appointment Type</label>
                  <select class="form-control" id="edit_appointment_type">
                    <option value="">Select type</option>
                    <option value="General" ${patient.appointment_type === 'General' ? 'selected' : ''}>General</option>
                    <option value="Follow-up" ${patient.appointment_type === 'Follow-up' ? 'selected' : ''}>Follow-up</option>
                    <option value="Lab Test" ${patient.appointment_type === 'Lab Test' ? 'selected' : ''}>Lab Test</option>
                    <option value="Counseling" ${patient.appointment_type === 'Counseling' ? 'selected' : ''}>Counseling</option>
                  </select>
                </div>
              </div>

              <div id="edit-wizard-step-6" style="display: none;">
                 <h5 style="color: #15696B; margin-bottom: 15px;">Important Dates</h5>
                <div class="mb-3">
                  <label class="form-label">Patient Registration Date</label>
                  <input type="date" class="form-control" id="edit_patient_registration_date" value="${patient.patient_registration_date || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">ART Start Date</label>
                  <input type="date" class="form-control" id="edit_art_start_date" value="${patient.art_start_date || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Last Visit Date</label>
                  <input type="date" class="form-control" id="edit_visist_date" value="${patient.visist_date || ''}">
                </div>
              </div>

              <div id="edit-wizard-step-7" style="display: none;">
                 <h5 style="color: #15696B; margin-bottom: 15px;">Appointments & Clinical Notes</h5>
                <div class="mb-3">
                  <label class="form-label">Next Appointment Date</label>
                  <input type="date" class="form-control" id="edit_next_appointment" value="${patient.next_appointment || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Appointment Time</label>
                  <input type="time" class="form-control" id="edit_appointment_time" value="${patient.appointment_time || ''}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Clinical Note</label>
                  <textarea class="form-control" id="edit_clinical_note" rows="3">${patient.clinical_note || ''}</textarea>
                </div>
                </div>
            </form>
          </div>
        `;

            Swal.fire({
                title: 'Edit Patient',
                html: wizardHTML,
                didOpen: () => {
                    showStep(1);
                    // Initialize Select2 and Air Datepicker
                    setTimeout(() => {
                        initializeSelect2AndDatePicker();

                        // Add phone number formatter
                        const phoneInput = document.getElementById('edit_phone');
                        if (phoneInput) {
                            console.log('Phone input found:', phoneInput);

                            // Set initial format if value exists
                            if (phoneInput.value && phoneInput.value.length > 0) {
                                let initialValue = phoneInput.value.replace(/\D/g, '');
                                if (initialValue.startsWith('256')) {
                                    initialValue = initialValue.slice(3);
                                }
                                if (initialValue.length > 0) {
                                    let formatted = '(+256)';
                                    if (initialValue.length > 0) {
                                        formatted += ' ' + initialValue.slice(0, 3);
                                    }
                                    if (initialValue.length > 3) {
                                        formatted += ' ' + initialValue.slice(3, 6);
                                    }
                                    if (initialValue.length > 6) {
                                        formatted += ' ' + initialValue.slice(6, 9);
                                    }
                                    phoneInput.value = formatted;
                                }
                            }

                            // Use both input and keyup events
                            function formatPhone(e) {
                                let value = e.target.value.replace(/\D/g, '');
                                console.log('Phone value:', value);

                                // Remove leading 256 if present (user might paste it)
                                if (value.startsWith('256')) {
                                    value = value.slice(3);
                                }

                                // Limit to 9 digits (after country code)
                                if (value.length > 9) {
                                    value = value.slice(0, 9);
                                }

                                // Format as (+256) XXX XXX XXX
                                let formatted = '(+256)';
                                if (value.length > 0) {
                                    formatted += ' ' + value.slice(0, 3);
                                }
                                if (value.length > 3) {
                                    formatted += ' ' + value.slice(3, 6);
                                }
                                if (value.length > 6) {
                                    formatted += ' ' + value.slice(6, 9);
                                }

                                e.target.value = formatted;
                            }

                            phoneInput.addEventListener('input', formatPhone);
                            phoneInput.addEventListener('keyup', formatPhone);
                        } else {
                            console.log('Phone input not found');
                        }

                        // Add name capitalization on blur
                        const firstNameInput = document.getElementById('edit_first_name');
                        const lastNameInput = document.getElementById('edit_last_name');

                        if (firstNameInput) {
                            firstNameInput.addEventListener('blur', function () {
                                if (this.value) {
                                    this.value = this.value.charAt(0).toUpperCase() +
                                        this.value.slice(1).toLowerCase();
                                }
                            });
                        }

                        if (lastNameInput) {
                            lastNameInput.addEventListener('blur', function () {
                                if (this.value) {
                                    this.value = this.value.charAt(0).toUpperCase() +
                                        this.value.slice(1).toLowerCase();
                                }
                            });
                        }
                    }, 100);
                },
                showCancelButton: true,
                confirmButtonText: 'Next',
                confirmButtonColor: '#15696B',
                cancelButtonColor: '#6c757d',
                width: '650px',
                allowOutsideClick: false,
                willClose: () => {
                    currentStep = 1;
                }
            });

            setTimeout(() => {
                const footer = document.querySelector('.swal2-actions');
                if (footer) {
                    footer.innerHTML = `
              <button id="edit-wizard-prev-btn" class="wizard-btn wizard-btn-secondary" style="display: none; margin-right: auto;">
                <i class="ri-arrow-left-line"></i> Previous
              </button>
              <div style="display: flex; gap: 12px; margin-left: auto;">
                <button id="edit-wizard-next-btn" class="wizard-btn wizard-btn-primary">
                  Next <i class="ri-arrow-right-line"></i>
                </button>
                <button id="edit-wizard-submit-btn" class="wizard-btn wizard-btn-success" style="display: none;">
                  <i class="ri-check-line"></i> Update Patient
                </button>
                <button class="wizard-btn wizard-btn-outline" onclick="Swal.close()">
                  <i class="ri-close-line"></i> Cancel
                </button>
              </div>
            `;
                    footer.style.display = 'flex';
                    footer.style.alignItems = 'center';
                    footer.style.gap = '0';

                    document.getElementById('edit-wizard-prev-btn').addEventListener('click', () => {
                        if (currentStep > 1) {
                            currentStep--;
                            showStep(currentStep);
                        }
                    });

                    document.getElementById('edit-wizard-next-btn').addEventListener('click', () => {
                        if (currentStep < totalSteps) {
                            currentStep++;
                            showStep(currentStep);
                        }
                    });

                    document.getElementById('edit-wizard-submit-btn').addEventListener('click',
            async () => {
                        // Validation function
                        function validatePatientForm() {
                            const errors = [];

                            // Step 1: Personal Information
                            const firstName = document.getElementById('edit_first_name').value
                                .trim();
                            const lastName = document.getElementById('edit_last_name').value
                                .trim();
                            const email = document.getElementById('edit_email').value.trim();
                            const phone = document.getElementById('edit_phone').value.trim();
                            const age = document.getElementById('edit_age').value.trim();
                            const gender = document.getElementById('edit_gender').value;

                            if (!firstName) {
                                errors.push('First Name is required');
                            }
                            if (!lastName) {
                                errors.push('Last Name is required');
                            }
                            if (firstName && firstName.length < 2) {
                                errors.push('First Name must be at least 2 characters');
                            }
                            if (firstName && !/^[A-Z]/.test(firstName)) {
                                errors.push('First Name must start with a capital letter');
                            }
                            if (lastName && lastName.length < 2) {
                                errors.push('Last Name must be at least 2 characters');
                            }
                            if (lastName && !/^[A-Z]/.test(lastName)) {
                                errors.push('Last Name must start with a capital letter');
                            }
                            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                                errors.push('Please enter a valid email address');
                            }
                            if (phone && !/^\(\+\d{3}\)\s\d{3}\s\d{3}\s\d{3}$/.test(phone)) {
                                errors.push(
                                    'Phone number must be in format: (+256) XXX XXX XXX');
                            }
                            if (age && (isNaN(age) || age < 0 || age > 100)) {
                                errors.push('Age must be a valid number between 0 and 100');
                            }
                            if (!gender) {
                                errors.push('Gender is required');
                            }

                            // Step 2: Clinical Status
                            const status = document.getElementById('edit_status').value;
                            const hivStatus = document.getElementById('edit_hiv_status').value;

                            if (!status) {
                                errors.push('Patient Status is required');
                            }
                            if (!hivStatus) {
                                errors.push('HIV Status is required');
                            }

                            // Step 3: Viral Load
                            const viralLoadCopies = document.getElementById(
                                'edit_viral_load_copies').value.trim();
                            if (viralLoadCopies && (isNaN(viralLoadCopies) || parseInt(
                                    viralLoadCopies) < 0)) {
                                errors.push('Viral Load Copies must be a positive number');
                            }

                            // Step 4: Blood Pressure
                            const systolic = document.getElementById('edit_systolic').value
                                .trim();
                            const diastolic = document.getElementById('edit_diastolic').value
                                .trim();
                            if (systolic && (isNaN(systolic) || parseInt(systolic) < 0 ||
                                    parseInt(systolic) > 300)) {
                                errors.push('Systolic BP must be between 0 and 300');
                            }
                            if (diastolic && (isNaN(diastolic) || parseInt(diastolic) < 0 ||
                                    parseInt(diastolic) > 200)) {
                                errors.push('Diastolic BP must be between 0 and 200');
                            }

                            // Step 5: Glucose Level
                            const glucose = document.getElementById('edit_glucose_level').value
                                .trim();
                            if (glucose && (isNaN(glucose) || parseFloat(glucose) < 0 ||
                                    parseFloat(glucose) > 1000)) {
                                errors.push('Glucose Level must be between 0 and 1000');
                            }

                            // Step 6: Dates
                            const patientRegDate = document.getElementById(
                                'edit_patient_registration_date').value.trim();
                            const artStartDate = document.getElementById('edit_art_start_date')
                                .value.trim();
                            const today = new Date().toISOString().split('T')[0];

                            if (patientRegDate && patientRegDate < today) {
                                errors.push(
                                    'Patient Registration Date must be in the future (today or later)'
                                    );
                            }

                            if (artStartDate && patientRegDate && artStartDate <
                                patientRegDate) {
                                errors.push(
                                    'ART Start Date cannot be before Patient Registration Date'
                                    );
                            }

                            return errors;
                        }

                        // Validate form
                        const validationErrors = validatePatientForm();
                        if (validationErrors.length > 0) {
                            Swal.fire({
                                title: 'Validation Error',
                                html: '<ul style="text-align: left; font-size: 14px;">' +
                                    validationErrors.map(error =>
                                        `<li style="margin: 5px 0;">${error}</li>`)
                                    .join('') +
                                    '</ul>',
                                icon: 'error',
                                confirmButtonColor: '#15696B'
                            });
                            return;
                        }

                        const updatedData = {
                            first_name: document.getElementById('edit_first_name').value,
                            last_name: document.getElementById('edit_last_name').value,
                            email: document.getElementById('edit_email').value || null,
                            age: parseInt(document.getElementById('edit_age').value) ||
                                null,
                            gender: document.getElementById('edit_gender').value,
                            phone_number: document.getElementById('edit_phone').value ||
                                null,
                            address: document.getElementById('edit_address').value || null,
                            status: document.getElementById('edit_status').value,
                            condition: document.getElementById('edit_condition').value ||
                                null,
                            hiv_status: document.getElementById('edit_hiv_status').value,
                            patient_type: document.getElementById('edit_patient_type')
                                .value || null,
                            last_viral_load_date: document.getElementById(
                                'edit_last_viral_load_date').value || null,
                            viral_load_copies: parseInt(document.getElementById(
                                'edit_viral_load_copies').value) || null,
                            viral_load_status: document.getElementById(
                                'edit_viral_load_status').value || null,
                            glucose_level: document.getElementById('edit_glucose_level')
                                .value ? parseFloat(document.getElementById(
                                    'edit_glucose_level').value) : null,
                            patient_registration_date: document.getElementById(
                                'edit_patient_registration_date').value || null,
                            art_start_date: document.getElementById('edit_art_start_date')
                                .value || null,
                            next_appointment: document.getElementById(
                                'edit_next_appointment').value || null,
                            appointment_time: document.getElementById(
                                'edit_appointment_time').value || null,
                            notes: document.getElementById('edit_clinical_note').value ||
                                null
                        };

                        try {
                            const {
                                error
                            } = await supabaseClient
                                .from('patients')
                                .update(updatedData)
                                .eq('patient_no', patientNo);

                            if (error) throw error;

                            Swal.fire({
                                title: 'Success',
                                text: 'Patient updated successfully',
                                icon: 'success',
                                confirmButtonColor: '#15696B'
                            });

                            const session = JSON.parse(localStorage.getItem('userSession'));
                            await fetchAndPopulatePatients(session);
                        } catch (error) {
                            Swal.fire({
                                title: 'Error',
                                text: `Failed to update patient: ${error.message}`,
                                icon: 'error',
                                confirmButtonColor: '#15696B'
                            });
                        }
                    });
                }
            }, 100);
        };

        // Delete patient
        window.deletePatient = function (patientNo) {
            Swal.fire({
                title: 'Delete Patient',
                text: `Are you sure you want to delete patient ${patientNo}? This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const {
                            error
                        } = await supabaseClient
                            .from('patients')
                            .delete()
                            .eq('patient_no', patientNo);

                        if (error) throw error;

                        Swal.fire({
                            title: 'Deleted',
                            text: 'Patient has been deleted successfully',
                            icon: 'success',
                            confirmButtonColor: '#15696B'
                        });

                        // Refresh the table
                        const session = JSON.parse(localStorage.getItem('userSession'));
                        await fetchAndPopulatePatients(session);
                    } catch (error) {
                        Swal.fire({
                            title: 'Error',
                            text: `Failed to delete patient: ${error.message}`,
                            icon: 'error',
                            confirmButtonColor: '#15696B'
                        });
                    }
                }
            });
        };

        // Add new patient - Wizard Form
        window.addNewPatient = async function () {
            // Generate new Patient ID
            const newPatientID = await generatePatientID();

            let currentStep = 1;
            const totalSteps = 7;

            function showStep(step) {
                // Hide all steps
                for (let i = 1; i <= totalSteps; i++) {
                    const stepEl = document.getElementById(`wizard-step-${i}`);
                    if (stepEl) stepEl.style.display = 'none';
                }

                // Show current step
                const currentStepEl = document.getElementById(`wizard-step-${step}`);
                if (currentStepEl) currentStepEl.style.display = 'block';

                // Update progress bar
                const progressBar = document.getElementById('wizard-progress-bar');
                if (progressBar) {
                    const progress = (step / totalSteps) * 100;
                    progressBar.style.width = progress + '%';
                }

                // Update step indicator
                const stepIndicator = document.getElementById('wizard-step-indicator');
                if (stepIndicator) {
                    stepIndicator.textContent = `Step ${step} of ${totalSteps}`;
                }

                // Update button states
                const prevBtn = document.getElementById('wizard-prev-btn');
                const nextBtn = document.getElementById('wizard-next-btn');
                const submitBtn = document.getElementById('wizard-submit-btn');

                if (prevBtn) prevBtn.style.display = step > 1 ? 'block' : 'none';
                if (nextBtn) nextBtn.style.display = step < totalSteps ? 'block' : 'none';
                if (submitBtn) submitBtn.style.display = step === totalSteps ? 'block' : 'none';

                // Initialize Select2 for selects in current step
                setTimeout(() => {
                    try {
                        const selectElements = document.querySelectorAll(
                            '.swal2-html-container select.form-control');
                        selectElements.forEach(function (selectEl) {
                            if (typeof jQuery !== 'undefined') {
                                const $select = jQuery(selectEl);
                                if ($select.data('select2')) {
                                    try {
                                        $select.select2('destroy');
                                    } catch (e) {}
                                }
                                try {
                                    $select.select2({
                                        width: '100%',
                                        allowClear: false,
                                        dropdownParent: jQuery('.swal2-html-container')
                                    });
                                } catch (e) {
                                    console.log('Select2 init error:', e.message);
                                }
                            }
                        });
                    } catch (e) {
                        console.log('Select2 loop error:', e.message);
                    }
                }, 50);
            }

            // Auto-fill Blood Pressure from Systolic and Diastolic (removed - blood_pressure column not in database)
            function setupBloodPressureAutoFill() {
                // Function disabled - blood_pressure column has been removed from database
            }

            // Initialize all date pickers once at modal open
            function initAllDatePickers() {
                setTimeout(() => {
                    try {
                        const dateInputs = document.querySelectorAll(
                            '.swal2-html-container input[type="date"]');
                        console.log('Found date inputs to initialize:', dateInputs.length);

                        if (typeof window.flatpickr === 'undefined') {
                            console.log('Flatpickr not available');
                            return;
                        }

                        dateInputs.forEach(function (dateEl) {
                            try {
                                if (dateEl.classList.contains('flatpickr-initialized')) {
                                    return;
                                }

                                console.log('Initializing Flatpickr for:', dateEl.id);

                                // Initialize Flatpickr
                                flatpickr(dateEl, {
                                    mode: 'single',
                                    dateFormat: 'Y-m-d',
                                    enableTime: false,
                                    closeOnSelect: true,
                                    allowInput: true
                                });

                                dateEl.classList.add('flatpickr-initialized');
                                console.log('Flatpickr initialized for:', dateEl.id);

                            } catch (e) {
                                console.error('Flatpickr error for ' + dateEl.id + ':', e
                                    .message);
                            }
                        });

                    } catch (e) {
                        console.error('Date picker init error:', e);
                    }
                }, 100);
            }

            const wizardHTML = `
          <div style="text-align: left;">
            <!-- Progress Bar -->
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span id="wizard-step-indicator" style="font-weight: bold; color: #15696B;">Step 1 of ${totalSteps}</span>
                <span style="font-size: 12px; color: #666;">Patient Registration Wizard</span>
              </div>
              <div style="width: 100%; height: 6px; background-color: #e0e0e0; border-radius: 3px; overflow: hidden;">
                <div id="wizard-progress-bar" style="height: 100%; background-color: #15696B; width: 14.28%; transition: width 0.3s ease;"></div>
              </div>
            </div>

            <form id="addPatientWizardForm">
              <!-- STEP 1: Personal Information -->
              <div id="wizard-step-1" style="display: block;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Personal Information</h5>
                <div class="mb-3">
                   <label class="form-label">Patient ID *</label>
                   <input type="text" class="form-control" id="add_patient_no" placeholder="Auto-generated" value="${newPatientID}" disabled readonly>
                 </div>
                <div class="mb-3" style="display: none;">
                   <label class="form-label">Facility ID *</label>
                   <input type="text" class="form-control" id="add_facility_id_code" placeholder="Facility ID" disabled readonly>
                 </div>
                <div class="mb-3">
                  <label class="form-label">First Name *</label>
                  <input type="text" class="form-control" id="add_first_name" placeholder="Enter first name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Last Name *</label>
                  <input type="text" class="form-control" id="add_last_name" placeholder="Enter last name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" id="add_email" placeholder="Enter email address">
                </div>
                <div class="mb-3">
                  <label class="form-label">Phone Number</label>
                  <input type="tel" class="form-control" id="add_phone" placeholder="Enter phone number">
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Age</label>
                      <input type="number" class="form-control" id="add_age" placeholder="Enter age">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                       <label class="form-label">Gender *</label>
                       <select class="form-control" id="add_gender" required>
                         <option value="">Select gender</option>
                         <option value="Male">Male</option>
                         <option value="Female">Female</option>
                         <option value="Other">Other</option>
                       </select>
                     </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Address</label>
                  <input type="text" class="form-control" id="add_address" placeholder="Enter residential address">
                </div>
              </div>

              <!-- STEP 2: Clinical Status -->
              <div id="wizard-step-2" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Clinical Status & Conditions</h5>
                <div class="mb-3">
                  <label class="form-label">Patient Status *</label>
                  <select class="form-control" id="add_status" required>
                    <option value="">Select status</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Critical">Critical</option>
                    <option value="Alert">Alert</option>
                    <option value="Transferred">Transferred</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Primary Condition</label>
                  <select class="form-control" id="add_condition">
                    <option value="">Select condition</option>
                    <option value="HIV">HIV</option>
                    <option value="Diabetes">Diabetes</option>
                    <option value="Hypertension">Hypertension</option>
                    <option value="TB">TB</option>
                    <option value="Cancer">Cancer</option>
                    <option value="Asthma">Asthma</option>
                    <option value="Heart Disease">Heart Disease</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">HIV Status *</label>
                  <select class="form-control" id="add_hiv_status" required>
                    <option value="">Select HIV Status</option>
                    <option value="Positive">Positive</option>
                    <option value="Negative">Negative</option>
                    <option value="Unknown">Unknown</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Patient Type</label>
                  <select class="form-control" id="add_patient_type">
                    <option value="">Select patient type</option>
                    <option value="New">New</option>
                    <option value="Returning">Returning</option>
                    <option value="Transferred">Transferred In</option>
                  </select>
                </div>
              </div>

              <!-- STEP 3: Viral Load & HIV Monitoring -->
              <div id="wizard-step-3" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Viral Load & HIV Monitoring</h5>
                <div class="mb-3">
                  <label class="form-label">Last Viral Load Date</label>
                  <input type="date" class="form-control" id="add_last_viral_load_date">
                </div>
                <div class="mb-3">
                  <label class="form-label">Viral Load Copies</label>
                  <input type="number" class="form-control" id="add_viral_load_copies" placeholder="Enter viral load count">
                </div>
                <div class="mb-3">
                  <label class="form-label">Viral Load Status</label>
                  <select class="form-control" id="add_viral_load_status">
                    <option value="">Select status</option>
                    <option value="Undetectable">Undetectable</option>
                    <option value="Detectable">Detectable</option>
                    <option value="Not Done">Not Done</option>
                  </select>
                </div>
              </div>

              <!-- STEP 4: NCD Management -->
              <div id="wizard-step-4" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Vital Signs</h5>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Systolic (mmHg)</label>
                      <input type="number" class="form-control" id="add_systolic" placeholder="e.g., 120">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Diastolic (mmHg)</label>
                      <input type="number" class="form-control" id="add_diastolic" placeholder="e.g., 80">
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Glucose Level (mg/dL)</label>
                  <input type="number" step="0.1" class="form-control" id="add_glucose_level" placeholder="Enter glucose level">
                </div>
              </div>

              <!-- STEP 5: HIV Treatment Regimen -->
              <div id="wizard-step-5" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">HIV Treatment</h5>
                <div class="mb-3">
                  <label class="form-label">HIV Regimen</label>
                  <select class="form-control" id="add_hiv_regimen">
                    <option value="">Select regimen</option>
                    <option value="TDF/FTC/EFV">TDF/FTC/EFV (First-line)</option>
                    <option value="TDF/FTC/DTG">TDF/FTC/DTG (First-line)</option>
                    <option value="AZT/3TC/EFV">AZT/3TC/EFV (First-line)</option>
                    <option value="TDF/FTC/LPV/r">TDF/FTC/LPV/r (Second-line)</option>
                    <option value="AZT/3TC/LPV/r">AZT/3TC/LPV/r (Second-line)</option>
                    <option value="TDF/FTC/DTG/LPV/r">TDF/FTC/DTG/LPV/r (Second-line)</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Regimen Start Date</label>
                  <input type="date" class="form-control" id="add_regimen_start_date">
                </div>
                <div class="mb-3">
                  <label class="form-label">Regimen Status</label>
                  <select class="form-control" id="add_regimen_status">
                    <option value="">Select status</option>
                    <option value="Active">Active</option>
                    <option value="Changed">Changed</option>
                    <option value="Stopped">Stopped</option>
                    <option value="Not Started">Not Started</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Appointment Type</label>
                  <select class="form-control" id="add_appointment_type">
                    <option value="">Select type</option>
                    <option value="General">General</option>
                    <option value="Follow-up">Follow-up</option>
                    <option value="Lab Test">Lab Test</option>
                    <option value="Counseling">Counseling</option>
                  </select>
                </div>
              </div>

              <!-- STEP 6: Important Dates -->
              <div id="wizard-step-6" style="display: none;">
                <h5 style="color: #15696B; margin-bottom: 15px;">Important Dates</h5>
                <div class="mb-3">
                  <label class="form-label">Patient Registration Date</label>
                  <input type="date" class="form-control" id="add_patient_registration_date">
                </div>
                <div class="mb-3">
                  <label class="form-label">ART Start Date</label>
                  <input type="date" class="form-control" id="add_art_start_date">
                </div>
                <div class="mb-3">
                  <label class="form-label">Last Visit Date</label>
                  <input type="date" class="form-control" id="add_visist_date">
                </div>
              </div>

              <!-- STEP 7: Appointments & Notes -->
              <div id="wizard-step-7" style="display: none;">
                 <h5 style="color: #15696B; margin-bottom: 15px;">Appointments & Clinical Notes</h5>
                <div class="mb-3">
                  <label class="form-label">Next Appointment Date</label>
                  <input type="date" class="form-control" id="add_next_appointment">
                </div>
                <div class="mb-3">
                  <label class="form-label">Appointment Time</label>
                  <input type="time" class="form-control" id="add_appointment_time">
                </div>
                <div class="mb-3">
                  <label class="form-label">Clinical Note</label>
                  <textarea class="form-control" id="add_clinical_note" rows="3" placeholder="Enter detailed clinical notes"></textarea>
                </div>
                </div>
            </form>
          </div>
        `;

            Swal.fire({
                title: 'Add New Patient',
                html: wizardHTML,
                didOpen: () => {
                    console.log('Modal didOpen callback triggered');
                    showStep(1);
                    // Set facility info from session
                    const session = JSON.parse(localStorage.getItem('userSession'));
                    const facilityEl = document.getElementById('add_facility_id_code');
                    if (facilityEl && session) {
                        facilityEl.value = session.facilityIdCode || 'N/A';
                    }
                    // Initialize all date pickers once
                    console.log('About to call initAllDatePickers, function exists:',
                        typeof initAllDatePickers);
                    if (typeof initAllDatePickers === 'function') {
                        initAllDatePickers();
                    } else {
                        console.log('initAllDatePickers is not a function');
                    }
                    // Setup blood pressure auto-fill
                    if (typeof setupBloodPressureAutoFill === 'function') {
                        setupBloodPressureAutoFill();
                    }
                },
                showCancelButton: true,
                confirmButtonText: 'Next',
                confirmButtonColor: '#15696B',
                cancelButtonColor: '#6c757d',
                width: '650px',
                allowOutsideClick: false,
                willClose: () => {
                    // Reset when modal closes
                    currentStep = 1;
                }
            });

            // Add custom navigation buttons
            setTimeout(() => {
                const footer = document.querySelector('.swal2-actions');
                if (footer) {
                    footer.innerHTML = `
              <button id="wizard-prev-btn" class="btn btn-secondary" style="display: none; margin-right: 10px;">Previous</button>
              <button id="wizard-next-btn" class="btn btn-primary" style="background-color: #15696B; border-color: #15696B;">Next</button>
              <button id="wizard-submit-btn" class="btn btn-success" style="display: none;">Submit</button>
              <button class="btn btn-outline-secondary" onclick="Swal.close()">Cancel</button>
            `;

                    document.getElementById('wizard-prev-btn').addEventListener('click', () => {
                        if (currentStep > 1) {
                            currentStep--;
                            showStep(currentStep);
                            document.querySelector('.swal2-confirm').textContent =
                                currentStep === totalSteps ? 'Submit' : 'Next';
                        }
                    });

                    document.getElementById('wizard-next-btn').addEventListener('click', () => {
                        if (currentStep < totalSteps) {
                            currentStep++;
                            showStep(currentStep);
                        }
                    });

                    document.getElementById('wizard-submit-btn').addEventListener('click', async () => {
                        const patientNo = document.getElementById('add_patient_no').value;
                        const firstName = document.getElementById('add_first_name').value;
                        const lastName = document.getElementById('add_last_name').value;
                        const gender = document.getElementById('add_gender').value;
                        const status = document.getElementById('add_status').value;
                        const hivStatus = document.getElementById('add_hiv_status').value;

                        if (!patientNo || !firstName || !lastName || !gender || !status || !
                            hivStatus) {
                            Swal.showValidationMessage(
                            'Please fill in all required fields');
                            return;
                        }

                        const session = JSON.parse(localStorage.getItem('userSession'));
                        const newPatientData = {
                            patient_no: patientNo,
                            first_name: firstName,
                            last_name: lastName,
                            email: document.getElementById('add_email').value || null,
                            age: parseInt(document.getElementById('add_age').value) ||
                                null,
                            gender: gender,
                            phone_number: document.getElementById('add_phone').value ||
                                null,
                            address: document.getElementById('add_address').value ||
                                null,
                            status: status,
                            condition: document.getElementById('add_condition').value ||
                                null,
                            hiv_status: hivStatus,
                            patient_type: document.getElementById('add_patient_type')
                                .value || null,
                            last_viral_load_date: document.getElementById(
                                'add_last_viral_load_date').value || null,
                            viral_load_copies: parseInt(document.getElementById(
                                'add_viral_load_copies').value) || null,
                            viral_load_status: document.getElementById(
                                'add_viral_load_status').value || null,
                            systolic: parseInt(document.getElementById('add_systolic')
                                .value) || null,
                            diastolic: parseInt(document.getElementById('add_diastolic')
                                .value) || null,

                            glucose_level: document.getElementById('add_glucose_level')
                                .value ? parseFloat(document.getElementById(
                                    'add_glucose_level').value) : null,
                            patient_registration_date: document.getElementById(
                                'add_patient_registration_date').value || null,
                            art_start_date: document.getElementById(
                                'add_art_start_date').value || null,
                            next_appointment: document.getElementById(
                                'add_next_appointment').value || null,
                            appointment_time: document.getElementById(
                                'add_appointment_time').value || null,
                            notes: document.getElementById('add_clinical_note').value ||
                                null,
                            fid: session.fid || session.facility_id
                        };

                        try {
                            const {
                                error
                            } = await supabaseClient
                                .from('patients')
                                .insert([newPatientData]);

                            if (error) throw error;

                            Swal.fire({
                                title: 'Success',
                                text: 'Patient added successfully',
                                icon: 'success',
                                confirmButtonColor: '#15696B'
                            });

                            const updatedSession = JSON.parse(localStorage.getItem(
                                'userSession'));
                            await fetchAndPopulatePatients(updatedSession);
                        } catch (error) {
                            Swal.fire({
                                title: 'Error',
                                text: `Failed to add patient: ${error.message}`,
                                icon: 'error',
                                confirmButtonColor: '#15696B'
                            });
                        }
                    });
                }
            }, 100);
        };

        // Get patient data for export
        function getPatientExportData() {
            return {
                headers: ['Patient ID', 'First Name', 'Last Name', 'Age', 'Gender', 'Phone', 'Address', 'Condition',
                    'Status', 'HIV Status', 'Notes'
                ],
                rows: filteredPatients.map(patient => [
                    patient.patient_no || '',
                    patient.first_name || '',
                    patient.last_name || '',
                    patient.age || '',
                    patient.gender || '',
                    patient.phone_number || '',
                    patient.address || '',
                    patient.condition || '',
                    patient.status || '',
                    patient.hiv_status || '',
                    patient.notes || ''
                ])
            };
        }

        // Export patients to CSV
        window.exportPatientsToCSV = function () {
            const {
                headers,
                rows
            } = getPatientExportData();

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csvContent], {
                type: 'text/csv'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `patients_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        };

        // Export patients to Excel
        window.exportPatientsToExcel = function () {
            try {
                if (!window.XLSX) {
                    throw new Error('XLSX library not loaded');
                }

                const {
                    headers,
                    rows
                } = getPatientExportData();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);

                // Set column widths
                ws['!cols'] = [{
                        wch: 12
                    }, {
                        wch: 15
                    }, {
                        wch: 15
                    }, {
                        wch: 8
                    }, {
                        wch: 10
                    },
                    {
                        wch: 20
                    }, {
                        wch: 15
                    }, {
                        wch: 12
                    }, {
                        wch: 15
                    }, {
                        wch: 20
                    }
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Patients');
                XLSX.writeFile(wb, `patients_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                Swal.fire({
                    title: 'Export Failed',
                    text: `Failed to export patients to Excel: ${error.message}`,
                    icon: 'error',
                    confirmButtonColor: '#15696B'
                });
            }
        };

        // Export patients to PDF
        window.exportPatientsToPDF = function () {
            try {
                if (!window.jspdf) {
                    throw new Error('jsPDF library not loaded');
                }

                const {
                    headers,
                    rows
                } = getPatientExportData();
                const {
                    jsPDF
                } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape'
                });

                doc.setFontSize(16);
                doc.text('Patients Report', 14, 15);

                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 25);

                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 35,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [21, 105, 107],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    bodyStyles: {
                        textColor: [0, 0, 0]
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    },
                    margin: 10,
                    didDrawPage: function (data) {
                        // Add page number
                        const pageSize = doc.internal.pageSize;
                        const pageHeight = pageSize.getHeight();
                        const pageWidth = pageSize.getWidth();
                        doc.setFontSize(8);
                        doc.text(`Page ${doc.internal.pages.length - 1}`, pageWidth - 20, pageHeight -
                            10);
                    }
                });

                doc.save(`patients_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                Swal.fire({
                    title: 'Export Failed',
                    text: `Failed to export patients to PDF: ${error.message}`,
                    icon: 'error',
                    confirmButtonColor: '#15696B'
                });
            }
        };

        // Fetch and populate all patients in the table
        async function fetchAndPopulatePatients(session) {
            try {
                console.log('fetchAndPopulatePatients called with session:', session);

                // Check if supabaseClient is available
                if (!supabaseClient) {
                    console.error('Supabase client not initialized');
                    document.getElementById('patientsTableBody').innerHTML =
                        '<tr><td colspan="10" class="text-center text-danger">Supabase not initialized</td></tr>';
                    return;
                }

                const numericFacilityId = session.fid || session.facility_id || session.facilityId;
                console.log('Fetching patients for facility ID:', numericFacilityId);

                // Fetch all patients for the facility with relevant fields
                const {
                    data: patients,
                    error: patientError
                } = await supabaseClient
                    .from('patients')
                    .select(
                        'pid, patient_no, first_name, last_name, age, gender, phone_number, address, condition, status, hiv_status, notes'
                        )
                    .eq('fid', numericFacilityId);

                console.log('Patients fetch result:', {
                    patients,
                    error: patientError
                });

                // Log first patient to see what fields are available
                if (patients && patients.length > 0) {
                    console.log('First patient object keys:', Object.keys(patients[0]));
                    console.log('First patient pid:', patients[0].pid);
                }

                if (patientError) {
                    console.error('Error fetching patients:', patientError);
                    document.getElementById('patientsTableBody').innerHTML =
                        `<tr><td colspan="10" class="text-center text-danger">Error: ${patientError.message}</td></tr>`;
                    return;
                }

                if (!patients || patients.length === 0) {
                    document.getElementById('patientsTableBody').innerHTML =
                        '<tr><td colspan="10" class="text-center">No patients found</td></tr>';
                    return;
                }

                console.log('Fetched', patients.length, 'patients');

                // Store all patients for filtering
                allPatients = patients;
                filteredPatients = patients;
                currentPatientPage = 1;

                // Setup event listeners for search and filters
                setupPatientTableControls();

                // Display first page
                displayPatientPage();
                updatePatientPaginationInfo();
            } catch (error) {
                console.error('Error fetching and populating patients:', error);
                document.getElementById('patientsTableBody').innerHTML =
                    `<tr><td colspan="10" class="text-center text-danger">Error: ${error.message}</td></tr>`;
            }
        }

        // Helper function to get status badge class
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'Active':
                    return 'bg-success-subtle text-success';
                case 'Inactive':
                    return 'bg-danger-subtle text-danger';
                case 'Critical':
                    return 'bg-warning-subtle text-warning';
                case 'Alert':
                    return 'bg-info-subtle text-info';
                default:
                    return 'bg-secondary-subtle text-secondary';
            }
        }

        // Helper function to get HIV status badge class
        function getHIVStatusBadgeClass(hivStatus) {
            if (!hivStatus) return 'bg-secondary-subtle text-secondary';
            const status = hivStatus.toLowerCase();
            if (status.includes('positive')) {
                return 'bg-danger-subtle text-danger';
            } else if (status.includes('negative')) {
                return 'bg-success-subtle text-success';
            } else if (status.includes('unknown')) {
                return 'bg-warning-subtle text-warning';
            }
            return 'bg-secondary-subtle text-secondary';
        }

        // Setup logout button functionality
        function setupLogoutButton() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    logout();
                });
            }
        }

        // Logout function
        function logout() {
            // Clear session data
            localStorage.removeItem('userSession');
            localStorage.removeItem('healthflow_email');

            // Clear inactivity timer
            if (inactivityTimeout) {
                clearTimeout(inactivityTimeout);
            }

            // Redirect to login page
            window.location.href = 'login.html';
        }

        // Setup session timeout on inactivity
        function setupSessionTimeout() {
            resetInactivityTimer();
        }

        // Reset inactivity timer
        function resetInactivityTimer() {
            // Clear existing timeout
            if (inactivityTimeout) {
                clearTimeout(inactivityTimeout);
            }

            // Set new timeout
            inactivityTimeout = setTimeout(function () {
                // Session expired due to inactivity
                const sessionData = localStorage.getItem('userSession');
                if (sessionData) {
                    // Show warning before logout
                    Swal.fire({
                        title: 'Session Expired',
                        text: 'Your session has expired due to inactivity. Please login again.',
                        icon: 'warning',
                        confirmButtonColor: '#15696B',
                        confirmButtonText: 'Login',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then((result) => {
                        if (result.isConfirmed) {
                            logout();
                        }
                    });
                }
            }, SESSION_TIMEOUT);
        }

        // Handle page visibility change (minimize/maximize)
        document.addEventListener('visibilitychange', function () {
            if (!document.hidden) {
                // Page is now visible, check session validity
                const sessionData = localStorage.getItem('userSession');
                if (!sessionData) {
                    window.location.href = 'login.html';
                }
            }
        });
    </script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Air Datepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.4.0/air-datepicker.js"></script>

    <!-- Verify libraries are loaded -->
    <script>
        window.addEventListener('load', function () {
            console.log('AirDatepicker available:', typeof window.AirDatepicker !== 'undefined');
            console.log('jQuery available:', typeof jQuery !== 'undefined');
            console.log('Select2 available:', typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !==
                'undefined');
        });
    </script>

    <!-- Set English as default language for Air Datepicker -->
    <script>
        window.AirDatepickerLocaleOverride = {
            en: {
                days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                daysShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                daysMin: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'],
                months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September',
                    'October', 'November', 'December'
                ],
                monthsShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                today: 'Today',
                clear: 'Clear'
            }
        };
    </script>

    <!-- Initialize Select2 and Air Datepicker -->
    <script>
        function initializeSelect2AndDatePicker() {
            try {
                // Initialize Select2 for all select elements
                const selectElements = document.querySelectorAll('.swal2-html-container select.form-control');
                selectElements.forEach(function (selectEl) {
                    const $select = jQuery(selectEl);

                    // Destroy existing Select2 if it exists
                    if ($select.data('select2')) {
                        $select.select2('destroy');
                    }

                    // Initialize Select2 with dropdown parent set to html-container
                    $select.select2({
                        width: '100%',
                        allowClear: false,
                        dropdownParent: jQuery('.swal2-html-container')
                    });
                });

                // Initialize Air Datepicker for all date inputs
                const dateElements = document.querySelectorAll('.swal2-html-container input[type="date"]');
                dateElements.forEach(function (dateEl) {
                    if (!dateEl.hasAttribute('data-datepicker-initialized')) {
                        try {
                            // Change input type to text for Air Datepicker
                            const textInput = document.createElement('input');
                            textInput.type = 'text';
                            textInput.className = dateEl.className;
                            textInput.id = dateEl.id;
                            textInput.value = dateEl.value;
                            dateEl.parentNode.replaceChild(textInput, dateEl);

                            new AirDatepicker(textInput, {
                                isMobile: false,
                                autoClose: true,
                                position: 'bottom left',
                                dateFormat: 'yyyy-MM-dd',
                                locale: window.AirDatepickerLocaleOverride.en,
                                onSelect: function ({
                                    date
                                }) {
                                    if (date) {
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        textInput.value = `${year}-${month}-${day}`;
                                    }
                                }
                            });
                            textInput.setAttribute('data-datepicker-initialized', 'true');
                        } catch (e) {
                            console.log('AirDatepicker init error:', e.message);
                        }
                    }
                });
            } catch (error) {
                console.log('Initialization info:', error);
            }
        }

        // Make function globally accessible
        window.initializeSelect2AndDatePicker = initializeSelect2AndDatePicker;

        // ============================================
        // Patient Medical History & Appointments Functions
        // ============================================

        // View patient details when clicked from table
        async function viewPatientDetails(patientId) {
            try {
                console.log('viewPatientDetails called with patientId:', patientId);

                if (!patientId) {
                    Swal.fire('Error', 'Invalid patient ID', 'error');
                    return;
                }

                const session = window.currentSession || JSON.parse(localStorage.getItem('userSession'));
                const facilityId = session.fid || session.facility_id;

                console.log('Fetching patient details for patientId:', patientId, 'facilityId:', facilityId);

                // Fetch patient details
                const {
                    data: patients,
                    error
                } = await supabaseClient
                    .from('patients')
                    .select('*')
                    .eq('pid', patientId)
                    .eq('fid', facilityId)
                    .single();

                console.log('Patient fetch result:', {
                    patients,
                    error
                });

                if (error) {
                    Swal.fire('Error', 'Failed to load patient details: ' + error.message, 'error');
                    return;
                }

                if (!patients) {
                    Swal.fire('Not Found', 'Patient not found', 'warning');
                    return;
                }

                // Show and scroll to the medical history section
                const medicalHistorySection = document.getElementById('patient-records');
                if (medicalHistorySection) {
                    medicalHistorySection.style.display = 'flex';
                    setTimeout(() => {
                        medicalHistorySection.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }, 100);
                }

                // Display patient information
                displayPatientMedicalHistory(patients);
                displayPatientAppointments(patients);
                displayPatientClinicalNotes(patients);
            } catch (err) {
                console.error('Error loading patient details:', err);
                Swal.fire('Error', 'Failed to load patient details', 'error');
            }
        }

        // Display patient medical history
        function displayPatientMedicalHistory(patient) {
            try {
                const medicalHistoryDiv = document.getElementById('medicalHistoryContent');

                // Format the medical history content
                const historyHTML = `
            <div class="patient-record-header mb-4">
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-muted mb-3">Patient Information</h6>
                  <table class="table table-sm table-borderless">
                    <tbody>
                      <tr>
                        <td class="fw-500" style="width: 40%;">Patient ID:</td>
                        <td>${patient.patient_no || '-'}</td>
                      </tr>
                      <tr>
                        <td class="fw-500">Name:</td>
                        <td>${patient.first_name || ''} ${patient.last_name || ''}</td>
                      </tr>
                      <tr>
                        <td class="fw-500">Age:</td>
                        <td>${patient.age || '-'}</td>
                      </tr>
                      <tr>
                        <td class="fw-500">Gender:</td>
                        <td>${patient.gender || '-'}</td>
                      </tr>
                      <tr>
                        <td class="fw-500">Phone:</td>
                        <td>${patient.phone_number || '-'}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-3">Clinical Information</h6>
                  <table class="table table-sm table-borderless">
                    <tbody>
                      <tr>
                        <td class="fw-500" style="width: 40%;">Condition:</td>
                        <td><span class="badge bg-primary">${patient.condition || 'N/A'}</span></td>
                      </tr>
                      <tr>
                        <td class="fw-500">Status:</td>
                        <td><span class="badge ${getStatusBadgeClass(patient.status)}">${patient.status || 'Unknown'}</span></td>
                      </tr>
                      <tr>
                        <td class="fw-500">HIV Status:</td>
                        <td><span class="badge ${getHIVStatusBadgeClass(patient.hiv_status)}">${patient.hiv_status || 'Unknown'}</span></td>
                      </tr>
                      <tr>
                        <td class="fw-500">Viral Load:</td>
                        <td>${patient.viral_load_copies ? patient.viral_load_copies.toLocaleString() + ' copies/mL' : '-'}</td>
                      </tr>
                      <tr>
                        <td class="fw-500">Last Viral Load Date:</td>
                        <td>${patient.last_viral_load_date ? new Date(patient.last_viral_load_date).toLocaleDateString() : '-'}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <hr>
            <h6 class="text-muted mb-3">Medical History Notes</h6>
            <div class="alert alert-light border">
              <p>${patient.notes || 'No medical history notes available'}</p>
            </div>
          `;

                medicalHistoryDiv.innerHTML = historyHTML;
            } catch (err) {
                console.error('Error displaying medical history:', err);
                document.getElementById('medicalHistoryContent').innerHTML =
                    '<p class="text-danger">Error loading medical history</p>';
            }
        }

        // Display patient appointments
        function displayPatientAppointments(patient) {
            try {
                const appointmentsDiv = document.getElementById('appointmentsContent');

                let appointmentHTML = `
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Appointment Date</th>
                    <th>Status</th>
                    <th>Days Until</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
          `;

                if (patient.next_appointment) {
                    const apptDate = new Date(patient.next_appointment);
                    const today = new Date();
                    const daysUntil = Math.ceil((apptDate - today) / (1000 * 60 * 60 * 24));
                    const apptStatus = daysUntil < 0 ? 'Overdue' : daysUntil === 0 ? 'Today' : 'Upcoming';
                    const statusBadgeClass = daysUntil < 0 ? 'bg-danger' : daysUntil === 0 ? 'bg-warning' :
                    'bg-success';

                    appointmentHTML += `
              <tr>
                <td>${apptDate.toLocaleDateString()}</td>
                <td><span class="badge ${statusBadgeClass}">${apptStatus}</span></td>
                <td>${daysUntil} days</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="editAppointment('${patient.pid}')">
                    <i class="ri-edit-line"></i>
                  </button>
                </td>
              </tr>
            `;
                } else {
                    appointmentHTML += `
              <tr>
                <td colspan="4" class="text-center text-muted py-4">No appointments scheduled</td>
              </tr>
            `;
                }

                appointmentHTML += `
                </tbody>
              </table>
            </div>
          `;

                appointmentsDiv.innerHTML = appointmentHTML;
            } catch (err) {
                console.error('Error displaying appointments:', err);
            }
        }

        // Display patient clinical notes
        function displayPatientClinicalNotes(patient) {
            try {
                const clinicalNotesDiv = document.getElementById('clinicalNotesContent');

                const clinicalNote = patient.notes || 'No clinical notes available';

                const notesHTML = `
            <div class="clinical-notes-section">
              <div class="mb-3">
                <label class="form-label text-muted small">Clinical Notes</label>
                <div class="alert alert-light border p-3">
                  <p>${clinicalNote}</p>
                </div>
              </div>
            </div>
          `;

                clinicalNotesDiv.innerHTML = notesHTML;
            } catch (err) {
                console.error('Error displaying clinical notes:', err);
            }
        }

        // Edit appointment function
        async function editAppointment(patientId) {
            try {
                console.log('editAppointment called with patientId:', patientId);

                if (!patientId) {
                    Swal.fire('Error', 'Invalid patient ID', 'error');
                    return;
                }

                const session = window.currentSession || JSON.parse(localStorage.getItem('userSession'));
                const facilityId = session.fid || session.facility_id;

                // Fetch patient appointment details
                const {
                    data: patient,
                    error
                } = await supabaseClient
                    .from('patients')
                    .select('*')
                    .eq('pid', patientId)
                    .eq('fid', facilityId)
                    .single();

                if (error) {
                    Swal.fire('Error', 'Failed to load appointment: ' + error.message, 'error');
                    return;
                }

                if (!patient) {
                    Swal.fire('Error', 'Patient not found', 'error');
                    return;
                }

                // Format current appointment date for input
                const currentDate = patient.next_appointment ? new Date(patient.next_appointment).toISOString()
                    .split('T')[0] : '';
                const currentTime = patient.appointment_time || '09:00';

                // Show SweetAlert2 modal with appointment form
                const {
                    value: formValues
                } = await Swal.fire({
                    title: 'Edit Appointment',
                    html: `
              <div class="swal2-form-group">
                <label for="appointmentDate" class="swal2-label">Appointment Date</label>
                <input type="date" id="appointmentDate" class="swal2-input" value="${currentDate}" required>
              </div>
              <div class="swal2-form-group">
                <label for="appointmentTime" class="swal2-label">Appointment Time</label>
                <input type="time" id="appointmentTime" class="swal2-input" value="${currentTime}" required>
              </div>
              <div class="swal2-form-group">
                <label for="appointmentNotes" class="swal2-label">Notes (Optional)</label>
                <textarea id="appointmentNotes" class="swal2-textarea" placeholder="Add appointment notes..."></textarea>
              </div>
            `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Save Appointment',
                    cancelButtonText: 'Cancel',
                    didOpen: (modal) => {
                        // Add custom styling for the form
                        const form = modal.querySelector('.swal2-html-container');
                        if (form) {
                            form.style.textAlign = 'left';
                            form.style.maxHeight = '400px';
                            form.style.overflowY = 'auto';
                        }

                        // Style form groups
                        const formGroups = modal.querySelectorAll('.swal2-form-group');
                        formGroups.forEach(group => {
                            group.style.marginBottom = '15px';
                            group.style.textAlign = 'left';
                        });

                        // Style labels
                        const labels = modal.querySelectorAll('.swal2-label');
                        labels.forEach(label => {
                            label.style.display = 'block';
                            label.style.marginBottom = '5px';
                            label.style.fontWeight = '500';
                            label.style.fontSize = '14px';
                        });

                        // Style inputs and textarea
                        const inputs = modal.querySelectorAll('.swal2-input, .swal2-textarea');
                        inputs.forEach(input => {
                            input.style.width = '100%';
                            input.style.padding = '8px';
                            input.style.border = '1px solid #ced4da';
                            input.style.borderRadius = '4px';
                            input.style.fontSize = '14px';
                            input.style.fontFamily = 'inherit';
                        });

                        const textarea = modal.querySelector('.swal2-textarea');
                        if (textarea) {
                            textarea.style.minHeight = '80px';
                            textarea.style.resize = 'vertical';
                        }
                    },
                    preConfirm: () => {
                        const date = document.getElementById('appointmentDate').value;
                        const time = document.getElementById('appointmentTime').value;
                        const notes = document.getElementById('appointmentNotes').value;

                        if (!date) {
                            Swal.showValidationMessage('Please select an appointment date');
                            return false;
                        }
                        if (!time) {
                            Swal.showValidationMessage('Please select an appointment time');
                            return false;
                        }

                        return {
                            date,
                            time,
                            notes
                        };
                    }
                });

                if (formValues) {
                    // Combine date and time
                    const appointmentDateTime = new Date(`${formValues.date}T${formValues.time}`);

                    // Update appointment in database
                    const {
                        error: updateError
                    } = await supabaseClient
                        .from('patients')
                        .update({
                            next_appointment: appointmentDateTime.toISOString().split('T')[0],
                            appointment_time: formValues.time
                        })
                        .eq('pid', patientId)
                        .eq('fid', facilityId);

                    if (updateError) {
                        Swal.fire('Error', 'Failed to save appointment: ' + updateError.message, 'error');
                        return;
                    }

                    // Reload patient details to show updated appointment
                    await viewPatientDetails(patientId);

                    Swal.fire('Success', 'Appointment updated successfully', 'success');
                }
            } catch (err) {
                console.error('Error editing appointment:', err);
                Swal.fire('Error', 'An error occurred while editing the appointment', 'error');
            }
        }

        // Store current stat filter for later use
        let currentStatFilter = null;
        let currentStatData = [];

        // Export stat data to Excel with proper styling using ExcelJS
        async function exportStatToExcel() {
            const titles = {
                'all-appointments': 'All Appointments',
                'next-week': 'Next Week Appointments',
                'overdue': 'Overdue Appointments',
                'missed': 'Missed Appointments',
                'high-viral': 'High Viraemia Patients',
                'low-viral': 'Low Viraemia Patients'
            };

            if (currentStatData.length === 0) {
                alert('No data to export');
                return;
            }

            try {
                // Create workbook
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Patients');

                // Add headers
                const headers = [
                    'Patient Name', 'Patient No', 'Gender', 'Age', 'Phone Number',
                    'Condition', 'Next Appointment', 'Appointment Type', 'Viral Load Copies',
                    'Last VL Date', 'Address'
                ];

                const headerRow = worksheet.addRow(headers);

                // Style header row
                headerRow.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: {
                            argb: 'FF156B6B'
                        }
                    };
                    cell.font = {
                        bold: true,
                        color: {
                            argb: 'FFFFFFFF'
                        },
                        size: 11
                    };
                    cell.alignment = {
                        horizontal: 'center',
                        vertical: 'center'
                    };
                    cell.border = {
                        top: {
                            style: 'thin',
                            color: {
                                argb: 'FF000000'
                            }
                        },
                        left: {
                            style: 'thin',
                            color: {
                                argb: 'FF000000'
                            }
                        },
                        bottom: {
                            style: 'thin',
                            color: {
                                argb: 'FF000000'
                            }
                        },
                        right: {
                            style: 'thin',
                            color: {
                                argb: 'FF000000'
                            }
                        }
                    };
                });

                // Check if this is next-week filter for grouping by weekday
                const isNextWeek = currentStatFilter === 'next-week';
                let dataToProcess = currentStatData;

                if (isNextWeek) {
                    // Group appointments by weekday
                    dataToProcess = groupByWeekday(currentStatData);
                }

                // Add data rows
                let dataRowIndex = 0;
                if (isNextWeek && Array.isArray(dataToProcess) && dataToProcess.length > 0 && dataToProcess[0]
                    .weekday) {
                    // Process grouped data with weekday headers
                    dataToProcess.forEach((group) => {
                        // Add weekday header row
                        const weekdayRow = worksheet.addRow([
                            group.weekday, '', '', '', '', '', '', '', '', '', ''
                        ]);

                        weekdayRow.eachCell((cell) => {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: {
                                    argb: 'FF4A9B8E'
                                }
                            };
                            cell.font = {
                                bold: true,
                                color: {
                                    argb: 'FFFFFFFF'
                                },
                                size: 10
                            };
                            cell.alignment = {
                                horizontal: 'left',
                                vertical: 'center'
                            };
                        });

                        // Add patients for this weekday
                        group.patients.forEach((patient, index) => {
                            const row = worksheet.addRow([
                                `${patient.first_name || ''} ${patient.last_name || ''}`
                                .trim(),
                                patient.patient_no || '-',
                                patient.gender || '-',
                                patient.age || '-',
                                patient.phone_number || '-',
                                patient.condition || '-',
                                patient.next_appointment || '-',
                                patient.appointment_type || '-',
                                patient.viral_load_copies || '-',
                                patient.last_viral_load_date || '-',
                                patient.address || '-'
                            ]);

                            // Style data rows with alternating colors
                            const isEvenRow = index % 2 === 0;
                            row.eachCell((cell) => {
                                cell.font = {
                                    size: 10
                                };
                                cell.alignment = {
                                    horizontal: 'left',
                                    vertical: 'center'
                                };
                                cell.border = {
                                    top: {
                                        style: 'thin',
                                        color: {
                                            argb: 'FFCCCCCC'
                                        }
                                    },
                                    left: {
                                        style: 'thin',
                                        color: {
                                            argb: 'FFCCCCCC'
                                        }
                                    },
                                    bottom: {
                                        style: 'thin',
                                        color: {
                                            argb: 'FFCCCCCC'
                                        }
                                    },
                                    right: {
                                        style: 'thin',
                                        color: {
                                            argb: 'FFCCCCCC'
                                        }
                                    }
                                };

                                // Alternating row colors
                                if (isEvenRow) {
                                    cell.fill = {
                                        type: 'pattern',
                                        pattern: 'solid',
                                        fgColor: {
                                            argb: 'FFDCE6E6'
                                        }
                                    };
                                } else {
                                    cell.fill = {
                                        type: 'pattern',
                                        pattern: 'solid',
                                        fgColor: {
                                            argb: 'FFFFFFFF'
                                        }
                                    };
                                }
                            });
                        });

                        // Add summary row for the day
                        const summaryRow = worksheet.addRow([
                            `Total: ${group.patients.length} appointments`, '', '', '', '', '', '',
                            '', '', '', ''
                        ]);

                        summaryRow.eachCell((cell) => {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: {
                                    argb: 'FFE8F5F4'
                                }
                            };
                            cell.font = {
                                bold: true,
                                size: 9,
                                italic: true
                            };
                            cell.alignment = {
                                horizontal: 'right',
                                vertical: 'center'
                            };
                        });

                        // Add blank row for spacing
                        worksheet.addRow([]);
                    });
                } else {
                    // Non-grouped data (default format)
                    currentStatData.forEach((patient, index) => {
                        const row = worksheet.addRow([
                            `${patient.first_name || ''} ${patient.last_name || ''}`.trim(),
                            patient.patient_no || '-',
                            patient.gender || '-',
                            patient.age || '-',
                            patient.phone_number || '-',
                            patient.condition || '-',
                            patient.next_appointment || '-',
                            patient.appointment_type || '-',
                            patient.viral_load_copies || '-',
                            patient.last_viral_load_date || '-',
                            patient.address || '-'
                        ]);

                        // Style data rows with alternating colors
                        const isEvenRow = index % 2 === 0;
                        row.eachCell((cell) => {
                            cell.font = {
                                size: 10
                            };
                            cell.alignment = {
                                horizontal: 'left',
                                vertical: 'center'
                            };
                            cell.border = {
                                top: {
                                    style: 'thin',
                                    color: {
                                        argb: 'FFCCCCCC'
                                    }
                                },
                                left: {
                                    style: 'thin',
                                    color: {
                                        argb: 'FFCCCCCC'
                                    }
                                },
                                bottom: {
                                    style: 'thin',
                                    color: {
                                        argb: 'FFCCCCCC'
                                    }
                                },
                                right: {
                                    style: 'thin',
                                    color: {
                                        argb: 'FFCCCCCC'
                                    }
                                }
                            };

                            // Alternating row colors
                            if (isEvenRow) {
                                cell.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: {
                                        argb: 'FFDCE6E6'
                                    }
                                };
                            } else {
                                cell.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: {
                                        argb: 'FFFFFFFF'
                                    }
                                };
                            }
                        });
                    });
                }

                // Set column widths
                worksheet.columns = [{
                        width: 22
                    },
                    {
                        width: 14
                    },
                    {
                        width: 12
                    },
                    {
                        width: 10
                    },
                    {
                        width: 16
                    },
                    {
                        width: 18
                    },
                    {
                        width: 16
                    },
                    {
                        width: 16
                    },
                    {
                        width: 16
                    },
                    {
                        width: 16
                    },
                    {
                        width: 28
                    }
                ];

                // Generate file and save as blob
                const fileName =
                    `${titles[currentStatFilter] || 'Export'}_${new Date().toISOString().split('T')[0]}.xlsx`;
                const blob = await workbook.xlsx.writeBuffer();

                // Create download link
                const url = window.URL.createObjectURL(new Blob([blob]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', fileName);
                document.body.appendChild(link);
                link.click();
                link.parentNode.removeChild(link);
                window.URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Error exporting file: ' + error.message);
            }
        }

        // Helper function to group appointments by weekday
        function groupByWeekday(patients) {
            const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const grouped = {};

            // Group by weekday
            patients.forEach(patient => {
                if (patient.next_appointment) {
                    const date = new Date(patient.next_appointment);
                    const weekdayIndex = date.getDay();
                    const weekdayName = weekdayNames[weekdayIndex];

                    if (!grouped[weekdayIndex]) {
                        grouped[weekdayIndex] = {
                            weekday: weekdayName,
                            patients: []
                        };
                    }
                    grouped[weekdayIndex].patients.push(patient);
                }
            });

            // Sort by weekday (starting from Monday if today is not Sunday)
            const result = [];
            const today = new Date();
            const todayWeekday = today.getDay();

            // Sort by appointment date within each weekday
            Object.values(grouped).forEach(group => {
                group.patients.sort((a, b) => {
                    return new Date(a.next_appointment) - new Date(b.next_appointment);
                });
            });

            // Order groups by next occurring weekday
            for (let i = 0; i < 7; i++) {
                const index = (todayWeekday + i) % 7;
                if (grouped[index]) {
                    result.push(grouped[index]);
                }
            }

            return result;
        }

        // Export stat data to PDF
        function exportStatToPdf() {
            const titles = {
                'all-appointments': 'All Appointments',
                'next-week': 'Next Week Appointments',
                'overdue': 'Overdue Appointments',
                'missed': 'Missed Appointments',
                'high-viral': 'High Viraemia Patients',
                'low-viral': 'Low Viraemia Patients'
            };

            if (currentStatData.length === 0) {
                alert('No data to export');
                return;
            }

            const {
                jsPDF
            } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape'
            });
            const title = titles[currentStatFilter] || 'Report';

            // Add title
            doc.setFontSize(16);
            doc.text(title, 14, 15);

            // Add export date
            doc.setFontSize(9);
            doc.text(`Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 14, 22);

            // Prepare table data
            const tableData = currentStatData.map(patient => [
                `${patient.first_name || ''} ${patient.last_name || ''}`.trim(),
                patient.patient_no || '-',
                patient.gender || '-',
                patient.age || '-',
                patient.phone_number || '-',
                patient.condition || '-',
                patient.next_appointment || '-',
                patient.appointment_type || '-',
                patient.viral_load_copies || '-',
                patient.last_viral_load_date || '-',
                patient.address || '-'
            ]);

            // Create table
            const columns = [
                'Patient Name',
                'Patient ID',
                'Gender',
                'Age',
                'Phone',
                'Primary Condition',
                'Next Appt',
                'Appt Type',
                'VL Copies',
                'Last VL Date',
                'Address'
            ];

            doc.autoTable({
                head: [columns],
                body: tableData,
                startY: 28,
                styles: {
                    fontSize: 8,
                    cellPadding: 3,
                    overflow: 'linebreak'
                },
                columnStyles: {
                    0: {
                        cellWidth: 18
                    },
                    1: {
                        cellWidth: 12
                    },
                    2: {
                        cellWidth: 10
                    },
                    3: {
                        cellWidth: 8
                    },
                    4: {
                        cellWidth: 14
                    },
                    5: {
                        cellWidth: 14
                    },
                    6: {
                        cellWidth: 12
                    },
                    7: {
                        cellWidth: 12
                    },
                    8: {
                        cellWidth: 12
                    },
                    9: {
                        cellWidth: 12
                    },
                    10: {
                        cellWidth: 18
                    }
                },
                headStyles: {
                    fillColor: [21, 105, 107],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 8
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                margin: {
                    top: 28
                }
            });

            // Save PDF
            const fileName = `${title}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // Open stat detail modal
        async function openStatDetail(statType, element) {
            currentStatFilter = statType;
            const modalTitle = document.getElementById('statDetailModalLabel');
            const contentDiv = document.getElementById('statDetailContent');

            // Update modal title based on stat type
            const titles = {
                'all-appointments': 'All Appointments',
                'next-week': 'Next Week Appointments',
                'overdue': 'Overdue Appointments',
                'missed': 'Missed Appointments',
                'high-viral': 'High Viraemia Patients',
                'low-viral': 'Low Viraemia Patients',
                'hypertension': 'Hypertension Patients',
                'diabetes': 'Diabetes Patients'
            };

            modalTitle.textContent = titles[statType] || 'Details';
            contentDiv.innerHTML =
                '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // Fetch and display data
            const sessionData = localStorage.getItem('userSession');
            const session = JSON.parse(sessionData);
            const numericFacilityId = session.fid || session.facility_id || session.facilityId;

            console.log('Opening stat detail for:', statType, 'Facility ID:', numericFacilityId);

            try {
                let patients = [];
                const selectFields =
                    'pid, patient_no, first_name, last_name, gender, age, phone_number, condition, next_appointment, appointment_type, viral_load_copies, last_viral_load_date, address';

                if (statType === 'all-appointments') {
                    const {
                        data,
                        error
                    } = await supabaseClient
                        .from('patients')
                        .select(selectFields)
                        .eq('fid', numericFacilityId)
                        .not('art_start_date', 'is', null);
                    console.log('All appointments:', data, error);
                    patients = data || [];
                } else if (statType === 'next-week') {
                    const nextMonday = new Date();
                    nextMonday.setDate(nextMonday.getDate() + (1 - nextMonday.getDay()));
                    const nextSunday = new Date(nextMonday);
                    nextSunday.setDate(nextSunday.getDate() + 6);

                    const {
                        data,
                        error
                    } = await supabaseClient
                        .from('patients')
                        .select(selectFields)
                        .eq('fid', numericFacilityId)
                        .gte('next_appointment', nextMonday.toISOString().split('T')[0])
                        .lte('next_appointment', nextSunday.toISOString().split('T')[0]);
                    console.log('Next week:', data, error);
                    patients = data || [];
                } else if (statType === 'overdue') {
                    const today = new Date().toISOString().split('T')[0];
                    const {
                        data,
                        error
                    } = await supabaseClient
                        .from('patients')
                        .select(selectFields)
                        .eq('fid', numericFacilityId)
                        .lt('next_appointment', today)
                        .not('next_appointment', 'is', null);
                    console.log('Overdue:', data, error);
                    patients = data || [];
                } else if (statType === 'missed') {
                    const today = new Date().toISOString().split('T')[0];
                    const {
                        data,
                        error
                    } = await supabaseClient
                        .from('patients')
                        .select(selectFields)
                        .eq('fid', numericFacilityId)
                        .not('next_appointment', 'is', null)
                        .lt('next_appointment', today)
                        .neq('status', 'Completed');
                    console.log('Missed:', data, error);
                    patients = data || [];
                } else if (statType === 'high-viral') {
                    const {
                        data,
                        error
                    } = await supabaseClient
                        .from('patients')
                        .select(selectFields)
                        .eq('fid', numericFacilityId)
                        .gte('viral_load_copies', 1000);
                    console.log('High viral:', data, error);
                    patients = data || [];
                } else if (statType === 'low-viral') {
                    const {
                        data,
                        error
                    } = await supabaseClient
                        .from('patients')
                        .select(selectFields)
                        .eq('fid', numericFacilityId)
                        .gte('viral_load_copies', 201)
                        .lte('viral_load_copies', 999);
                    console.log('Low viral:', data, error);
                    patients = data || [];
                } else if (statType === 'hypertension') {
                    const {
                        data,
                        error
                    } = await supabaseClient
                        .from('patients')
                        .select(selectFields)
                        .eq('fid', numericFacilityId)
                        .eq('condition', 'Hypertension');
                    console.log('Hypertension:', data, error);
                    patients = data || [];
                } else if (statType === 'diabetes') {
                    const {
                        data,
                        error
                    } = await supabaseClient
                        .from('patients')
                        .select(selectFields)
                        .eq('fid', numericFacilityId)
                        .eq('condition', 'Diabetes');
                    console.log('Diabetes:', data, error);
                    patients = data || [];
                }

                // Store data for export
                currentStatData = patients;

                // Display patients in modal with pagination
                if (patients.length === 0) {
                    contentDiv.innerHTML = '<p class="text-center text-muted py-4">No patients found</p>';
                    return;
                }

                // Pagination settings
                const itemsPerPage = 10;
                const totalPages = Math.ceil(patients.length / itemsPerPage);
                let currentPage = 1;

                // Function to render table for current page
                function renderPage(page) {
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = Math.min(startIndex + itemsPerPage, patients.length);
                    const pagePatients = patients.slice(startIndex, endIndex);

                    let html = `<div class="table-responsive">
              <table class="table table-hover table-sm mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Patient Name</th>
                    <th>Gender</th>
                    <th>Age</th>
                    <th>Phone Number</th>
                    <th>Condition</th>
                    <th>Next Appointment</th>
                    <th>Appt Type</th>
                    <th>Viral Load</th>
                    <th>Last VL Date</th>
                    <th>Address</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>`;

                    pagePatients.forEach(patient => {
                        const name = `${patient.first_name || ''} ${patient.last_name || ''}`.trim();
                        html += `<tr>
                <td>${name}</td>
                <td>${patient.gender || '-'}</td>
                <td>${patient.age || '-'}</td>
                <td>${patient.phone_number || '-'}</td>
                <td>${patient.condition || '-'}</td>
                <td>${patient.next_appointment || '-'}</td>
                <td>${patient.appointment_type || '-'}</td>
                <td>${patient.viral_load_copies || '-'}</td>
                <td>${patient.last_viral_load_date || '-'}</td>
                <td>${patient.address || '-'}</td>
                <td><button class="btn btn-sm btn-outline-primary" onclick="viewPatientDetails('${patient.pid}')">View</button></td>
              </tr>`;
                    });

                    html += `</tbody></table></div>`;

                    // Add pagination controls
                    if (totalPages > 1) {
                        html += `<div class="d-flex justify-content-center mt-3 mb-2">
                <nav aria-label="Pagination">
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item ${page === 1 ? 'disabled' : ''}">
                      <button class="page-link" onclick="updateModalPage(1)" ${page === 1 ? 'disabled' : ''}>First</button>
                    </li>
                    <li class="page-item ${page === 1 ? 'disabled' : ''}">
                      <button class="page-link" onclick="updateModalPage(${page - 1})" ${page === 1 ? 'disabled' : ''}>Previous</button>
                    </li>`;

                        // Show page numbers (show max 5 page numbers)
                        let startPage = Math.max(1, page - 2);
                        let endPage = Math.min(totalPages, page + 2);

                        for (let p = startPage; p <= endPage; p++) {
                            html += `<li class="page-item ${p === page ? 'active' : ''}">
                  <button class="page-link" onclick="updateModalPage(${p})">${p}</button>
                </li>`;
                        }

                        html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                <button class="page-link" onclick="updateModalPage(${page + 1})" ${page === totalPages ? 'disabled' : ''}>Next</button>
              </li>
              <li class="page-item ${page === totalPages ? 'disabled' : ''}">
                <button class="page-link" onclick="updateModalPage(${totalPages})" ${page === totalPages ? 'disabled' : ''}>Last</button>
              </li>
            </ul>
          </nav>
        </div>
        <div class="text-center text-muted small">
          Showing ${startIndex + 1}-${endIndex} of ${patients.length} records (Page ${page} of ${totalPages})
        </div>`;
                    }

                    return html;
                }

                // Store pagination state globally
                window.statModalData = {
                    patients,
                    itemsPerPage,
                    totalPages,
                    statType,
                    contentDiv
                };

                window.updateModalPage = function (page) {
                    if (page < 1 || page > window.statModalData.totalPages) return;
                    const html = renderPage(page);
                    window.statModalData.contentDiv.innerHTML = html;
                };

                contentDiv.innerHTML = renderPage(currentPage);
            } catch (error) {
                console.error('Error loading stat details:', error);
                contentDiv.innerHTML = '<p class="text-center text-danger">Error loading data</p>';
            }
        }

        // View all patients from stat in main table
        function viewAllInTable() {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('statDetailModal'));
            modal.hide();

            // Filter patients based on current stat filter
            if (currentStatFilter) {
                filterPatients('stat-type', currentStatFilter);
            }
        }

        // ===== USER MANAGEMENT FUNCTIONS =====

        // Open user management modal
        function openUserManagementModal() {
            const modal = new bootstrap.Modal(document.getElementById('userManagementModal'));
            loadUsers();
            modal.show();
        }

        // Load and display users
        async function loadUsers() {
            try {
                const usersTableBody = document.getElementById('usersTableBody');
                usersTableBody.innerHTML =
                    '<tr><td colspan="7" class="text-center text-muted py-4"><i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> Loading users...</td></tr>';

                // Get facility ID from session
                const session = JSON.parse(localStorage.getItem('userSession'));
                const facilityId = session?.fid || null;

                if (!facilityId) {
                    usersTableBody.innerHTML =
                        '<tr><td colspan="7" class="text-center text-danger">Error: Facility ID not found</td></tr>';
                    return;
                }

                const {
                    data: users,
                    error
                } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('fid', facilityId)
                    .order('created_at', {
                        ascending: false
                    });

                if (error) {
                    console.error('Error fetching users:', error);
                    usersTableBody.innerHTML =
                        '<tr><td colspan="7" class="text-center text-danger">Error loading users</td></tr>';
                    return;
                }

                if (!users || users.length === 0) {
                    usersTableBody.innerHTML =
                        '<tr><td colspan="7" class="text-center text-muted">No users found</td></tr>';
                    return;
                }

                usersTableBody.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    const userRole = user.user_role || 'User';
                    const statusBadge = user.is_active ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>';

                    const createdDate = new Date(user.created_at).toLocaleDateString();

                    row.innerHTML = `
              <td>${user.fullname || 'N/A'}</td>
              <td>${user.email || 'N/A'}</td>
              <td>${user.username || 'N/A'}</td>
              <td>${userRole}</td>
              <td>${statusBadge}</td>
              <td>${createdDate}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editUserAccount('${user.uid}')" title="Edit">
                  <i class="ri-edit-line"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteUserAccount('${user.uid}')" title="Delete">
                  <i class="ri-delete-bin-line"></i>
                </button>
              </td>
            `;
                    usersTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Open create user modal
        function openCreateUserModal() {
            const form = document.getElementById('createUserForm');
            if (form) {
                form.reset();
            }
            // Load patients when modal opens
            loadPatientsForSelection();
            const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
            modal.show();
        }

        // Handle role selection change
        function handleRoleChange() {
            const role = document.getElementById('newUserRole').value;
            const patientSelectionGroup = document.getElementById('patientSelectionGroup');
            const newUserPatient = document.getElementById('newUserPatient');

            if (role === 'patient') {
                patientSelectionGroup.style.display = 'block';
                newUserPatient.setAttribute('required', 'required');
            } else {
                patientSelectionGroup.style.display = 'none';
                newUserPatient.removeAttribute('required');
                newUserPatient.value = '';
            }
        }

        // Store patients data globally for easy access
        let patientsDataMap = {};

        // Load patients from database for selection
        async function loadPatientsForSelection() {
            try {
                const patientSelect = document.getElementById('newUserPatient');
                const session = JSON.parse(localStorage.getItem('userSession'));
                const facilityId = session?.fid;

                const { data: patients, error } = await supabaseClient
                    .from('patients')
                    .select('pid, patient_no, health_worker_name, first_name, last_name, age, phone_number, email')
                    .eq('fid', facilityId)
                    .order('health_worker_name', { ascending: true });

                if (error) {
                    console.error('Error loading patients:', error);
                    return;
                }

                // Clear existing options and map
                patientSelect.innerHTML = '<option value="">Search and select a patient...</option>';
                patientsDataMap = {};

                if (patients && patients.length > 0) {
                    patients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({ pid: patient.pid, patient_no: patient.patient_no });
                        option.textContent = `${patient.patient_no} - ${patient.health_worker_name} (Age: ${patient.age}) - ${patient.phone_number || 'N/A'}`;
                        patientSelect.appendChild(option);
                        
                        // Store patient data for quick access
                        patientsDataMap[patient.pid] = patient;
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.disabled = true;
                    option.textContent = 'No patients found in your facility';
                    patientSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error in loadPatientsForSelection:', error);
            }
        }

        // Handle patient selection and auto-populate fields
        function handlePatientSelection() {
            const patientSelect = document.getElementById('newUserPatient');
            const selectedValue = patientSelect.value;

            if (!selectedValue) {
                // Clear fields if no patient selected
                document.getElementById('newUserFullname').value = '';
                document.getElementById('newUserEmail').value = '';
                return;
            }

            try {
                const patientData = JSON.parse(selectedValue);
                const patient = patientsDataMap[patientData.pid];

                if (patient) {
                    // Auto-populate Full Name field using only first and last name
                    const fullName = `${patient.first_name || ''} ${patient.last_name || ''}`.trim();
                    document.getElementById('newUserFullname').value = fullName;

                    // Auto-populate Email field
                    if (patient.email) {
                        document.getElementById('newUserEmail').value = patient.email;
                    } else {
                        document.getElementById('newUserEmail').value = '';
                    }

                    // Auto-generate username based on the populated full name
                    generateUsernameFromFullname(fullName);
                }
            } catch (err) {
                console.error('Error processing patient selection:', err);
            }
        }

        // Generate username from fullname
        function generateUsernameFromFullname(fullname) {
            const usernameInput = document.getElementById('newUserUsername');
            if (!usernameInput) return;

            if (!fullname.trim()) {
                usernameInput.value = '';
                return;
            }

            const names = fullname.trim().split(/\s+/);
            const firstName = names[0].toLowerCase().replace(/[^a-z0-9]/g, '');
            const lastName = names.length > 1 ? names[names.length - 1].substring(0, 3).toLowerCase().replace(
                /[^a-z0-9]/g, '') : '';
            const randomNum = Math.floor(Math.random() * 1000);

            usernameInput.value = `@${firstName}${lastName}${randomNum}`.substring(0, 20);
        }

        // Auto-generate username on fullname input
        document.addEventListener('DOMContentLoaded', function () {
            const fullnameInput = document.getElementById('newUserFullname');
            if (fullnameInput) {
                fullnameInput.addEventListener('input', function () {
                    generateUsernameFromFullname(this.value);
                });
            }
        });

        // Handle create user submission
        async function handleCreateUser(e) {
            e.preventDefault();

            const fullname = document.getElementById('newUserFullname').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('newUserConfirmPassword').value;
            const role = document.getElementById('newUserRole').value;
            const patientSelection = document.getElementById('newUserPatient').value;
            const messageDiv = document.getElementById('createUserMessage');

            if (!fullname || !email || !username || !password || !confirmPassword || !role) {
                showUserMessage(messageDiv, 'All fields are required', 'danger');
                return;
            }

            // Validate patient selection for patient role
            if (role === 'patient' && !patientSelection) {
                showUserMessage(messageDiv, 'Please select a patient', 'danger');
                return;
            }

            if (!isValidEmail(email)) {
                showUserMessage(messageDiv, 'Invalid email format', 'danger');
                return;
            }

            if (password !== confirmPassword) {
                showUserMessage(messageDiv, 'Passwords do not match', 'danger');
                return;
            }

            if (!validatePassword(password)) {
                showUserMessage(messageDiv,
                    'Password must be at least 8 characters with uppercase, lowercase, and numbers', 'danger');
                return;
            }

            // Parse patient data if patient role selected
            let patientData = { pid: null, patient_no: null };
            if (role === 'patient' && patientSelection) {
                try {
                    patientData = JSON.parse(patientSelection);
                } catch (err) {
                    showUserMessage(messageDiv, 'Error processing patient selection', 'danger');
                    return;
                }
            }

            await submitCreateUser({
                fullname,
                email,
                username,
                password,
                user_role: role,
                pid: patientData.pid,
                patient_no: patientData.patient_no,
                is_active: true
            }, messageDiv);
        }

        // Submit create user
        async function submitCreateUser(userData, messageDiv) {
            try {
                const submitBtn = document.getElementById('submitCreateUserBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML =
                    '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> Creating...';

                const {
                    data: existingEmail
                } = await supabaseClient
                    .from('users')
                    .select('email')
                    .eq('email', userData.email)
                    .single();

                if (existingEmail) {
                    showUserMessage(messageDiv, 'Email already registered', 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }

                const session = JSON.parse(localStorage.getItem('userSession'));
                const facilityId = session?.fid;

                if (!facilityId) {
                    showUserMessage(messageDiv, 'Error: Facility ID not found in session. Please log in again.', 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }

                const userInsertData = {
                    fullname: userData.fullname,
                    email: userData.email,
                    username: userData.username,
                    password: userData.password,
                    user_role: userData.user_role,
                    fid: facilityId,
                    is_active: userData.is_active,
                    created_at: new Date().toISOString()
                };

                // Add pid if provided (for patient users)
                if (userData.pid) {
                    userInsertData.pid = userData.pid;
                }

                const {
                    error: insertError
                } = await supabaseClient
                    .from('users')
                    .insert([userInsertData]);

                if (insertError) {
                    console.error('Insert error:', insertError);
                    showUserMessage(messageDiv, `Error: ${insertError.message}`, 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }

                showUserMessage(messageDiv, 'User created successfully!', 'success');

                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                    modal.hide();
                    loadUsers();
                }, 1500);

                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            } catch (error) {
                console.error('Error creating user:', error);
                showUserMessage(messageDiv, `Error: ${error.message}`, 'danger');

                const submitBtn = document.getElementById('submitCreateUserBtn');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Create User';
            }
        }

        // Edit user account
        async function editUserAccount(userId) {
            try {
                const {
                    data: user,
                    error
                } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('uid', userId)
                    .single();

                if (error || !user) {
                    Swal.fire('Error', 'Could not load user details', 'error');
                    return;
                }

                // Hide the backdrop of User Management modal while SweetAlert2 is shown
                const {
                    value: formValues
                } = await Swal.fire({
                    title: 'Edit User',
                    html: `
              <div style="text-align: left; width: 100%; pointer-events: auto;">
                <div style="margin-bottom: 1rem; pointer-events: auto;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Full Name</label>
                  <input type="text" id="editFullname" value="${user.fullname || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px;" />
                </div>
                <div style="margin-bottom: 1rem; pointer-events: auto;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Email</label>
                  <input type="email" id="editEmail" value="${user.email || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px;" />
                </div>
                <div style="margin-bottom: 1rem; pointer-events: auto;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Role</label>
                  <select id="editRole" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px;">
                    <option value="Admin" ${user.user_role === 'Admin' ? 'selected' : ''}>Admin</option>
                    <option value="Manager" ${user.user_role === 'Manager' ? 'selected' : ''}>Manager</option>
                    <option value="Staff" ${user.user_role === 'Staff' ? 'selected' : ''}>Staff</option>
                    <option value="User" ${user.user_role === 'User' ? 'selected' : ''}>User</option>
                  </select>
                </div>
                <div style="margin-bottom: 1rem; pointer-events: auto;">
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="editActive" ${user.is_active ? 'checked' : ''} style="margin-right: 0.5rem; cursor: pointer; width: 18px; height: 18px;" />
                    <span>Active Account</span>
                  </label>
                </div>
              </div>
            `,
                    confirmButtonText: 'Update',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    focusConfirm: false,
                    willOpen: () => {
                        // Try to remove SweetAlert's keyboard handling before it attaches
                        console.log('willOpen - attempting to prevent keyboard capture');
                    },
                    didOpen: (modal) => {
                        console.log('Edit modal opened');

                        // Remove SweetAlert's keyboard event listeners by replacing them
                        window.removeEventListener = new Proxy(window.removeEventListener, {
                            apply: (target, thisArg, args) => {
                                if (args[0]?.includes('key')) {
                                    console.log(
                                        'Blocked SweetAlert keyboard removal prevention'
                                        );
                                    return;
                                }
                                return Reflect.apply(target, thisArg, args);
                            }
                        });

                        // Listen to ALL keyboard events at document level with CAPTURE phase (highest priority)
                        const globalKeyHandler = (e) => {
                            // Only log, don't preventDefault - let normal flow continue
                            if (e.target.matches('input, select, textarea')) {
                                console.log('Keyboard event on form element:', e.type, e.target.id,
                                    'key:', e.key);
                            }
                        };

                        // Remove any existing handlers first
                        document.removeEventListener('keydown', globalKeyHandler, true);
                        document.removeEventListener('keypress', globalKeyHandler, true);
                        document.removeEventListener('keyup', globalKeyHandler, true);

                        // Re-add with capture phase
                        document.addEventListener('keydown', globalKeyHandler, true);
                        document.addEventListener('keypress', globalKeyHandler, true);
                        document.addEventListener('keyup', globalKeyHandler, true);
                        console.log('Added global keyboard handlers with capture phase');

                        // Hide User Management modal backdrop
                        const backdrop = document.querySelector(
                            '#userManagementModal + .modal-backdrop');
                        if (backdrop) backdrop.style.display = 'none';

                        // Get all form elements
                        const fullnameInput = document.getElementById('editFullname');
                        const emailInput = document.getElementById('editEmail');
                        const roleSelect = document.getElementById('editRole');
                        const activeCheckbox = document.getElementById('editActive');

                        console.log('Form elements:', {
                            fullnameInput,
                            emailInput,
                            roleSelect,
                            activeCheckbox
                        });

                        // Enable all inputs explicitly with multiple methods
                        const inputs = [fullnameInput, emailInput, roleSelect, activeCheckbox];
                        inputs.forEach(input => {
                            if (input) {
                                input.style.pointerEvents = 'auto';
                                input.style.visibility = 'visible';
                                input.style.opacity = '1';
                                input.style.cursor = input.type === 'checkbox' ? 'pointer' :
                                    'text';
                                input.disabled = false;
                                input.readOnly = false;

                                console.log('Input setup:', input.id, 'disabled:', input
                                    .disabled, 'readOnly:', input.readOnly);

                                // Add direct click handler
                                input.addEventListener('mousedown', function (e) {
                                    e.stopPropagation();
                                    console.log('Input mousedown:', input.id);
                                });

                                input.addEventListener('click', function (e) {
                                    e.stopPropagation();
                                    console.log('Input click:', input.id);
                                });

                                // Add keyboard event handlers - these MUST use capture phase
                                input.addEventListener('keydown', function (e) {
                                    console.log('Input keydown (capture):', input.id, e
                                        .key);
                                }, true);

                                input.addEventListener('keypress', function (e) {
                                    console.log('Input keypress (capture):', input.id, e
                                        .key);
                                }, true);

                                input.addEventListener('keyup', function (e) {
                                    console.log('Input keyup (capture):', input.id, e
                                        .key);
                                }, true);

                                input.addEventListener('input', function (e) {
                                    console.log('Input event on:', input.id, 'value:',
                                        this.value);
                                }, true);
                            }
                        });

                        // Add click delegation to the entire html container
                        const htmlContainer = document.querySelector('.swal2-html-container');
                        if (htmlContainer) {
                            htmlContainer.addEventListener('click', function (e) {
                                console.log('Container click detected on:', e.target.id || e
                                    .target.tagName);
                                // Don't prevent default - let the input handle the click naturally

                                // If clicking on an input, focus it
                                if (e.target.matches('input, select, textarea')) {
                                    console.log('Focusing input after click');
                                    e.target.focus();
                                    // Only call select() on text inputs
                                    if (e.target.tagName === 'INPUT' && e.target.type !==
                                        'checkbox' && e.target.type !== 'radio') {
                                        try {
                                            e.target.select();
                                        } catch (err) {
                                            console.log('Could not select input');
                                        }
                                    }
                                }
                            }, true); // Use capture phase

                            // Also handle mousedown
                            htmlContainer.addEventListener('mousedown', function (e) {
                                if (e.target.matches('input, select, textarea')) {
                                    console.log('Container mousedown on:', e.target.id);
                                    // Don't prevent default
                                    e.target.focus();
                                }
                            }, true);
                        }

                        // Add global keyboard handler to the modal popup itself
                        const swalPopup = document.querySelector('.swal2-popup');
                        if (swalPopup) {
                            swalPopup.addEventListener('keydown', function (e) {
                                console.log('Swal popup keydown:', e.key, 'target:', e.target
                                    .id);
                                // Allow keyboard events on inputs
                                if (e.target.matches('input, select, textarea')) {
                                    console.log('Allowing keyboard event on input');
                                }
                            }, false);
                        }

                        // Also prevent SweetAlert from capturing keyboard
                        Swal.getActions = function () {
                            const actions = document.querySelector('.swal2-actions');
                            return actions;
                        };

                        // Focus on first input
                        setTimeout(() => {
                            if (fullnameInput) {
                                console.log('Focusing fullname input');
                                fullnameInput.style.pointerEvents = 'auto';
                                fullnameInput.focus();
                                // Try to select all text
                                fullnameInput.select();
                            }
                        }, 100);
                    },
                    willClose: () => {
                        // Show User Management modal backdrop again
                        const backdrop = document.querySelector(
                            '#userManagementModal + .modal-backdrop');
                        if (backdrop) backdrop.style.display = 'block';
                    },
                    preConfirm: (modal) => {
                        const fullnameInput = document.getElementById('editFullname');
                        const emailInput = document.getElementById('editEmail');
                        const roleInput = document.getElementById('editRole');
                        const activeInput = document.getElementById('editActive');

                        if (!fullnameInput || !emailInput) {
                            Swal.showValidationMessage('Form elements not found');
                            return false;
                        }

                        const fullname = fullnameInput.value.trim();
                        const email = emailInput.value.trim();

                        if (!fullname) {
                            Swal.showValidationMessage('Full name is required');
                            return false;
                        }

                        if (!email) {
                            Swal.showValidationMessage('Email is required');
                            return false;
                        }

                        return {
                            fullname: fullname,
                            email: email,
                            user_role: roleInput.value,
                            is_active: activeInput.checked
                        };
                    }
                });

                if (formValues) {
                    const {
                        error: updateError
                    } = await supabaseClient
                        .from('users')
                        .update({
                            fullname: formValues.fullname,
                            email: formValues.email,
                            user_role: formValues.user_role,
                            is_active: formValues.is_active,
                            updated_at: new Date().toISOString()
                        })
                        .eq('uid', userId);

                    if (updateError) {
                        Swal.fire('Error', updateError.message, 'error');
                        return;
                    }

                    Swal.fire('Success', 'User updated successfully', 'success');
                    loadUsers();
                }
            } catch (error) {
                console.error('Error editing user:', error);
                Swal.fire('Error', error.message, 'error');
            }
        }

        // Delete user account
        async function deleteUserAccount(userId) {
            try {
                const {
                    isConfirmed
                } = await Swal.fire({
                    title: 'Delete User?',
                    text: 'This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    confirmButtonText: 'Delete'
                });

                if (!isConfirmed) return;

                const {
                    error
                } = await supabaseClient
                    .from('users')
                    .delete()
                    .eq('uid', userId);

                if (error) {
                    Swal.fire('Error', error.message, 'error');
                    return;
                }

                Swal.fire('Deleted', 'User has been deleted', 'success');
                loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                Swal.fire('Error', error.message, 'error');
            }
        }

        // Validate email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Validate password
        function validatePassword(password) {
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const isLongEnough = password.length >= 8;

            return hasUpperCase && hasLowerCase && hasNumbers && isLongEnough;
        }

        // Show message
        function showUserMessage(messageDiv, message, type) {
            messageDiv.className = `alert alert-${type} alert-dismissible fade show`;
            messageDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
            messageDiv.style.display = 'block';
        }

        // Make functions globally accessible
        window.viewPatientDetails = viewPatientDetails;
        window.displayPatientMedicalHistory = displayPatientMedicalHistory;
        window.displayPatientAppointments = displayPatientAppointments;
        window.displayPatientClinicalNotes = displayPatientClinicalNotes;
        window.editAppointment = editAppointment;
        window.openStatDetail = openStatDetail;
        window.viewAllInTable = viewAllInTable;
        window.exportStatToExcel = exportStatToExcel;
        window.exportStatToPdf = exportStatToPdf;
        window.openUserManagementModal = openUserManagementModal;
        window.openCreateUserModal = openCreateUserModal;
        window.loadUsers = loadUsers;
        window.editUserAccount = editUserAccount;
        window.deleteUserAccount = deleteUserAccount;
        window.handleCreateUser = handleCreateUser;
        window.generateUsernameFromFullname = generateUsernameFromFullname;
        window.handleRoleChange = handleRoleChange;
        window.loadPatientsForSelection = loadPatientsForSelection;
        window.handlePatientSelection = handlePatientSelection;
    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <!-- Chatbot -->
    <script src="assets/js/chatbot-advanced-features.js"></script>
    <script src="assets/js/chatbot-ai.js"></script>
    <script src="assets/js/chatbot-ui.js"></script>

    <!-- Floating Chat Button -->
    <style>
        .chat-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #15696B;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(21, 105, 107, 0.4);
            transition: all 0.3s ease;
            z-index: 998;
        }

        .chat-fab:hover {
            background: #0F4449;
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 6px 16px rgba(21, 105, 107, 0.6);
        }

        .chat-fab:active {
            transform: scale(0.95);
        }

        .chat-fab-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #d32f2f;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            border: 2px solid white;
        }

        @keyframes pulse-fab {
            0% {
                box-shadow: 0 0 0 0 rgba(21, 105, 107, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(21, 105, 107, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(21, 105, 107, 0);
            }
        }

        .chat-fab.has-unread {
            animation: pulse-fab 2s infinite;
        }

        @media (max-width: 768px) {
            .chat-fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                font-size: 1.3rem;
            }
        }

        @media (max-width: 576px) {
            .chat-fab {
                bottom: 15px;
                right: 15px;
                width: 52px;
                height: 52px;
                font-size: 1.2rem;
            }
        }
    </style>

    <!-- Appointment Notification Settings Modal -->
    <div class="modal fade" id="appointmentNotificationModal" tabindex="-1" aria-labelledby="appointmentNotificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-2 text-white">
                    <h5 class="modal-title" id="appointmentNotificationModalLabel">
                        <i class="ri-notification-2-line me-2"></i>Appointment Notifications
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="text-secondary mb-3">Notification Channels</h6>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableBrowserNotifications" checked>
                            <label class="form-check-label" for="enableBrowserNotifications">
                                <strong>Browser Notifications</strong>
                                <small class="d-block text-muted">Push notifications on your device</small>
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableInAppNotifications" checked>
                            <label class="form-check-label" for="enableInAppNotifications">
                                <strong>In-App Notifications</strong>
                                <small class="d-block text-muted">Toast alerts within the dashboard</small>
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableSoundAlerts" checked>
                            <label class="form-check-label" for="enableSoundAlerts">
                                <strong>Sound Alerts</strong>
                                <small class="d-block text-muted">Audio notification on appointments</small>
                            </label>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-4">
                        <h6 class="text-secondary mb-3">Notification Types</h6>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notifyMissed" checked>
                            <label class="form-check-label" for="notifyMissed">
                                <strong>Missed Appointments</strong>
                                <small class="d-block text-muted">Alert 1 day after appointment time if not completed</small>
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notifyDue1day" checked>
                            <label class="form-check-label" for="notifyDue1day">
                                <strong>Due in 1 Day</strong>
                                <small class="d-block text-muted">Reminder 1 day before appointment scheduled time</small>
                            </label>
                        </div>
                    </div>

                    <hr>

                    <div>
                        <h6 class="text-secondary mb-3">Recent Notifications</h6>
                        <div id="notificationHistory" style="max-height: 200px; overflow-y: auto;">
                            <p class="text-muted text-center py-3">No recent notifications</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="clearNotificationsBtn">Clear History</button>
                    <button type="button" class="btn btn-primary" id="saveNotificationsBtn">Save Preferences</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB Button Container -->
    <div class="fab-container" id="fabContainer">
        <ul class="fab-menu">
            <li class="fab-menu-item">
                <button type="button" class="import-btn" id="fabImportBtn" title="Import Patient Data"
                    style="font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center;">
                    <span class="fab-tooltip">Import Data</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" style="width: 20px; height: 20px; fill: currentColor;">
                        <path d="M176 544C96.5 544 32 479.5 32 400C32 336.6 73 282.8 129.9 263.5C128.6 255.8 128 248 128 240C128 160.5 192.5 96 272 96C327.4 96 375.5 127.3 399.6 173.1C413.8 164.8 430.4 160 448 160C501 160 544 203 544 256C544 271.7 540.2 286.6 533.5 299.7C577.5 320 608 364.4 608 416C608 486.7 550.7 544 480 544L176 544zM337 255C327.6 245.6 312.4 245.6 303.1 255L231.1 327C221.7 336.4 221.7 351.6 231.1 360.9C240.5 370.2 255.7 370.3 265 360.9L296 329.9L296 432C296 445.3 306.7 456 320 456C333.3 456 344 445.3 344 432L344 329.9L375 360.9C384.4 370.3 399.6 370.3 408.9 360.9C418.2 351.5 418.3 336.3 408.9 327L336.9 255z"/>
                    </svg>
                </button>
            </li>
            <li class="fab-menu-item">
                <button type="button" class="chat-btn" id="fabChatBtn" title="Open Chat" style="font-size: 20px; display: flex; align-items: center; justify-content: center;">
                    <span class="fab-tooltip">Chat Messages</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" style="width: 20px; height: 20px; fill: currentColor;">
                        <path d="M108.2 322.7C114.3 307.5 112.2 290.1 102.6 276.8C88.1 256.7 80 233.1 80 208C80 141.2 140.5 80 224 80C307.5 80 368 141.2 368 208C368 274.8 307.5 336 224 336C208.1 336 192.9 333.7 178.7 329.5C168.4 326.4 157.3 327 147.3 331L96.9 351.2L108.3 322.7zM32 208C32 243.8 43.6 277.1 63.7 304.8L33.9 379.2C32.6 382.4 32 385.8 32 389.2C32 404 44 416 58.8 416C62.2 416 65.6 415.3 68.8 414.1L165.1 375.6C183.7 381.1 203.5 384 224 384C330 384 416 305.2 416 208C416 110.8 330 32 224 32C118 32 32 110.8 32 208zM416 576C436.6 576 456.3 573 474.9 567.6L571.2 606.1C574.4 607.4 577.8 608 581.2 608C596 608 608 596 608 581.2C608 577.8 607.3 574.4 606.1 571.2L576.4 496.8C596.4 469 608.1 435.7 608.1 400C608.1 317.6 546.4 248.5 463.1 229.3C461.5 245.6 458 261.2 453 276.2C516.9 291 560.2 343.5 560.2 400.1C560.2 425.2 552.1 448.8 537.6 468.9C528 482.2 525.9 499.5 532 514.8L543.4 543.3L493 523.1C483 519.1 471.9 518.6 461.6 521.6C447.4 525.8 432.2 528.1 416.3 528.1C344.1 528.1 289.2 482.4 275.6 426.9C260 430.1 243.9 431.9 227.5 432.1C243.9 514 322.2 576.1 416.3 576.1z"/>
                    </svg>
                </button>
            </li>
            <li class="fab-menu-item">
                <button type="button" class="chat-btn" id="fabChatbotBtn" title="Open AI Chatbot"
                    style="font-size: 20px; display: flex; align-items: center; justify-content: center;">
                    <span class="fab-tooltip">AI Assistant</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" style="width: 20px; height: 20px; fill: currentColor;">
                        <path d="M352 64C352 46.3 337.7 32 320 32C302.3 32 288 46.3 288 64L288 128L192 128C139 128 96 171 96 224L96 448C96 501 139 544 192 544L448 544C501 544 544 501 544 448L544 224C544 171 501 128 448 128L352 128L352 64zM160 432C160 418.7 170.7 408 184 408L216 408C229.3 408 240 418.7 240 432C240 445.3 229.3 456 216 456L184 456C170.7 456 160 445.3 160 432zM280 432C280 418.7 290.7 408 304 408L336 408C349.3 408 360 418.7 360 432C360 445.3 349.3 456 336 456L304 456C290.7 456 280 445.3 280 432zM400 432C400 418.7 410.7 408 424 408L456 408C469.3 408 480 418.7 480 432C480 445.3 469.3 456 456 456L424 456C410.7 456 400 445.3 400 432zM224 240C250.5 240 272 261.5 272 288C272 314.5 250.5 336 224 336C197.5 336 176 314.5 176 288C176 261.5 197.5 240 224 240zM368 288C368 261.5 389.5 240 416 240C442.5 240 464 261.5 464 288C464 314.5 442.5 336 416 336C389.5 336 368 314.5 368 288zM64 288C64 270.3 49.7 256 32 256C14.3 256 0 270.3 0 288L0 384C0 401.7 14.3 416 32 416C49.7 416 64 401.7 64 384L64 288zM608 256C590.3 256 576 270.3 576 288L576 384C576 401.7 590.3 416 608 416C625.7 416 640 401.7 640 384L640 288C640 270.3 625.7 256 608 256z"/>
                    </svg>
                </button>
            </li>
            <li class="fab-menu-item">
                <button type="button" class="chat-btn" id="fabNotificationBtn" title="Notification Settings"
                    style="font-size: 20px;">
                    <span class="fab-tooltip">Notifications</span>
                    
                </button>
            </li>
        </ul>
        <button type="button" class="fab-button" id="fabButton" style="font-size: 32px; font-weight: bold;">
            +
        </button>
    </div>
    <!-- FAB Button Container Ends -->

    <!-- Appointment Notification Handler Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBtn = document.getElementById('fabNotificationBtn');
            const modal = document.getElementById('appointmentNotificationModal');
            const saveBtn = document.getElementById('saveNotificationsBtn');
            const clearBtn = document.getElementById('clearNotificationsBtn');

            if (notificationBtn && modal) {
                notificationBtn.addEventListener('click', function() {
                    loadNotificationSettings();
                    const bootstrapModal = new bootstrap.Modal(modal);
                    bootstrapModal.show();
                });
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', saveNotificationSettings);
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    if (appointmentNotificationManager) {
                        appointmentNotificationManager.clearNotificationHistory();
                        loadNotificationHistory();
                        alert('Notification history cleared');
                    }
                });
            }
        });

        function loadNotificationSettings() {
            if (!appointmentNotificationManager) return;

            const prefs = appointmentNotificationManager.getNotificationPreferences();

            document.getElementById('enableBrowserNotifications').checked = prefs.enableBrowserNotifications;
            document.getElementById('enableInAppNotifications').checked = prefs.enableInAppNotifications;
            document.getElementById('enableSoundAlerts').checked = prefs.enableSoundAlerts;
            document.getElementById('notifyMissed').checked = prefs.notifyMissed;
            document.getElementById('notifyDue1day').checked = prefs.notifyDue1day;

            loadNotificationHistory();
        }

        function loadNotificationHistory() {
            if (!appointmentNotificationManager) return;

            const history = appointmentNotificationManager.getNotificationHistory();
            const historyContainer = document.getElementById('notificationHistory');

            if (history.length === 0) {
                historyContainer.innerHTML = '<p class="text-muted text-center py-3">No recent notifications</p>';
                return;
            }

            historyContainer.innerHTML = history
                .slice()
                .reverse()
                .slice(0, 10)
                .map(notif => {
                    const date = new Date(notif.timestamp);
                    const timeStr = date.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const typeColor = notif.type === 'missed' ? 'danger' : 'warning';

                    return `
                        <div class="p-2 mb-2 border-start border-${typeColor} ps-3">
                            <small class="fw-600">${notif.title}</small>
                            <div class="text-muted small">${notif.body}</div>
                            <small class="text-secondary">${timeStr}</small>
                        </div>
                    `;
                })
                .join('');
        }

        function saveNotificationSettings() {
            if (!appointmentNotificationManager) return;

            const prefs = {
                enableBrowserNotifications: document.getElementById('enableBrowserNotifications').checked,
                enableInAppNotifications: document.getElementById('enableInAppNotifications').checked,
                enableSoundAlerts: document.getElementById('enableSoundAlerts').checked,
                notifyMissed: document.getElementById('notifyMissed').checked,
                notifyDue1day: document.getElementById('notifyDue1day').checked
            };

            appointmentNotificationManager.saveNotificationPreferences(prefs);

            // Show success message
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 30px;
                background: #28a745;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                z-index: 10001;
                font-weight: 500;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = ' Preferences saved successfully';
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentNotificationModal'));
            if (modal) modal.hide();
        }
    </script>

    <!-- ChatONN Chat Application JavaScript -->
    <script>
        $(function() {
            var lastmsg = "";
            var currentContact = null;

            // Contacts data matching ChatONN design
            var contacts = [
                { id: 1, name: 'Kirti Yadov', avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400&h=400&fit=crop', lastMessage: 'I really like your vibe but i still rock we can do this in...', time: '3:21 AM', status: 'online' },
                { id: 2, name: 'Anish Melroy', avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop', lastMessage: 'Are you meeting today i can...', time: '5:44 PM', status: 'online' },
                { id: 3, name: 'Akanksha Shrivs', avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=400&fit=crop', lastMessage: 'Perfect you for this more...', time: '6:00 PM', status: 'offline' },
                { id: 4, name: 'Harshit Nagar', avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=400&fit=crop', lastMessage: 'i had night party 30x conveniently', time: '1:18 PM', status: 'offline' },
                { id: 5, name: 'Ashish Singh', avatar: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=400&fit=crop', lastMessage: 'lets i meet you today. Call me...', time: '8:12 AM', status: 'offline' },
                { id: 6, name: 'Dr. Sarah Okoro', avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=400&fit=crop', lastMessage: 'Patient follow-up completed for today', time: '2:45 PM', status: 'online' },
                { id: 7, name: 'James Mwale', avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop', lastMessage: 'Thanks for the appointment reminder', time: '4:12 PM', status: 'online' },
                { id: 8, name: 'Grace Nakato', avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400&h=400&fit=crop', lastMessage: 'Can I schedule an appointment for next week?', time: 'Yesterday', status: 'offline' },
                { id: 9, name: 'Medical Team', avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=400&fit=crop', lastMessage: 'Next team meeting is tomorrow at 2 PM', time: '3:12 PM', status: 'online' },
                { id: 10, name: 'David Luwum', avatar: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=400&fit=crop', lastMessage: 'UI design mockups ready for review', time: '11:30 AM', status: 'online' },
                { id: 11, name: 'Dr. Peter Otieno', avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=400&fit=crop', lastMessage: 'Mobile field data collection setup complete', time: '9:15 AM', status: 'offline' },
                { id: 12, name: 'Emmanuel Ngabe', avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop', lastMessage: 'Monthly analytics report is ready', time: '10:20 AM', status: 'online' },
                { id: 13, name: 'Sr. Juliet Nakabugo', avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400&h=400&fit=crop', lastMessage: 'No-show appointments reduced significantly', time: '1:45 PM', status: 'offline' },
                { id: 14, name: 'Dr. Samuel Okello', avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=400&fit=crop', lastMessage: 'Compliance reports automated successfully', time: '12:30 PM', status: 'online' },
                { id: 15, name: 'Mr. Robert Mukasa', avatar: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=400&fit=crop', lastMessage: 'WhatsApp integration working perfectly', time: '11:00 AM', status: 'offline' }
            ];

            var notifications = [
                { name: '@john mentioned you in "trip to Goa"', avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=200&fit=crop' },
                { name: '@chiya.singh added you in "Group Study"', avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop' },
                { name: '@sudharith removed you from group "Makers"', avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=200&h=200&fit=crop' },
                { name: '@amit mentioned you in public chat', avatar: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=200&h=200&fit=crop' }
            ];

            var suggestions = [
                { name: 'Abhishman Singh', role: '35 Mutual Friends' },
                { name: 'Vad Prakash', role: '21 Mutual Friends' },
                { name: 'Amit Trivedi', role: '18 Mutual Friends' },
                { name: 'Vikash Raj', role: '12 Mutual Friends' }
            ];

            // Load contacts list
            function loadContacts() {
                var html = '';
                contacts.forEach(function(contact) {
                    var statusColor = contact.status === 'online' ? '#10B981' : '#D1D5DB';
                    var statusText = contact.status === 'online' ? 'Online' : 'Offline';
                    html += '<div class="contact-item" data-id="' + contact.id + '" data-contact="' + contact.name + '" data-email="' + (contact.email || '') + '" style="padding: 14px 16px; margin: 6px 10px; cursor: pointer; border-radius: 14px; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); display: flex; gap: 14px; align-items: center; border: 1px solid transparent; background: #FAFAFA;">' +
                        '<div style="position: relative; flex-shrink: 0;">' +
                        '<img src="' + contact.avatar + '" alt="' + contact.name + '" style="width: 52px; height: 52px; border-radius: 50%; object-fit: cover; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">' +
                        '<div style="position: absolute; bottom: 0; right: 0; width: 16px; height: 16px; background: ' + statusColor + '; border: 1px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);"></div>' +
                        '</div>' +
                        '<div style="flex: 1; min-width: 0;">' +
                        '<p style="margin: 0 0 6px 0; font-weight: 700; color: #1F2937; font-size: 14px; letter-spacing: -0.3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + contact.name + '</p>' +
                        '<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">' +
                        '<span style="display: inline-block; width: 6px; height: 6px; background: ' + statusColor + '; border-radius: 50%;"></span>' +
                        '<span style="font-size: 12px; color: #6B7280; font-weight: 500;">' + statusText + '</span>' +
                        '</div>' +
                        '<p style="margin: 0; color: #9CA3AF; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + contact.lastMessage + '</p>' +
                        '</div>' +
                        '<div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px; flex-shrink: 0;">' +
                        '<span style="font-size: 12px; color: #9CA3AF; font-weight: 500;">' + contact.time + '</span>' +
                        '</div>' +
                        '</div>';
                });
                $('#contactsList').html(html);

                $('.contact-item').hover(
                    function() {
                        $(this).css({
                            'background': '#F3F4F6',
                            'border-color': '#E5E7EB',
                            'box-shadow': '0 4px 12px rgba(0, 0, 0, 0.08)',
                            'transform': 'translateX(4px)'
                        });
                    },
                    function() {
                        $(this).css({
                            'background': '#FAFAFA',
                            'border-color': 'transparent',
                            'box-shadow': 'none',
                            'transform': 'translateX(0)'
                        });
                    }
                );

                $('.contact-item').click(function() {
                    var contactId = $(this).data('id');
                    $(this).css('background', '#EFF6FF').css('border-color', '#BFDBFE');
                    selectContact(contactId);
                });
            }

            // Load notifications
            function loadNotifications() {
                var html = '';
                notifications.forEach(function(notif) {
                    html += '<div style="display: flex; gap: 10px; padding: 10px; border-radius: 8px; background: #F8F8F8; cursor: pointer;">' +
                        '<img src="' + notif.avatar + '" alt="' + notif.name + '" style="width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;">' +
                        '<p style="margin: 0; font-size: 12px; color: #1a1a1a; line-height: 1.3;">' + notif.name + '</p>' +
                        '</div>';
                });
                $('#notificationsList').html(html);
            }

            // Load suggestions
            function loadSuggestions() {
                var html = '';
                suggestions.forEach(function(sug) {
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">' +
                        '<div>' +
                        '<p style="margin: 0 0 2px 0; font-size: 13px; font-weight: 600; color: #1a1a1a;">' + sug.name + '</p>' +
                        '<p style="margin: 0; font-size: 11px; color: #999;">' + sug.role + '</p>' +
                        '</div>' +
                        '<button style="background: #734CF4; color: white; border: none; padding: 6px 14px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer;">Add</button>' +
                        '</div>';
                });
                $('#suggestionsList').html(html);
            }

            // Select a contact
            function selectContact(contactId) {
                var contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    currentContact = contact;
                    $('#selectedName').text(contact.name);
                    $('#selectedStatus').text('Last seen ' + contact.time);
                    $('#selectedAvatar').attr('src', contact.avatar);
                    
                    $('#ap').html('<div style="text-align: center; color: #999; font-size: 13px; margin: 20px 0;">Today 12:31 AM</div>');
                    
                    $('.contact-item').css({'background': 'transparent', 'color': '#1a1a1a'});
                    $('.contact-item[data-id="' + contactId + '"]').css({'background': '#F0E8FF'});
                }
            }

            loadContacts();
            loadNotifications();
            loadSuggestions();
            selectContact(1);

            function getCurrentTime() {
                var d = new Date();
                var h = d.getHours();
                var m = d.getMinutes();
                h = h < 10 ? '0' + h : h;
                m = m < 10 ? '0' + m : m;
                return h + ':' + m;
            }

            $("#form").submit(function(e) {
                e.preventDefault();
                $("#msend").click();
            });

            $("#msend").click(function() {
                var msg = $("#val").val().trim();
                if (msg === "") return;

                var time = getCurrentTime();
                var msgHtml = '<div style="display: flex; justify-content: flex-end;">' +
                    '<div style="background: #734CF4; color: white; padding: 12px 16px; border-radius: 18px 18px 4px 18px; max-width: 70%; word-wrap: break-word; font-size: 14px;">' +
                    msg +
                    '</div>' +
                    '</div>';

                $('#ap').append(msgHtml);
                $("#val").val("");
                $('#ap').scrollTop($('#ap')[0].scrollHeight);

                lastmsg = msg.toUpperCase();

                setTimeout(function() {
                    sendResponse();
                }, 1200);
            });

            function sendResponse() {
                var time = getCurrentTime();
                var responses = [
                    "I really like your vibe but i still rock we can do this in...",
                    "Sounds perfect",
                    "Let's discuss something",
                    "I totally agree with you",
                    "Bonjour! "
                ];
                var randomResponse = responses[Math.floor(Math.random() * responses.length)];

                var msgHtml = '<div style="display: flex; justify-content: flex-start;">' +
                    '<div style="background: #F0F0F0; color: #1a1a1a; padding: 12px 16px; border-radius: 18px 18px 18px 4px; max-width: 70%; word-wrap: break-word; font-size: 14px;">' +
                    randomResponse +
                    '</div>' +
                    '</div>';

                $('#ap').append(msgHtml);
                $('#ap').scrollTop($('#ap')[0].scrollHeight);
            }

            window.openChatInterface = function() {
                $("#chatInterface").fadeIn(300);
            }

            window.closeChatInterface = function() {
                $("#chatInterface").fadeOut(300);
            }
        });
    </script>

    <!-- Sidebar Toggle Functions -->
    <script>
        function toggleLeftSidebar() {
            const sidebar = document.getElementById('leftChatSidebar');
            const chatInterface = document.getElementById('chatInterface');
            sidebar.classList.toggle('open');
            chatInterface.classList.toggle('show-sidebar');
        }

        function toggleRightSidebar() {
            const sidebar = document.getElementById('rightChatSidebar');
            const chatInterface = document.getElementById('chatInterface');
            sidebar.classList.toggle('open');
            chatInterface.classList.toggle('show-sidebar');
        }

        // Contact list search functionality
        function setupContactSearch() {
            const searchInput = document.getElementById('contactSearchInput');
            const contactsList = document.getElementById('contactsList');
            
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const contactItems = contactsList.querySelectorAll('[data-contact]');
                    
                    contactItems.forEach(item => {
                        const contactName = item.getAttribute('data-contact').toLowerCase();
                        const contactEmail = (item.getAttribute('data-email') || '').toLowerCase();
                        
                        if (contactName.includes(searchTerm) || contactEmail.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    
                    // Show no results message if all items are hidden
                    const visibleItems = Array.from(contactItems).filter(item => item.style.display !== 'none');
                    if (visibleItems.length === 0 && searchTerm.length > 0) {
                        if (!contactsList.querySelector('.no-results')) {
                            const noResults = document.createElement('div');
                            noResults.className = 'no-results';
                            noResults.style.cssText = 'text-align: center; padding: 20px; color: #999; font-size: 13px;';
                            noResults.textContent = 'No contacts found';
                            contactsList.appendChild(noResults);
                        }
                    } else {
                        const noResults = contactsList.querySelector('.no-results');
                        if (noResults) noResults.remove();
                    }
                });
            }
        }

        // Show/hide toggle buttons based on screen size
        function updateSidebarButtons() {
            const toggleLeftBtn = document.getElementById('toggleLeftBtn');
            const toggleRightBtn = document.getElementById('toggleRightBtn');
            const isMobile = window.innerWidth <= 1024;
            
            if (toggleLeftBtn) toggleLeftBtn.style.display = isMobile ? 'block' : 'none';
            if (toggleRightBtn) toggleRightBtn.style.display = isMobile ? 'block' : 'none';
            
            // Hide sidebars on mobile
            const leftSidebar = document.getElementById('leftChatSidebar');
            const rightSidebar = document.getElementById('rightChatSidebar');
            
            if (isMobile) {
                if (leftSidebar) leftSidebar.style.position = 'fixed';
                if (rightSidebar) rightSidebar.style.position = 'fixed';
            } else {
                if (leftSidebar) leftSidebar.style.position = 'relative';
                if (rightSidebar) rightSidebar.style.position = 'relative';
            }
        }

        // Close sidebars when clicking overlay
        document.addEventListener('DOMContentLoaded', function() {
            const chatInterface = document.getElementById('chatInterface');
            if (chatInterface) {
                chatInterface.addEventListener('click', function(e) {
                    if (e.target === chatInterface && window.innerWidth <= 1024) {
                        document.getElementById('leftChatSidebar').classList.remove('open');
                        document.getElementById('rightChatSidebar').classList.remove('open');
                        chatInterface.classList.remove('show-sidebar');
                    }
                });
            }
            updateSidebarButtons();
            setupContactSearch();
        });

        // Update on window resize
        window.addEventListener('resize', updateSidebarButtons);
    </script>

    <!-- Chat Button Handler -->
    <script>
        $(document).ready(function() {
            var chatBtn = $(".chat-btn");
            if (chatBtn.length > 0) {
                chatBtn.click(function() {
                    openChatInterface();
                });
            }
        });
    </script>
</body>

</html>